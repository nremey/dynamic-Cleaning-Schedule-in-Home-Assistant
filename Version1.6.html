<!DOCTYPE html>
<html lang="de" data-theme="system">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js" defer></script>

    <script>
        window.BASE_PATH = 			"/local/myownstuff/Putzplan/";
        window.PP_FILE_SAVE_DIR = 	'/config/www/myownstuff/Putzplan';
        window.HA_ORIGIN = 			'http://192.168.178.38:8123';
        
        function getHaOrigin(){
          return (window.top && window.top.location && /^https?:/.test(window.top.location.origin))
            ? window.top.location.origin
            : (typeof window.HA_ORIGIN === 'string' ? window.HA_ORIGIN : window.location.origin);
        }
        
        window.PP_USERS_FILE = '/usersettings/'+'users.json';
        if(!window.TABLE_DATA){ window.TABLE_DATA = []; }
        
        async function callWebhook(payload) {
          const webhookUrl = `${getHaOrigin()}/api/webhook/putzplan_textcontentfile_export`;
          const res = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await res.text();
          if (!res.ok) throw new Error(`Webhook ${res.status} â€“ ${text}`);
          return text || 'OK';
        }

        window.__ppExportInProgress = false;
        window.__ppHasUnsavedChanges = false;

        function reloadUpdatedScriptAndRender(){
          if(window.__ppExportInProgress) return;
          if (window.__ppHasUnsavedChanges) {
            doExport('auto-reload');
            return;
          }

          const old = document.getElementById('data-js');
          const fresh = document.createElement('script');
          fresh.id = 'data-js';

          const abs = new URL(window.BASE_PATH + "data.updated.js", getHaOrigin()).toString();
          fresh.src = abs + '?v=' + Date.now();

          fresh.onload = () => { window.ppRender?.(); };
          fresh.onerror = () => { console.debug('data.updated.js konnte nicht geladen werden.'); };

          if (old) old.replaceWith(fresh);
          else document.head.appendChild(fresh);
        }

        function startReloadLoop(){
          reloadUpdatedScriptAndRender();
          setInterval(reloadUpdatedScriptAndRender, 1000*60*15);
          window.addEventListener('focus', reloadUpdatedScriptAndRender);
        }
        if (document.readyState === 'loading') {
          window.addEventListener('DOMContentLoaded', startReloadLoop, { once:true });
        } else {
          startReloadLoop();
        }
    </script>
    <style>
        :root{
              --bg-site: #0b0d10;
              --icon-bg: #0b0d10;
              --taskcard-bg: #12161c;
              --taskcard-bg-2:#171c23;
              --taskcard-textcolor:#e6ebf1;
              --taskcard-textdecent:#aab2bf;
              --taskstatus-overdue:#ef4444;
              --taskstatus-due:#f59e0b;
              --taskstatus-done:#22c55e;
              --accentcolor:#3b82f6;
              --todaycolor:#22d3ee;
              --overdue-notecolor:#fef3c7;
              --card-radius:16px;
              --control-height:42px;
              --shadow:0 6px 30px rgba(0,0,0,.25);
              --border-color:#1f2631;
              --border-color-alt:#2a3341;
              --taskstatus-unknown:#c01c28;
              --taskstatus-notavaiable:#c7b2ff;
        }
        html[data-theme="light"]{
        --bg-site:#f5f7fb;
        --icon-bg:#f5f7fb;
        --taskcard-bg:#ffffff;
        --taskcard-bg-2:#f8fafc;
        --taskcard-textcolor:#0f172a;
        --taskcard-textdecent:#475569;
        --taskstatus-overdue:#ef4444;
        --taskstatus-due:#f59e0b;
        --taskstatus-done:#22c55e;
        --accentcolor:#3b82f6;
        --todaycolor:#0284c7;
        --overdue-notecolor:#fde68a;
        --shadow:0 6px 30px rgba(15,23,42,.08);
        --border-color:#e2e8f0;
        --border-color-alt:#cbd5e1;
        --taskstatus-unknown:#a51d2d;
        --taskstatus-notavaiable:#813d9c;
        }


        @media (prefers-color-scheme: light){
            html[data-theme="system"]{
            --bg-site:#f5f7fb;
            --icon-bg:#f5f7fb;
            --taskcard-bg:#ffffff;
            --taskcard-bg-2:#f8fafc;
            --taskcard-textcolor:#0f172a;
            --taskcard-textdecent:#475569;
            --taskstatus-overdue:#ef4444;
        	--taskstatus-due:#f59e0b;
        	--taskstatus-done:#22c55e;
        	--accentcolor:#3b82f6;
        	--todaycolor:#0284c7;
        	--overdue-notecolor:#fde68a;
        	--shadow:0 6px 30px rgba(15,23,42,.08);
            --border-color:#e2e8f0;
            --border-color-alt:#cbd5e1;
            --taskstatus-unknown:#a51d2d;
        	--taskstatus-notavaiable:#813d9c;
            }
        }

    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg-site);color:var(--taskcard-textcolor)}
    .wrap{max-width:1500px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .user-style-label{margin-top:-6px;margin-bottom:12px;font-size:12px;color:var(--taskcard-textdecent)}
    .sync-status{font-size:12px;color:var(--taskcard-textdecent);margin-left:6px}
    .burger-menu{position:relative}
    .burger-panel{position:fixed;right:16px;left:16px;top:0;background:var(--bg-site);border:1px solid var(--border-color);border-radius:12px;padding:10px;box-shadow:var(--shadow);display:none;gap:8px;min-width:260px;max-width:320px;width:calc(100vw - 32px);margin-left:auto;z-index:50;max-height:calc(100vh - 140px);overflow:auto}
    .burger-panel.open{display:grid}
    .burger-panel .chip{width:100%;justify-content:space-between}
    .burger-panel .btn{width:100%;justify-content:flex-start}
    .burger-panel .chip select{width:100%}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--taskcard-bg);border:1px solid var(--border-color);border-radius:999px;padding:0 12px;display:flex;gap:8px;align-items:center;min-height:var(--control-height);box-sizing:border-box}
    .chip select,.chip input[type="text"]{background:transparent;border:none;outline:none;color:var(--taskcard-textcolor)}
    .chip input::placeholder{color:var(--taskcard-textcolor)}
    #view-select,#range-select,#sort-select{
      color:var(--taskcard-textcolor);
      background:var(--taskcard-bg);
      border:none;
      outline:none;
      font:inherit;
    }
    #view-select option,#range-select option,#sort-select option{
      background:var(--taskcard-bg);
      color:var(--taskcard-textcolor);
    }
    .btn{background:var(--taskcard-bg);border:1px solid var(--border-color);border-radius:999px;padding:0 14px;display:flex;gap:8px;align-items:center;min-height:var(--control-height);box-sizing:border-box;cursor:pointer;font-weight:600;color:var(--taskcard-textcolor);transition:background .2s,color .2s,border-color .2s}
    .btn:hover{background:var(--accentcolor);border-color:var(--accentcolor);color:#fff}
    .area{margin-top:24px;border-top:1px solid var(--border-color)}
    .area-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 4px;position:sticky;top:0;background:var(--bg-site);z-index:5}
    .area-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .area-title{font-size:18px;font-weight:700;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    .badge{font-size:12px;color:var(--taskcard-textdecent);border:1px solid var(--border-color-alt);border-radius:999px;padding:2px 8px}
    .chev{transition:transform .2s ease}
    .collapsed .chev{transform:rotate(-90deg)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .calendar{display:grid;gap:12px;margin-top:16px}
    .calendar-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .calendar-title{font-size:18px;font-weight:700;letter-spacing:.2px}
    .calendar-nav{display:flex;gap:8px;align-items:center}
    .calendar-body{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:10px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;grid-column:2 / span 7}
    .calendar-day{border:1px solid var(--border-color);background:var(--taskcard-bg-2);border-radius:12px;min-height:120px;padding:8px;display:grid;gap:6px;align-content:start}
    .calendar-day.is-outside{opacity:.5}
    .calendar-day.is-today{border-color:var(--todaycolor);box-shadow:0 0 0 2px color-mix(in srgb, var(--todaycolor), transparent 70%) inset}
    .calendar-day-head{display:flex;justify-content:space-between;gap:6px;font-size:12px;color:var(--taskcard-textdecent)}
    .calendar-day-name{font-weight:700;color:var(--taskcard-textcolor);opacity:.8}
    .calendar-item{background:var(--taskcard-bg);border:1px solid var(--border-color);border-radius:10px;padding:4px 6px;display:grid;gap:2px;font-size:11px}
    .calendar-item.imp-red{border-left:4px solid var(--taskstatus-overdue)}
    .calendar-item.imp-yellow{border-left:4px solid var(--taskstatus-due)}
    .calendar-item.imp-green{border-left:4px solid var(--taskstatus-done)}
    .calendar-item.imp-orange{border-left:4px solid orange}
    .calendar-item.imp-purple{border-left:4px solid var(--taskstatus-unknown)}
    .calendar-item-title{font-weight:700}
    .calendar-item-meta{font-size:11px;color:var(--taskcard-textdecent)}
    .calendar-week .calendar-day{min-height:160px}
    .calendar-item-actions{display:flex;gap:6px;align-items:center;margin-top:2px}
    .mini-btn{background:var(--taskcard-bg-2);border:1px solid var(--border-color);border-radius:8px;padding:4px 6px;display:grid;place-items:center;cursor:pointer;color:var(--taskcard-textcolor)}
    .mini-btn:hover{background:var(--accentcolor);border-color:var(--accentcolor);color:#fff}
    .calendar-day.drag-over{outline:2px dashed var(--accentcolor);outline-offset:2px}
    .calendar-overdue{border:1px solid var(--border-color);background:var(--overdue-notecolor);border-radius:16px;padding:10px;display:grid;gap:8px;min-height:100%;grid-column:1}
    .calendar-overdue-title{font-weight:700}
    .calendar-overdue-list{display:grid;gap:6px}
    .calendar-empty{color:var(--taskcard-textdecent);font-size:12px}
    .calendar-list{display:grid;gap:10px}
    .calendar-list-day{border:1px solid var(--border-color);background:var(--taskcard-bg-2);border-radius:12px;padding:10px;display:grid;gap:6px}
    .calendar-list-day.is-today{border-color:var(--todaycolor);box-shadow:0 0 0 2px color-mix(in srgb, var(--todaycolor), transparent 70%) inset}
    .calendar-list-head{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:var(--taskcard-textdecent)}
    .calendar-list-items{display:grid;gap:6px}
    .calendar-list-day.drag-over{outline:2px dashed var(--accentcolor);outline-offset:2px}
    .calendar-list .calendar-overdue{grid-column:auto;min-height:auto}
    .calendar-list .calendar-item{position:relative;display:flex;align-items:flex-start;gap:10px;padding:8px 10px}
    .calendar-list .calendar-item-main{display:grid;gap:2px;min-width:0;flex:1;padding-right:34px}
    .calendar-list .calendar-item .calendar-item-actions{position:absolute;right:8px;top:8px;margin-top:0}
    .calendar-list .calendar-item .mini-btn.edit-btn{border-radius:10px;padding:6px}
    .grid.is-collapsed{display:none}
    .card{background:linear-gradient(180deg,var(--taskcard-bg),var(--taskcard-bg-2));border:1px solid var(--border-color);border-radius:var(--card-radius);box-shadow:var(--shadow);display:flex;flex-direction:column;padding:10px;gap:8px;position:relative;overflow:hidden}
    .card .top{display:flex;gap:10px;align-items:center}
    .icn{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:var(--icon-bg);border:1px solid var(--border-color);cursor:pointer;position:relative}
    .icn:hover{box-shadow:0 0 0 2px var(--accentcolor) inset}
    .icn.pulse{animation:pulse .8s ease}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    .icn iconify-icon{font-size:22px}
    .task{font-weight:700}
    .meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .pill{font-size:12px;color:var(--taskcard-textdecent);border:1px dashed var(--border-color-alt);border-radius:999px;padding:2px 8px}
    .row{display:flex;justify-content:space-between;gap:8px;font-size:13px;color:var(--taskcard-textdecent)}
    .row b{color:var(--taskcard-textcolor)}
    .assignee-pills{display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end}
    .due{font-variant-numeric:tabular-nums}
    .overdue{color:var(--taskstatus-overdue);font-weight:700}
    .due-soon{color:var(--taskstatus-due);font-weight:600}
    .ok{color:var(--taskstatus-done);font-weight:600}
    .accent{position:absolute;left:0;top:0;bottom:0;width:4px}
    .imp-red{background:var(--taskstatus-overdue)}
    .imp-yellow{background:var(--taskstatus-due)}
    .imp-green{background:var(--taskstatus-done)}
    .imp-orange{background:orange}
    .imp-purple{background:var(--taskstatus-unknown)}
    .muted{color:var(--taskcard-textdecent)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog{border:1px solid var(--border-color);border-radius:16px;padding:16px;background:var(--taskcard-bg);color:var(--taskcard-textcolor);box-shadow:var(--shadow)}
    dialog input,dialog select{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--taskcard-bg-2);color:var(--taskcard-textcolor)}
    dialog label{display:grid;gap:6px;font-size:13px;color:var(--taskcard-textdecent)}

    .card .edit-btn{position:absolute;right:10px;top:10px;border:1px solid var(--border-color);background:var(--taskcard-bg-2);border-radius:10px;padding:6px;display:grid;place-items:center;cursor:pointer;opacity:.85;transition:opacity .15s,background .2s,border-color .2s}
    .card .edit-btn:hover{opacity:1;background:var(--accentcolor);border-color:var(--accentcolor);color:#fff}

    .icon-picker-wrap{position:relative;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    .icon-preview{width:36px;height:36px;display:grid;place-items:center;border:1px solid var(--border-color);border-radius:10px;background:var(--taskcard-bg-2)}
    .icon-dd{position:absolute;z-index:50;top:100%;left:0;right:0;margin-top:6px;border:1px solid var(--border-color);border-radius:12px;background:var(--taskcard-bg);box-shadow:var(--shadow);padding:8px;display:none}
    .icon-dd.open{display:block}
    .icon-dd .search{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:8px;background:var(--taskcard-bg-2);color:var(--taskcard-textcolor)}
    .icon-list{margin-top:8px;max-height:260px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px}
    .icon-item{display:flex;gap:8px;align-items:center;padding:8px;border:1px solid var(--border-color);border-radius:10px;background:var(--taskcard-bg-2);cursor:pointer}
    .icon-item:hover{border-color:var(--accentcolor)}
    .icon-name{font-size:12px;color:var(--taskcard-textdecent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .dlg-title{margin:0 0 12px;font-size:18px}
    .dlg-grid{display:grid;gap:10px}
    .dlg-actions-right{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    .dlg-actions-between{display:flex;gap:8px;justify-content:space-between;margin-top:14px}
    .dlg-actions-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .hist-svg{width:100%;height:120px;display:block}
    .hist-empty{color:var(--taskcard-textdecent);font-size:13px}
    .hist-wrap{margin-top:12px;padding-top:10px;border-top:1px solid var(--border-color);display:grid;gap:10px}
    .hist-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .hist-list{margin:0;padding-left:18px;max-height:180px;overflow:auto}

    .rhythm-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}

    .month-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
      margin-top:6px;
      }

      .month-pill{
  border:1px solid var(--border-color);
  background:var(--taskcard-bg-2);
  color:var(--taskcard-textcolor);
  border-radius:999px;
  padding:6px 8px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
  text-align:center;
  opacity:.75;
}
.month-pill.on{
  opacity:1;
  border-color:var(--accentcolor);
  box-shadow:0 0 0 2px rgba(59,130,246,.25) inset;
}
.month-hint{font-size:12px;color:var(--taskcard-textdecent);margin-top:6px}

.week-grid{
  display:grid;
  grid-template-columns:repeat(7, 1fr);
  gap:6px;
  margin-top:6px;
}
.week-pill{
  border:1px solid var(--border-color);
  background:var(--taskcard-bg-2);
  color:var(--taskcard-textcolor);
  border-radius:999px;
  padding:6px 6px;
  font-size:11px;
  cursor:pointer;
  user-select:none;
  text-align:center;
  opacity:.75;
}
.week-pill.on{
  opacity:1;
  border-color:var(--accentcolor);
  box-shadow:0 0 0 2px rgba(59,130,246,.25) inset;
}
.week-hint{font-size:12px;color:var(--taskcard-textdecent);margin-top:6px}

dialog textarea{
  width:100%;
  box-sizing:border-box;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border-color);
  background:var(--taskcard-bg-2);
  color:var(--taskcard-textcolor);
  min-height:110px;
  resize:vertical;
  line-height:1.35;
  font-family:inherit;
}

.note{
  border-top:1px solid var(--border-color);
  padding-top:8px;
  margin-top:6px;
  font-size:13px;
  color:var(--taskcard-textdecent);
  white-space:pre-wrap;
  display:grid;
  gap:6px;
}
.note .line{
  display:flex;
  gap:8px;
  align-items:flex-start;
}
.note iconify-icon{
  font-size:18px;
  margin-top:1px;
  color:var(--taskcard-textcolor);
  opacity:.9;
}


.card.EntityConnector-no-access{
  background: var(--taskstatus-unknown);
  border-color: rgba(180, 120, 255, .35);
}

.card.EntityConnector-bad-state{
  background: var(--taskstatus-notavaiable);
  border-color: rgba(90, 40, 160, .25);
  color: #1a1024;
}

.card.EntityConnector-bad-state .pill,
.card.EntityConnector-bad-state .row,
.card.EntityConnector-bad-state .muted{
  color:#2a1a3a;
}
.card.EntityConnector-bad-state .icn{
  background: rgba(255,255,255,.65);
}
/* ===== Color Editor ===== */
.color-editor-toolbar{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  margin: 6px 0 12px;
}
.color-editor-grid{
  display:grid;
  grid-template-columns: 1fr 180px 180px 80px;
  gap:10px;
  align-items:center;
}
.color-editor-grid .hdr{
  font-size:12px; color:var(--taskcard-textdecent); font-weight:700;
  padding: 6px 0;
  border-bottom: 1px solid var(--border-color);
}
.ce-name{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
  opacity:.95;
}
.ce-color{
  display:flex; gap:8px; align-items:center;
  border:1px solid var(--border-color);
  border-radius:12px;
  padding:6px 10px;
  background: var(--taskcard-bg-2);
}
.ce-color input[type="color"]{
  width:36px; height:30px; border:none; background:transparent; padding:0; cursor:pointer;
}
.ce-color input[type="text"]{
  width:110px;
  border:none; outline:none;
  background:transparent;
  color:var(--taskcard-textcolor);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
}
.ce-swatch{
  width:44px; height:30px;
  border-radius:10px;
  border:1px solid var(--border-color);
  background: transparent;
}
.ce-row{
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,.06);
}
html[data-theme="light"] .ce-row{ border-bottom: 1px solid rgba(15,23,42,.06); }
    .ce-user-label{margin:0 0 8px;font-size:12px;color:var(--taskcard-textdecent)}
    .user-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .user-chip{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border-color);border-radius:999px;background:var(--taskcard-bg-2);color:var(--taskcard-textcolor);font-size:12px}
    .user-chip.active{border-color:var(--todaycolor);box-shadow:0 0 0 2px rgba(34,211,238,.2)}
    .user-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;background:var(--taskcard-bg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--taskcard-textdecent)}
    .user-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .user-mgmt-grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:12px}
    .user-mgmt-grid label{display:grid;gap:6px}
    .user-mgmt-grid input,.user-mgmt-grid textarea{width:100%}
    .user-avatar-preview{display:flex;align-items:center;gap:8px}
    .user-avatar-preview .user-avatar{width:50px;height:50px}
    .user-list{display:grid;gap:8px;margin-top:12px}
    .user-row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--taskcard-bg)}
    .user-row-info{display:flex;gap:10px;align-items:center}
    .user-row-meta{display:grid;gap:2px}
    .user-row-actions{display:flex;gap:8px;align-items:center}
    .user-list-empty{color:var(--taskcard-textdecent);font-size:12px;margin-top:6px}
    .user-tabs{display:flex;gap:8px;margin:0 0 12px}
    .user-tab-btn{padding:6px 10px;border:1px solid var(--border-color);border-radius:10px;background:var(--taskcard-bg-2);color:var(--taskcard-textcolor);font-size:12px}
    .user-tab-btn.active{border-color:var(--todaycolor)}
    .user-panels{flex:1;min-height:0;overflow:hidden}
    .user-tab-panel{display:none;height:100%;overflow:auto;padding-right:2px}
    .user-tab-panel.active{display:block}
    .user-section{border:1px solid var(--border-color);border-radius:12px;background:var(--taskcard-bg-2);padding:12px;margin-bottom:12px}
    .user-section-title{margin:0 0 10px;font-size:13px;font-weight:700;color:var(--taskcard-textdecent)}
    .ce-active-user{pointer-events:none}
    .ce-active-user .user-avatar{width:28px;height:28px;font-size:12px}
    #user-mgmt-dialog{width:min(980px,calc(100vw - 24px));height:min(86vh,760px);padding:0;overflow:hidden}
    #user-mgmt-form{height:100%;display:flex;flex-direction:column;padding:16px;box-sizing:border-box}
    #user-mgmt-form .dlg-actions-between{margin-top:8px;padding-top:10px;border-top:1px solid var(--border-color)}
    .device-list{display:grid;gap:8px;margin-top:12px}
    .device-row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--taskcard-bg)}
    .device-row-meta{display:grid;gap:2px}
    .device-row-actions{display:flex;gap:8px;align-items:center}
    @media (max-width: 720px){
      .user-mgmt-grid{grid-template-columns:1fr}
      #user-mgmt-dialog{width:calc(100vw - 16px);height:min(92vh,860px)}
      #user-mgmt-form{padding:12px}
    }
	</style>
</head>

<body>
<link id="pp-theme-css" rel="stylesheet">


<div class="wrap">
	<header>
		<div class="controls">
			<! top row with settings for language, view, sort, search, dark/light mode,... >
			
			<div class="burger-menu">
				<button id="burger-btn" class="btn" type="button" title="Menu" aria-expanded="false" aria-controls="burger-panel">
					<iconify-icon icon="mdi:menu"></iconify-icon>
					<span>Menu</span>
				</button>
				<div id="burger-panel" class="burger-panel" role="menu">
					<label class="chip" role="menuitem">
						<span id="lbl-language">Sprache:</span>
						<select id="lang-select">
							<option value="en">English</option>
							<option value="de">Deutsch</option>
						</select>
					</label>
					<button id="user-mgmt-btn" class="btn" title="Nutzermanagement" role="menuitem">
						<iconify-icon icon="mdi:account-group"></iconify-icon>
						<span id="user-mgmt-btn-label">Nutzermanagement</span>
					</button>
				</div>
			</div>
			
			<label class="chip">
				<span id="lbl-view">Ansicht:</span>
				<select id="view-select">
					<option value="grouped" id="opt-view-grouped">Nach Bereichen</option>
					<option value="flat" id="opt-view-flat">Alle Aufgaben</option>
					<option value="calendar-week" id="opt-view-week">Kalender (Woche)</option>
					<option value="calendar-month" id="opt-view-month">Kalender (Monat)</option>
					<option value="calendar-list" id="opt-view-list">Kalender (Liste)</option>
				</select>
			</label>
			
			<label class="chip">
				<span id="lbl-range">Zeitraum:</span>
				<select id="range-select"></select>
			</label>
			
			<label class="chip">
				<span id="lbl-sort">Sortierung:</span>
				<select id="sort-select">
					<option value="due" id="opt-sort-due">FÃ¤lligkeit (bald â†’ spÃ¤t)</option>
					<option value="alpha" id="opt-sort-alpha">Alphabetisch (Task)</option>
				</select>
			</label>
			
			<label class="chip" style="min-width:220px">
				<iconify-icon icon="mdi:magnify"></iconify-icon>
				<input id="search-input" type="text" placeholder="Suche in Task/Bereich â€¦" />
			</label>
			
			<button id="theme-btn" class="btn" title="Hell/Dunkel umschalten">
				<iconify-icon id="theme-icn" icon="mdi:weather-night"></iconify-icon>
				<span id="theme-label">Dunkel</span>
			</button>
			
			<button id="add-task-btn" class="btn" title="Neue Aufgabe anlegen">
				<iconify-icon icon="mdi:plus-circle"></iconify-icon>
				<span id="btn-new-task">Neue Aufgabe</span>
			</button>

			<span id="sync-status" class="sync-status" aria-live="polite"></span>
		</div>
		<div id="user-bar" class="user-bar" aria-label="Nutzer"></div>
		
		<!invisible , just there for maintenance - important! do not erase! >
		<button id="export-btn" class="btn sr-only" title="Aktualisierte Tabelle als .js exportieren">
			<iconify-icon icon="mdi:download"></iconify-icon>
			<span>Export (.js)</span>
		</button>
		<button id="ha-test" class="btn sr-only" title="Webhook-Test">Webhook-Test</button>
		
	</header>
	<div id="user-style-label" class="user-style-label"></div>
	<div id="app"></div>
</div>

<script>
	const CONFIG = {
		colorByDue: true,
		ranges: [
			{ key:'overdue', label:{de:'ÃœberfÃ¤llig',       en:'Overdue'},          test: d => Number.isFinite(d) && d < 1 },
        	{ key:'next3',   label:{de:'NÃ¤chste 3 Tage',   en:'Next 3 days'},      test: d => Number.isFinite(d) && d <= 3 },
        	{ key:'next5',   label:{de:'NÃ¤chste 5 Tage',   en:'Next 5 days'},      test: d => Number.isFinite(d) && d <= 5 },
        	{ key:'next7',   label:{de:'NÃ¤chste 7 Tage',   en:'Next 7 days'},      test: d => Number.isFinite(d) && d <= 7 },
        	{ key:'next10',  label:{de:'NÃ¤chste 10 Tage',  en:'Next 10 days'},     test: d => Number.isFinite(d) && d <= 10 },
        	{ key:'next14',  label:{de:'NÃ¤chste 2 Wochen', en:'Next 2 weeks'},     test: d => Number.isFinite(d) && d <= 14 },
        	{ key:'next21',  label:{de:'NÃ¤chste 3 Wochen', en:'Next 3 weeks'},     test: d => Number.isFinite(d) && d <= 21 },
        	{ key:'all',     label:{de:'Alle',            en:'All'},              test: _ => true }
      	]
    };

    async function blobToBase64(blob){
    	const buf = await blob.arrayBuffer();
    	const bytes = new Uint8Array(buf);
    	let binary = '';
    	for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    	return btoa(binary);
    }

    async function downloadFileCompat(blob, filename) {
    	const ua = navigator.userAgent || '';
    	const isHaApp = /homeassistant|home assistant/i.test(ua);
    	try {
    		const content_b64 = await blobToBase64(blob);
    		await callWebhook({ savingpath: window.PP_FILE_SAVE_DIR , filename, content_b64 });
    		return;
    	} catch {}
    	try {
    		const file = new File([blob], filename, { type: blob.type || 'application/octet-stream' });
    		if (navigator.share && (isHaApp || (navigator.canShare && navigator.canShare({ files: [file] })))) {
    			await navigator.share({ files: [file], title: filename });
    			return;
    		}
    	} catch {}
    	if (isHaApp) {
    		try {
    			const text = await blob.text();
    			const mime = blob.type || 'application/octet-stream';
    			const a = document.createElement('a');
    			a.href = `data:${mime};charset=utf-8,` + encodeURIComponent(text);
    			a.download = filename;
    			document.body.appendChild(a);
    			a.click();
    			a.remove();
    			return;
    		} catch {}
    	}
    	const a = document.createElement('a');
    	a.href = URL.createObjectURL(blob);
    	a.download = filename;
    	document.body.appendChild(a);
    	a.click();
    	a.remove();
    	setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    (function(){
    	const app			= document.getElementById('app');
      	const rangeSelect	= document.getElementById('range-select');
      	const sortSelect	= document.getElementById('sort-select');
      	const searchInput	= document.getElementById('search-input');
      	const viewSelect	= document.getElementById('view-select');
      	const langSelect	= document.getElementById('lang-select');
      	const themeBtn		= document.getElementById('theme-btn');
      	const themeIcn		= document.getElementById('theme-icn');
      	const themeLabel	= document.getElementById('theme-label');
      	const exportBtn		= document.getElementById('export-btn');
      	const btnTest     	= document.getElementById('ha-test');

      	const lblLang 		= document.getElementById('lbl-language');
      	const lblView 		= document.getElementById('lbl-view');
      	const lblRange 		= document.getElementById('lbl-range');
      	const lblSort 		= document.getElementById('lbl-sort');
      	const btnNewTaskText = document.getElementById('btn-new-task');
      	const optViewGrouped = document.getElementById('opt-view-grouped');
      	const optViewFlat    = document.getElementById('opt-view-flat');
      	const optViewWeek    = document.getElementById('opt-view-week');
      	const optViewMonth   = document.getElementById('opt-view-month');
      	const optViewList    = document.getElementById('opt-view-list');
     	const optSortDue     = document.getElementById('opt-sort-due');
      	const optSortAlpha   = document.getElementById('opt-sort-alpha');
      const prefsSaveBtn   = document.getElementById('prefs-save-btn');
      const prefsSaveLabel = document.getElementById('prefs-save-label');
      const burgerBtn      = document.getElementById('burger-btn');
      const burgerPanel    = document.getElementById('burger-panel');
      let userBar        = null;
      let userMgmtBtn    = null;
      let userDlg        = null;
      let userForm       = null;
      let userSaveBtn    = null;
      let userSaveLabel  = null;
      let userResetBtn   = null;
      let userCloseBtn   = null;
      let userList       = null;
      let userListEmpty  = null;
      let userNameInput  = null;
      let userRoleInput  = null;
      let userStarsInput = null;
      let userMottoInput = null;
      let userAvatarUrl  = null;
      let userAvatarPrev = null;
      let setUserMgmtTab = null;
      let refreshAliasSelect = null;
      let renderAliasList = null;

      	window.ppRender = window.ppRender || function(){};

      // ===== i18n =====
      const LANG_KEY = 'pp-lang';
      const I18N = {
        de: {
          lang:'Sprache:',
          view:'Ansicht:',
          range:'Zeitraum:',
          sort:'Sortierung:',
          viewGrouped:'Nach Bereichen',
          viewFlat:'Alle Aufgaben',
          viewWeek:'Kalender (Woche)',
          viewMonth:'Kalender (Monat)',
          viewList:'Kalender (Liste)',
          calPrev:'ZurÃ¼ck',
          calToday:'Heute',
          calNext:'Weiter',
          calOverdue:'ÃœberfÃ¤llig',
          sortDue:'FÃ¤lligkeit (bald â†’ spÃ¤t)',
          sortAlpha:'Alphabetisch (Task)',
          searchPh:'Suche in Task/Bereichâ€¦',
          themeDark:'Dunkel',
          themeLight:'Hell',
          themeSystem:'System',
          themeToggleTitle:'Hell/Dunkel umschalten',
          newTask:'Neue Aufgabe',
          newTaskTitle:'Neue Aufgabe anlegen',
          exportTitle:'Aktualisierte Tabelle als .js exportieren',
          webhookTestTitle:'Webhook-Test',
          allTasks:'Alle Aufgaben',
          entries:'EintrÃ¤ge',
          area:'Bereich',
          rhythm:'Rhythmus',
          days:'Tage',
          lastDone:'Letztes Mal',
          nextDue:'DemnÃ¤chst',
          dueIn:'FÃ¤llig in',
          lastDoneBy:'Erledigt von',
          assignees:'ZustÃ¤ndige',
          assigneeAll:'alle',
          today:'heute',
          overdueSuffix:'Ã¼berfÃ¤llig',
          editTitle:'Aufgabe bearbeiten',
          addTitle:'Neue Aufgabe',
          delete:'LÃ¶schen',
          cancel:'Abbrechen',
          save:'Speichern',
          history:'Historie',
          add:'HinzufÃ¼gen',
          clear:'Leeren',
          confirmDelete:'Diese Aufgabe wirklich lÃ¶schen?',
          confirmClearHist:'Historie wirklich leeren?',
          pickDate:'Bitte Datum wÃ¤hlen.',
          noEntries:'â€” keine EintrÃ¤ge â€”',
          addLblArea:'Bereich',
          addLblTask:'Aufgabe',
          addLblRhythm:'Rhythmus',
          addLblIcon:'Icon (mdi:â€¦)',
          addLblLast:'Letztes Mal',
          addLblDue:'NÃ¤chstes FÃ¤lligkeitsdatum (optional)',
          addPhArea:'z. B. KÃ¼che',
          addPhTask:'z. B. ArbeitsflÃ¤che wischen',
          addPhIcon:'z. B. mdi:spray-bottle',
          addHistory:'Historie',
          unitDays:'Tage',
          unitWeeks:'Wochen',
          unitMonths:'Monate',
          addLblRhythmUnit:'Einheit',

          addLblMonths: 'ZulÃ¤ssige Monate',
          monthHint: 'Markiert = erlaubt. Unmarkiert = wenn nÃ¤chstes FÃ¤lligkeitsdatum in diesen Monat fÃ¤llt â†’ auf nÃ¤chsten erlaubten Tag verschieben.',
          addLblWeekdays: 'Feste Wochentage',
          weekdayHint: 'Markiert = erlaubt. Unmarkiert = wenn Datum auf diesen Tag fÃ¤llt â†’ auf nÃ¤chsten erlaubten Tag verschieben.',
          addLblNotes:'Notizen',
          addPhNotes:'z. B. ðŸ§½ Mittel: Essigreiniger\nðŸ“¦ Ersatzbeutel: Schrank links oben',
          
          entity:'HA-Entity',
          entityState:'HA-Entity-Status',
          status:'Status',
          statusDue:'fÃ¤llig',
          statusDone:'erledigt',
          statusPending:'noch nicht wieder fÃ¤llig',
          statusUnknown:'unbekannt',
          entityNoAccess:'kein Zugriff / nicht gefunden',
          entityBadState:'unbrauchbarer State',
          EntityConnectorTitle:'Aufgabenstatus aus Sensorzustand',
          EntityConnectorEnabled:'aktiv benÃ¶tigt fÃ¼r Einstellungen',
          EntityConnectorEntity:'Entity ID',
          EntityConnectorType:'Typ',
          EntityConnectorDue:'Due',
          EntityConnectorVal:'Wert',
          EntityConnectorDone:'Done',
          entityRuleInvalid:'UngÃ¼ltige Regel: Operatoren/Werte mÃ¼ssen zum Typ passen (z. B. Zahl bei "number", Text bei "text").',
          entityRuleOverlap:'Die Due- und Done-Regeln Ã¼berschneiden sich. Bitte so anpassen, dass sie sich nicht gleichzeitig erfÃ¼llen.',
          iconSearchPh:'Icon suchen (z. B. "mdi:toilet" oder "toil")',
          iconListAria:'Iconliste',
          userStyleLabel:'PersÃ¶nliches Theme von:',
          syncRunning:'Sync lÃ¤uftâ€¦',
          syncDone:'Sync fertig',
          syncError:'Sync Fehler',
          prefsSave:'Prefs speichern',
          prefsSaveTitle:'Einstellungen speichern',
          userMgmt:'Nutzermanagement',
          userMgmtTitle:'Nutzermanagement',
          userName:'Anzeigename',
          userRole:'Rolle',
          userStars:'Sterne',
          userMotto:'Motivationsspruch',
          userAvatarUrl:'Avatar URL',
          userAvatarPreview:'Vorschau',
          userSave:'Speichern',
          userUpdate:'Aktualisieren',
          userReset:'Leeren',
          userClose:'SchlieÃŸen',
          userEdit:'Bearbeiten',
          userDelete:'LÃ¶schen',
          adminRequired:'Mindestens ein Nutzer muss die Rolle admin/administrator haben.',
          adminDeleteBlocked:'LÃ¶schen nicht mÃ¶glich: Es muss mindestens ein admin/administrator-Nutzer bleiben.',
          userListEmpty:'â€” keine Nutzer â€”',
          userAliasHa:'HA Nutzer',
          userAliasUser:'Zugeordneter Nutzer',
          userAliasRole:'Rollenfilter (Gruppe)',
          userAliasSave:'Zuordnung speichern',
          userAliasClear:'Zuordnung lÃ¶schen',
          userTabUsers:'Nutzer',
          userTabMapping:'HA Zuordnung',
          userTabColors:'Farben',
          userSectionUserData:'Nutzerdaten',
          userSectionExistingUsers:'Bestehende Nutzer',
          userSectionMappingEdit:'HA Zuordnung bearbeiten',
          userSectionExistingMappings:'Bestehende Zuordnungen',
          userSectionColors:'Farbmanagement',
          userAliasRolePlaceholder:'Familie',
          activeUserPrefix:'Aktiver Nutzer',
          assigneeLabel:'Sichtbar fÃ¼r (Nutzer, Rollen oder Gruppen; leer = alle)',
          assigneePlaceholder:'z. B. Alex, parent, Familie',
        },
        en: {
          lang:'Language:',
          view:'View:',
          range:'Range:',
          sort:'Sort:',
          viewGrouped:'By areas',
          viewFlat:'All tasks',
          viewWeek:'Calendar (week)',
          viewMonth:'Calendar (month)',
          viewList:'Calendar (list)',
          calPrev:'Previous',
          calToday:'Today',
          calNext:'Next',
          calOverdue:'Overdue',
          sortDue:'Due (soon â†’ late)',
          sortAlpha:'Alphabetical (task)',
          searchPh:'Search task/areaâ€¦',
          themeDark:'Dark',
          themeLight:'Light',
          themeSystem:'System',
          themeToggleTitle:'Toggle light/dark',
          newTask:'New task',
          newTaskTitle:'Create new task',
          exportTitle:'Export updated table as .js',
          webhookTestTitle:'Webhook test',
          allTasks:'All tasks',
          entries:'entries',
          area:'Area',
          rhythm:'Rhythm',
          days:'days',
          lastDone:'Last done',
          nextDue:'Next due',
          dueIn:'Due in',
          lastDoneBy:'Last done by',
          assignees:'Assignees',
          assigneeAll:'all',
          today:'today',
          overdueSuffix:'overdue',
          editTitle:'Edit task',
          addTitle:'New task',
          delete:'Delete',
          cancel:'Cancel',
          save:'Save',
          history:'History',
          add:'Add',
          clear:'Clear',
          confirmDelete:'Delete this task?',
          confirmClearHist:'Clear history?',
          pickDate:'Please pick a date.',
          noEntries:'â€” no entries â€”',
          addLblArea:'Area',
          addLblTask:'Task',
          addLblRhythm:'Rhythm',
          addLblIcon:'Icon (mdi:â€¦)',
          addLblLast:'Last done',
          addLblDue:'Next due date (optional)',
          addPhArea:'e.g. Kitchen',
          addPhTask:'e.g. Wipe countertops',
          addPhIcon:'e.g. mdi:spray-bottle',
          addHistory:'History',
          unitDays:'days',
          unitWeeks:'weeks',
          unitMonths:'months',
          addLblRhythmUnit:'Unit',

          addLblMonths: 'Allowed months',
          monthHint: 'Selected = allowed. Unselected = if the next due date falls into this month â†’ shift to the next allowed day.',
          addLblWeekdays: 'Fixed weekdays',
          weekdayHint: 'Selected = allowed. Unselected = if the date falls on this day â†’ shift to the next allowed day.',
          addLblNotes:'Notes',
          addPhNotes:'e.g. ðŸ§½ Cleaner: vinegar\nðŸ“¦ Spare bags: top left cabinet',
          
          entity:'HA-Entity',
          entityState:'HA-Entity state',
          status:'Status',
          statusDue:'due',
          statusDone:'done',
          statusPending:'not due yet',
          statusUnknown:'unknown',
          entityNoAccess:'no access / not found',
          entityBadState:'bad/unusable state',
          EntityConnectorTitle:'Task status from sensor state',
          EntityConnectorEnabled:'enabled needed for settings',
          EntityConnectorEntity:'Entity ID',
          EntityConnectorType:'Type',
          EntityConnectorDue:'Due',
          EntityConnectorVal:'Value',
          EntityConnectorDone:'Done',
          entityRuleInvalid:'Invalid rule: operators/values must match the type (e.g. number for "number", text for "text").',
          entityRuleOverlap:'Due and done rules overlap. Adjust them so they can never be true at the same time.',
          iconSearchPh:'Search icons (e.g. "mdi:toilet" or "toil")',
          iconListAria:'Icon list',
          userStyleLabel:'custom style of:',
          syncRunning:'Sync runningâ€¦',
          syncDone:'Sync done',
          syncError:'Sync failed',
          prefsSave:'Save prefs',
          prefsSaveTitle:'Save preferences',
          userMgmt:'User management',
          userMgmtTitle:'User management',
          userName:'Display name',
          userRole:'Role',
          userStars:'Stars',
          userMotto:'Motivation quote',
          userAvatarUrl:'Avatar URL',
          userAvatarPreview:'Preview',
          userSave:'Save',
          userUpdate:'Update',
          userReset:'Clear',
          userClose:'Close',
          userEdit:'Edit',
          userDelete:'Delete',
          adminRequired:'At least one user must have role admin/administrator.',
          adminDeleteBlocked:'Delete blocked: at least one admin/administrator user must remain.',
          userListEmpty:'â€” no users â€”',
          userAliasHa:'HA user',
          userAliasUser:'Assigned user',
          userAliasRole:'Role filter (group)',
          userAliasSave:'Save mapping',
          userAliasClear:'Clear mapping',
          userTabUsers:'Users',
          userTabMapping:'HA mapping',
          userTabColors:'Colors',
          userSectionUserData:'User data',
          userSectionExistingUsers:'Existing users',
          userSectionMappingEdit:'Edit HA mapping',
          userSectionExistingMappings:'Existing mappings',
          userSectionColors:'Color management',
          userAliasRolePlaceholder:'Family',
          activeUserPrefix:'Active user',
          assigneeLabel:'Visible for (users, roles, or groups; empty = all)',
          assigneePlaceholder:'e.g. Alex, parent, Family',
        }
      };
      
      function detectSystemLang(){
      	const l = (navigator.language || navigator.userLanguage || '').toLowerCase();
      	if (l.startsWith('de')) return 'de';
      	if (l.startsWith('en')) return 'en';
      	return 'en'; // default fallback
      }
      
      let lang = localStorage.getItem(LANG_KEY);
      if (!lang) {
      	lang = detectSystemLang();
      	localStorage.setItem(LANG_KEY, lang);
      }

      function t(key){ return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : key; }
      window.ppT = t;

      function clearTaskCacheOnLoad(){
      	try{
      		localStorage.removeItem('pp-overrides');
      		localStorage.removeItem('pp-added');
      		Object.keys(localStorage).forEach((k)=>{
      			if (k.startsWith('pp-collapse-')) localStorage.removeItem(k);
      		});
      	}catch{}
      }

      // clearTaskCacheOnLoad();

      const syncStatusEl = document.getElementById('sync-status');
      let __syncTimer = null;
      let __syncStatusKey = '';
      function setSyncStatus(msgKey){
      	__syncStatusKey = msgKey || '';
      	if (!syncStatusEl) return;
      	syncStatusEl.textContent = __syncStatusKey ? t(__syncStatusKey) : '';
      	if (__syncTimer) clearTimeout(__syncTimer);
      	if (__syncStatusKey === 'syncDone' || __syncStatusKey === 'syncError') {
      		__syncTimer = setTimeout(()=>{ syncStatusEl.textContent = ''; }, 1500);
      	}
      }

function getCurrentHaUser(){
  const hass = getHass?.();
  const u = hass?.user || hass?.connection?.user || null;
  if (!u) return null;

  // Prefer friendly name; fall back to id only if no name available.
  const name = u.name || u.display_name || null;
  return { id: u.id || null, name };
}

function slugifyFileKey(s){
  return String(s || '')
    .trim()
    .toLowerCase()
    .normalize('NFKD')                 // z.B. Ã¼ -> uÌˆ (kombiniert)
    .replace(/[\u0300-\u036f]/g, '')   // diacritics weg
    .replace(/[^a-z0-9]+/g, '-')       // alles andere -> -
    .replace(/(^-|-$)/g, '')           // trim -
    .slice(0, 48) || 'default';
}






function getUserThemeKey(){
  const active = window.PP_ACTIVE_USER;
  if (active?.name) return slugifyFileKey(active.name);
  const u = getCurrentHaUser();
  return u?.name ? slugifyFileKey(u.name) : (u?.id ? slugifyFileKey(u.id) : 'default');
}




function ensureThemeLink(){
  let link = document.getElementById('pp-theme-css');
  if (!link) {
    link = document.createElement('link');
    link.id = 'pp-theme-css';
    link.rel = 'stylesheet';
    document.head.appendChild(link);
  }
  return link;
}

function loadUserThemeCss(){
  const link = ensureThemeLink();
  const key = getUserThemeKey();
  const filename = `usersettings/theme.${key}.css`;
  const url = new URL(window.BASE_PATH + filename, getHaOrigin()).toString();
  link.href = url + '?v=' + Date.now(); // cache-bust
  return { key, filename, url };
}


      function applyTranslations(){
        if(lblLang)  lblLang.textContent  = t('lang');
        if(lblView)  lblView.textContent  = t('view');
        if(lblRange) lblRange.textContent = t('range');
        if(lblSort)  lblSort.textContent  = t('sort');

        if(optViewGrouped) optViewGrouped.textContent = t('viewGrouped');
        if(optViewFlat)    optViewFlat.textContent    = t('viewFlat');
        if(optViewWeek)    optViewWeek.textContent    = t('viewWeek');
        if(optViewMonth)   optViewMonth.textContent   = t('viewMonth');
        if(optViewList)    optViewList.textContent    = t('viewList');
        if(optSortDue)     optSortDue.textContent     = t('sortDue');
        if(optSortAlpha)   optSortAlpha.textContent   = t('sortAlpha');

        if(searchInput) searchInput.placeholder = t('searchPh');
        if(btnNewTaskText) btnNewTaskText.textContent = t('newTask');
        if(prefsSaveLabel) prefsSaveLabel.textContent = t('prefsSave');
        if(prefsSaveBtn) prefsSaveBtn.title = t('prefsSaveTitle');
        const userMgmtBtnLabel = document.getElementById('user-mgmt-btn-label');
        if(userMgmtBtnLabel) userMgmtBtnLabel.textContent = t('userMgmt');
        if(userMgmtBtn) userMgmtBtn.title = t('userMgmtTitle');
        const userMgmtTitle = document.getElementById('user-mgmt-title');
        if(userMgmtTitle) userMgmtTitle.textContent = t('userMgmtTitle');
        const userNameLabel = document.getElementById('user-name-label');
        if(userNameLabel) userNameLabel.textContent = t('userName');
        const userRoleLabel = document.getElementById('user-role-label');
        if(userRoleLabel) userRoleLabel.textContent = t('userRole');
        const userStarsLabel = document.getElementById('user-stars-label');
        if(userStarsLabel) userStarsLabel.textContent = t('userStars');
        const userMottoLabel = document.getElementById('user-motto-label');
        if(userMottoLabel) userMottoLabel.textContent = t('userMotto');
        const userAvatarUrlLabel = document.getElementById('user-avatar-url-label');
        if(userAvatarUrlLabel) userAvatarUrlLabel.textContent = t('userAvatarUrl');
        const userAvatarPreviewLabel = document.getElementById('user-avatar-preview-label');
        if(userAvatarPreviewLabel) userAvatarPreviewLabel.textContent = t('userAvatarPreview');
        updateUserSaveLabel();
        if(userResetBtn) userResetBtn.textContent = t('userReset');
        if(userCloseBtn) userCloseBtn.textContent = t('userClose');
        if(userListEmpty) userListEmpty.textContent = t('userListEmpty');
        const userAliasHaLabel = document.getElementById('user-alias-ha-label');
        if (userAliasHaLabel) userAliasHaLabel.textContent = t('userAliasHa');
        const userAliasUserLabel = document.getElementById('user-alias-user-label');
        if (userAliasUserLabel) userAliasUserLabel.textContent = t('userAliasUser');
        const userAliasRoleLabel = document.getElementById('user-alias-role-label');
        if (userAliasRoleLabel) userAliasRoleLabel.textContent = t('userAliasRole');
        const userAliasSave = document.getElementById('user-alias-save');
        if (userAliasSave) userAliasSave.textContent = t('userAliasSave');
        const userAliasClear = document.getElementById('user-alias-clear');
        if (userAliasClear) userAliasClear.textContent = t('userAliasClear');
        const userTabUsers = document.getElementById('user-tab-users');
        if (userTabUsers) userTabUsers.textContent = t('userTabUsers');
        const userTabMapping = document.getElementById('user-tab-mapping');
        if (userTabMapping) userTabMapping.textContent = t('userTabMapping');
        const userTabColors = document.getElementById('user-tab-colors');
        if (userTabColors) userTabColors.textContent = t('userTabColors');
        const userSectionUserData = document.getElementById('user-section-user-data');
        if (userSectionUserData) userSectionUserData.textContent = t('userSectionUserData');
        const userSectionExistingUsers = document.getElementById('user-section-existing-users');
        if (userSectionExistingUsers) userSectionExistingUsers.textContent = t('userSectionExistingUsers');
        const userSectionMappingEdit = document.getElementById('user-section-mapping-edit');
        if (userSectionMappingEdit) userSectionMappingEdit.textContent = t('userSectionMappingEdit');
        const userSectionExistingMappings = document.getElementById('user-section-existing-mappings');
        if (userSectionExistingMappings) userSectionExistingMappings.textContent = t('userSectionExistingMappings');
        const userSectionColors = document.getElementById('user-section-colors');
        if (userSectionColors) userSectionColors.textContent = t('userSectionColors');
        const addAssignLbl = document.getElementById('add-lbl-assign');
        if (addAssignLbl) addAssignLbl.textContent = t('assigneeLabel');
        const editAssignLbl = document.getElementById('edit-lbl-assign');
        if (editAssignLbl) editAssignLbl.textContent = t('assigneeLabel');
        const addAssignInput = document.getElementById('add-assign-input');
        if (addAssignInput) addAssignInput.placeholder = t('assigneePlaceholder');
        const editAssignInput = document.getElementById('edit-assign-input');
        if (editAssignInput) editAssignInput.placeholder = t('assigneePlaceholder');
        const userAliasRoleInput = document.getElementById('user-alias-role');
        if (userAliasRoleInput) userAliasRoleInput.placeholder = t('userAliasRolePlaceholder');
        if (typeof window.PP_UPDATE_COLOR_EDITOR_CONTEXT === 'function') window.PP_UPDATE_COLOR_EDITOR_CONTEXT();

        const addTaskBtn = document.getElementById('add-task-btn');
        if(themeBtn) themeBtn.title = t('themeToggleTitle');
        if(addTaskBtn) addTaskBtn.title = t('newTaskTitle');
        if(exportBtn) exportBtn.title = t('exportTitle');
        if(btnTest) btnTest.title = t('webhookTestTitle');
        
        setTheme(themeMode);

        const addDlgTitle = document.querySelector('#add-task-dialog .dlg-title');
        if(addDlgTitle) addDlgTitle.textContent = t('addTitle');

        const editDlgTitle = document.querySelector('#edit-task-dialog .dlg-title');
        if(editDlgTitle) editDlgTitle.textContent = t('editTitle');

        const addCancel = document.getElementById('add-task-cancel');
        if(addCancel) addCancel.textContent = t('cancel');

        const editCancel = document.getElementById('edit-task-cancel');
        if(editCancel) editCancel.textContent = t('cancel');

        const histStrong = document.querySelector('#edit-history-wrap strong');
        if(histStrong) histStrong.textContent = t('history');
        
        const addBtnSave = document.getElementById('add-btn-save');
        if (addBtnSave) addBtnSave.textContent = t('save');

        const addLblArea = document.getElementById('add-lbl-area');
        if (addLblArea) addLblArea.textContent = t('addLblArea');
        
        const addLblTask = document.getElementById('add-lbl-task');
        if (addLblTask) addLblTask.textContent = t('addLblTask');
        
        const addLblRhythm = document.getElementById('add-lbl-rhythm');
        if (addLblRhythm) addLblRhythm.textContent = t('addLblRhythm');
        
        const addLblIcon = document.getElementById('add-lbl-icon');
        if (addLblIcon) addLblIcon.textContent = t('addLblIcon');
        
        const addLblLast = document.getElementById('add-lbl-last');
        if (addLblLast) addLblLast.textContent = t('addLblLast');
        
        const addLblDue  = document.getElementById('add-lbl-due');
        if (addLblDue)  addLblDue.textContent  = t('addLblDue');
        
        const addInpArea = document.getElementById('add-inp-area');
        if (addInpArea) addInpArea.placeholder = t('addPhArea');
        
        const addInpTask = document.getElementById('add-inp-task');
        if (addInpTask) addInpTask.placeholder = t('addPhTask');
        
        const addInpIcon = document.getElementById('add-inp-icon');
        if (addInpIcon) addInpIcon.placeholder = t('addPhIcon');
        
        const addLblRhythmUnit = document.getElementById('add-lbl-rhythm-unit');
        if (addLblRhythmUnit) addLblRhythmUnit.textContent = t('addLblRhythmUnit');
        
        const addLblNotes = document.getElementById('add-lbl-notes');
        if (addLblNotes) addLblNotes.textContent = t('addLblNotes');
        
        const addInpNotes = document.getElementById('add-inp-notes');
        if (addInpNotes) addInpNotes.placeholder = t('addPhNotes');
        
        const editLblNotes = document.getElementById('edit-lbl-notes');
        if (editLblNotes) editLblNotes.textContent = t('addLblNotes');
        
        const addLblMonths = document.getElementById('add-lbl-months');
        if (addLblMonths) addLblMonths.textContent = t('addLblMonths');
        
        const addMonthHint = document.getElementById('add-month-hint');
        if (addMonthHint) addMonthHint.textContent = t('monthHint');

        const addLblWeekdays = document.getElementById('add-lbl-weekdays');
        if (addLblWeekdays) addLblWeekdays.textContent = t('addLblWeekdays');

        const addWeekHint = document.getElementById('add-week-hint');
        if (addWeekHint) addWeekHint.textContent = t('weekdayHint');
        
        const editLblMonths = document.getElementById('edit-lbl-months');
        if (editLblMonths) editLblMonths.textContent = t('addLblMonths');
        
        const editMonthHint = document.getElementById('edit-month-hint');
        if (editMonthHint) editMonthHint.textContent = t('monthHint');

        const editLblWeekdays = document.getElementById('edit-lbl-weekdays');
        if (editLblWeekdays) editLblWeekdays.textContent = t('addLblWeekdays');

        const editWeekHint = document.getElementById('edit-week-hint');
        if (editWeekHint) editWeekHint.textContent = t('weekdayHint');
        
        const unitMap = [
          ['add-unit-d',  'unitDays'],
          ['add-unit-w',  'unitWeeks'],
          ['add-unit-m',  'unitMonths'],
          ['edit-unit-d', 'unitDays'],
          ['edit-unit-w', 'unitWeeks'],
          ['edit-unit-m', 'unitMonths'],
        ];
        
        unitMap.forEach(([id,key])=>{
        const el = document.getElementById(id);
        if (el) el.textContent = t(key);
        });
        
        const addEntityConnectorTitle = document.getElementById('add-EntityConnector-title');
        if (addEntityConnectorTitle) addEntityConnectorTitle.textContent = t('EntityConnectorTitle');

        const addEntityConnectorEntityLbl = document.getElementById('add-EntityConnector-entity-lbl');
        if (addEntityConnectorEntityLbl) addEntityConnectorEntityLbl.textContent = t('EntityConnectorEntity');
        
        const editEntityConnectorTitle = document.getElementById('edit-EntityConnector-title');
        if (editEntityConnectorTitle) editEntityConnectorTitle.textContent = t('EntityConnectorTitle');
        
        const editEntityConnectorEntityLbl = document.getElementById('edit-EntityConnector-entity-lbl');
        if (editEntityConnectorEntityLbl) editEntityConnectorEntityLbl.textContent = t('EntityConnectorEntity');

        const addEntityConnectorEnabledLbl = document.getElementById('add-EntityConnector-enabled-lbl');
        if (addEntityConnectorEnabledLbl) addEntityConnectorEnabledLbl.textContent = t('EntityConnectorEnabled');

        const editEntityConnectorEnabledLbl = document.getElementById('edit-EntityConnector-enabled-lbl');
        if (editEntityConnectorEnabledLbl) editEntityConnectorEnabledLbl.textContent = t('EntityConnectorEnabled');

        const addEntityConnectorTypeLbl = document.getElementById('add-EntityConnector-type-lbl');
        if (addEntityConnectorTypeLbl) addEntityConnectorTypeLbl.textContent = t('EntityConnectorType');

        const editEntityConnectorTypeLbl = document.getElementById('edit-EntityConnector-type-lbl');
        if (editEntityConnectorTypeLbl) editEntityConnectorTypeLbl.textContent = t('EntityConnectorType');

        const addEntityConnectorDueLbl = document.getElementById('add-EntityConnector-due-lbl');
        if (addEntityConnectorDueLbl) addEntityConnectorDueLbl.textContent = t('EntityConnectorDue');

        const editEntityConnectorDueLbl = document.getElementById('edit-EntityConnector-due-lbl');
        if (editEntityConnectorDueLbl) editEntityConnectorDueLbl.textContent = t('EntityConnectorDue');

        const addEntityConnectorDueValLbl = document.getElementById('add-EntityConnector-dueval-lbl');
        if (addEntityConnectorDueValLbl) addEntityConnectorDueValLbl.textContent = t('EntityConnectorVal');

        const editEntityConnectorDueValLbl = document.getElementById('edit-EntityConnector-dueval-lbl');
        if (editEntityConnectorDueValLbl) editEntityConnectorDueValLbl.textContent = t('EntityConnectorVal');

        const addEntityConnectorDoneLbl = document.getElementById('add-EntityConnector-done-lbl');
        if (addEntityConnectorDoneLbl) addEntityConnectorDoneLbl.textContent = t('EntityConnectorDone');

        const editEntityConnectorDoneLbl = document.getElementById('edit-EntityConnector-done-lbl');
        if (editEntityConnectorDoneLbl) editEntityConnectorDoneLbl.textContent = t('EntityConnectorDone');

        const addEntityConnectorDoneValLbl = document.getElementById('add-EntityConnector-doneval-lbl');
        if (addEntityConnectorDoneValLbl) addEntityConnectorDoneValLbl.textContent = t('EntityConnectorVal');

        const editEntityConnectorDoneValLbl = document.getElementById('edit-EntityConnector-doneval-lbl');
        if (editEntityConnectorDoneValLbl) editEntityConnectorDoneValLbl.textContent = t('EntityConnectorVal');
        
        const editDlgTitle2 = document.getElementById('edit-dlg-title');
        if (editDlgTitle2) editDlgTitle2.textContent = t('editTitle');
        
        const editMap = [
          ['edit-lbl-area','addLblArea'],
          ['edit-lbl-task','addLblTask'],
          ['edit-lbl-rhythm','addLblRhythm'],
          ['edit-lbl-icon','addLblIcon'],
          ['edit-lbl-last','addLblLast'],
          ['edit-lbl-due','addLblDue'],
          ['edit-lbl-history','addHistory'],
          ['edit-month-hint', 'monthHint'],
          ['edit-lbl-months', 'addLblMonths'],
          ['edit-btn-hist-add','add'],
          ['edit-btn-hist-clear','clear'],
          ['edit-btn-delete','delete'],
          ['edit-btn-cancel','cancel'],
          ['edit-btn-save','save']
        ];
        
        editMap.forEach(([id,key])=>{
        	const el = document.getElementById(id);
        	if (el) el.textContent = t(key);
        });


		document.querySelectorAll('.icon-dd .search').forEach((el)=>{
          el.placeholder = t('iconSearchPh');
        });
        document.querySelectorAll('.icon-dd .icon-list').forEach((el)=>{
          el.setAttribute('aria-label', t('iconListAria'));
        });

        if (__syncStatusKey) setSyncStatus(__syncStatusKey);

        // Re-render dynamic user/device button labels after language change.
        if (typeof renderUserList === 'function') renderUserList();
        if (typeof renderAliasList === 'function') renderAliasList();

        // Range options neu bauen
        rangeSelect.innerHTML = CONFIG.ranges.map(r => `<option value="${r.key}">${r.label[lang] || r.label.de}</option>`).join('');
        if(!rangeSelect.value) rangeSelect.value = 'all';
        
      }

      const USER_FILE = window.PP_USERS_FILE || '';
      const ACTIVE_USER_KEY = 'pp-active-user';
      const userState = { users: [], deviceAliases: [], editingId: null, activeUserId: null, alias: null, needsAliasSetup: false, editingAliasKey: null };

      function makeUserId(){
      	return 'u_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      }

      function normalizeUser(u){
      	if (!u) return null;
      	const name = String(u.name || '').trim();
      	if (!name) return null;
      	return {
      		id: String(u.id || makeUserId()),
      		name,
      		role: String(u.role || '').trim(),
      		stars: Number(u.stars || 0),
      		motto: String(u.motto || '').trim(),
      		avatar: String(u.avatar || '').trim()
      	};
      }

      function normalizeAlias(a){
      	if (!a) return null;
      	return {
      		haUserId: String(a.haUserId || '').trim(),
      		haUserName: String(a.haUserName || '').trim(),
      		userId: String(a.userId || '').trim(),
      		roleFilter: String(a.roleFilter || '').trim()
      	};
      }

      function getHaKey(){
      	const ha = getCurrentHaUser();
      	if (ha?.id) return `id:${ha.id}`;
      	if (ha?.name) return `name:${ha.name}`;
      	return 'unknown';
      }

      function getActiveUser(){
      	return userState.users.find(u => u.id === userState.activeUserId) || null;
      }

      function getActiveUserName(){
      	const active = getActiveUser();
      	if (active?.name) return active.name;
      	const ha = getCurrentHaUser();
      	return ha?.name || 'Unbekannt';
      }

      function setActiveUserId(id){
      	userState.activeUserId = id || null;
      	const key = `${ACTIVE_USER_KEY}:${getHaKey()}`;
      	if (userState.activeUserId) localStorage.setItem(key, userState.activeUserId);
      	else localStorage.removeItem(key);
      	const active = getActiveUser();
      	window.PP_ACTIVE_USER = active;
      	loadUserThemeCss();
      	if (typeof window.PP_UPDATE_COLOR_EDITOR_CONTEXT === 'function') window.PP_UPDATE_COLOR_EDITOR_CONTEXT();
      	if (typeof render === 'function') render();
      }

      function loadActiveUserId(){
      	const key = `${ACTIVE_USER_KEY}:${getHaKey()}`;
      	return localStorage.getItem(key);
      }

      function parseRoleList(str){
      	return String(str || '')
      		.split(',')
      		.map(s => s.trim())
      		.filter(Boolean);
      }

      function isAdminRoleString(role){
      	const roles = parseRoleList(role).map(r => r.toLowerCase());
      	return roles.includes('admin') || roles.includes('administrator');
      }

      function hasAtLeastOneAdmin(users){
      	return Array.isArray(users) && users.some(u => isAdminRoleString(u?.role));
      }

      function shouldUseHaMapping(){
      	return Array.isArray(userState.users) && userState.users.length > 1;
      }

      function matchesRoleFilter(userRole, filter){
      	const f = String(filter || '').trim().toLowerCase();
      	if (!f) return true;
      	const roles = parseRoleList(userRole).map(r => r.toLowerCase());
      	return roles.includes(f);
      }

      function pickAlias(){
      	const ha = getCurrentHaUser();
      	const haId = ha?.id || '';
      	const haName = ha?.name || '';
      	const list = userState.deviceAliases || [];
      	let alias = null;
      	if (haId) alias = list.find(a => a.haUserId && a.haUserId === haId);
      	if (!alias && haName) alias = list.find(a => a.haUserName && a.haUserName === haName);
      	if (!alias) alias = list.find(a => !a.haUserId && !a.haUserName);
      	return alias || null;
      }

      function getUserInitial(name){
      	const s = String(name || '').trim();
      	return s ? s[0].toUpperCase() : '?';
      }

      function setAvatarPreview(src, name){
      	if (!userAvatarPrev) return;
      	const avatar = userAvatarPrev.querySelector('.user-avatar');
      	if (!avatar) return;
      	avatar.innerHTML = '';
      	if (src) {
      		const img = document.createElement('img');
      		img.src = src;
      		img.alt = '';
      		avatar.appendChild(img);
      	} else {
      		avatar.textContent = getUserInitial(name);
      	}
      }

      function getAvatarValue(){
      	const url = userAvatarUrl?.value?.trim();
      	return url || '';
      }

      function updateUserSaveLabel(){
      	if (!userSaveLabel) return;
      	userSaveLabel.textContent = userState.editingId ? t('userUpdate') : t('userSave');
      }

      function resetUserForm(){
      	userState.editingId = null;
      	if (userNameInput) userNameInput.value = '';
      	if (userRoleInput) userRoleInput.value = '';
      	if (userStarsInput) userStarsInput.value = '0';
      	if (userMottoInput) userMottoInput.value = '';
      	if (userAvatarUrl) userAvatarUrl.value = '';
      	setAvatarPreview('', userNameInput?.value || '');
      	updateUserSaveLabel();
      }

      function fillUserForm(u){
      	if (!u) return;
      	userState.editingId = u.id;
      	if (userNameInput) userNameInput.value = u.name || '';
      	if (userRoleInput) userRoleInput.value = u.role || '';
      	if (userStarsInput) userStarsInput.value = Number(u.stars || 0);
      	if (userMottoInput) userMottoInput.value = u.motto || '';
      	if (userAvatarUrl) userAvatarUrl.value = u.avatar || '';
      	setAvatarPreview(u.avatar || '', u.name);
      	updateUserSaveLabel();
      }

      function renderUserBar(){
      	if (!userBar) return;
      	userBar.innerHTML = '';
      	const alias = shouldUseHaMapping() ? userState.alias : null;
      	const all = userState.users.filter(u => u && u.name);
      	let items = all.slice();
      	if (alias?.roleFilter) {
      		items = items.filter(u => matchesRoleFilter(u.role, alias.roleFilter));
      	} else if (alias?.userId) {
      		items = items.filter(u => u.id === alias.userId);
      	}
      	if (!items.length) items = all;
      	if (!items.length) {
      		userBar.style.display = 'none';
      		return;
      	}
      	userBar.style.display = 'flex';
      	let activeId = userState.activeUserId;
      	if (alias?.userId && items.find(u => u.id === alias.userId)) {
      		activeId = alias.userId;
      	} else if (!activeId || !items.find(u => u.id === activeId)) {
      		activeId = null;
      	}
      	if (items.length === 1) activeId = items[0].id;
      	if (activeId !== userState.activeUserId) setActiveUserId(activeId);
      	for (const u of items) {
      		const btn = document.createElement('button');
      		btn.type = 'button';
      		btn.className = 'user-chip' + (u.id === userState.activeUserId ? ' active' : '');
      		const titleBits = [];
      		if (u.role) titleBits.push(u.role);
      		if (Number.isFinite(u.stars)) titleBits.push(`${u.stars}â˜…`);
      		if (u.motto) titleBits.push(u.motto);
      		if (titleBits.length) btn.title = titleBits.join(' â€¢ ');
      		btn.addEventListener('click', ()=>{
      			setActiveUserId(u.id);
      			renderUserBar();
      		});
      		const avatar = document.createElement('span');
      		avatar.className = 'user-avatar';
      		if (u.avatar) {
      			const img = document.createElement('img');
      			img.src = u.avatar;
      			img.alt = '';
      			avatar.appendChild(img);
      		} else {
      			avatar.textContent = getUserInitial(u.name);
      		}
      		const label = document.createElement('span');
      		label.textContent = u.name;
      		btn.appendChild(avatar);
      		btn.appendChild(label);
      		userBar.appendChild(btn);
      	}
      }

      function renderUserList(){
      	if (!userList) return;
      	userList.innerHTML = '';
      	const items = userState.users;
      	if (!items.length) {
      		if (userListEmpty) userListEmpty.style.display = 'block';
      		return;
      	}
      	if (userListEmpty) userListEmpty.style.display = 'none';
      	for (const u of items) {
      		const row = document.createElement('div');
      		row.className = 'user-row';
      		const info = document.createElement('div');
      		info.className = 'user-row-info';
      		const avatar = document.createElement('span');
      		avatar.className = 'user-avatar';
      		if (u.avatar) {
      			const img = document.createElement('img');
      			img.src = u.avatar;
      			img.alt = '';
      			avatar.appendChild(img);
      		} else {
      			avatar.textContent = getUserInitial(u.name);
      		}
      		const meta = document.createElement('div');
      		meta.className = 'user-row-meta';
      		const name = document.createElement('strong');
      		name.textContent = u.name;
      		const details = document.createElement('span');
      		details.className = 'muted';
      		const parts = [];
      		if (u.role) parts.push(u.role);
      		if (Number.isFinite(u.stars)) parts.push(`${u.stars}â˜…`);
      		if (u.motto) parts.push(u.motto);
      		details.textContent = parts.join(' â€¢ ');
      		meta.appendChild(name);
      		if (details.textContent) meta.appendChild(details);
      		info.appendChild(avatar);
      		info.appendChild(meta);

      		const actions = document.createElement('div');
      		actions.className = 'user-row-actions';
      		const editBtn = document.createElement('button');
      		editBtn.type = 'button';
      		editBtn.className = 'btn';
      		editBtn.textContent = t('userEdit');
      		editBtn.addEventListener('click', ()=> fillUserForm(u));
     		const delBtn = document.createElement('button');
     		delBtn.type = 'button';
     		delBtn.className = 'btn';
     		delBtn.textContent = t('userDelete');
     		delBtn.addEventListener('click', async ()=>{
     			if (!confirm(`${t('userDelete')}?`)) return;
      			const nextUsers = userState.users.filter(x => x.id !== u.id);
      			if (!hasAtLeastOneAdmin(nextUsers)) {
      				alert(t('adminDeleteBlocked'));
      				return;
      			}
      			userState.users = nextUsers;
      			removeUserFromTaskAssignees(u.name);
      			await saveUsersJson();
      			if (typeof refreshAliasSelect === 'function') refreshAliasSelect();
      			renderUserBar();
      			renderUserList();
      			if (typeof renderAliasList === 'function') renderAliasList();
      			refreshAssignLists();
      			if (userState.editingId === u.id) resetUserForm();
      		});
      		actions.appendChild(editBtn);
      		actions.appendChild(delBtn);
      		row.appendChild(info);
      		row.appendChild(actions);
      		userList.appendChild(row);
      	}
      }

      function remapAssigneeList(value, mapToken){
      	const tokens = String(value || '').split(',').map(s => s.trim()).filter(Boolean);
      	if (!tokens.length) return '';
      	const out = [];
      	const seen = new Set();
      	for (const token of tokens) {
      		const mapped = String(mapToken(token) || '').trim();
      		if (!mapped) continue;
      		const key = mapped.toLowerCase();
      		if (seen.has(key)) continue;
      		seen.add(key);
      		out.push(mapped);
      	}
      	return out.join(', ');
      }

      function renameUserInTaskAssignees(oldName, newName){
      	const from = String(oldName || '').trim();
      	const to = String(newName || '').trim();
      	if (!from || !to || from.toLowerCase() === to.toLowerCase()) return;
      	const fromLc = from.toLowerCase();
      	let changed = false;
      	const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
      	const ov = getOverrides();

      	for (const r of rowsAll) {
      		const current = String(r?.Assignee || '').trim();
      		const next = remapAssigneeList(current, token => token.toLowerCase() === fromLc ? to : token);
      		if (next === current) continue;
      		r.Assignee = next;
      		const key = makeId(r);
      		ov[key] = { ...(ov[key] || {}), __uid: r.__uid, Assignee: next };
      		changed = true;
      	}

      	for (const key of Object.keys(ov)) {
      		const patch = ov[key];
      		if (!patch || typeof patch.Assignee !== 'string') continue;
      		const next = remapAssigneeList(patch.Assignee, token => token.toLowerCase() === fromLc ? to : token);
      		if (next === patch.Assignee) continue;
      		patch.Assignee = next;
      		changed = true;
      	}

      	if (!changed) return;
      	setOverrides(ov);
      	render();
      	scheduleExport('user-rename-assignee');
      }

      function removeUserFromTaskAssignees(name){
      	const target = String(name || '').trim();
      	if (!target) return;
      	const targetLc = target.toLowerCase();
      	let changed = false;
      	const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
      	const ov = getOverrides();

      	for (const r of rowsAll) {
      		const current = String(r?.Assignee || '').trim();
      		const next = remapAssigneeList(current, token => token.toLowerCase() === targetLc ? '' : token);
      		if (next === current) continue;
      		r.Assignee = next;
      		const key = makeId(r);
      		ov[key] = { ...(ov[key] || {}), __uid: r.__uid, Assignee: next };
      		changed = true;
      	}

      	for (const key of Object.keys(ov)) {
      		const patch = ov[key];
      		if (!patch || typeof patch.Assignee !== 'string') continue;
      		const next = remapAssigneeList(patch.Assignee, token => token.toLowerCase() === targetLc ? '' : token);
      		if (next === patch.Assignee) continue;
      		patch.Assignee = next;
      		changed = true;
      	}

      	if (!changed) return;
      	setOverrides(ov);
      	render();
      	scheduleExport('user-delete-assignee');
      }

      function refreshAssignLists(){
      	refreshAssignHints();
      }

      function refreshAssignHints(){
      	const list = document.getElementById('assign-hints');
      	if (!list) return;
      	const roles = new Set();
      	for (const u of userState.users) {
      		const rs = String(u.role || '').split(',').map(s => s.trim()).filter(Boolean);
      		rs.forEach(r => roles.add(r));
      	}
      	list.innerHTML = '';
      	const addOpt = (v)=>{
      		const opt = document.createElement('option');
      		opt.value = v;
      		list.appendChild(opt);
      	};
      	userState.users.forEach(u => addOpt(u.name));
      	Array.from(roles).forEach(r => addOpt(r));
      	const groups = new Set((userState.deviceAliases || []).map(a => a.roleFilter).filter(Boolean));
      	Array.from(groups).forEach(g => addOpt(g));
      }

      function formatAssignee(item){
      	const value = String(item?.Assignee || '').trim();
      	return value || t('assigneeAll');
      }

      function matchesAssignee(item){
      	const active = getActiveUser();
      	if (!active) return true;
      	const roles = String(active.role || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
      	if (roles.includes('admin') || roles.includes('administrator')) return true;
      	const value = String(item?.Assignee || '').trim();
      	if (!value) return true;
      	const tokens = value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
      	if (!tokens.length) return true;
      	if (tokens.includes('all') || tokens.includes('alle')) return true;
      	const name = String(active.name || '').toLowerCase();
      	const groups = shouldUseHaMapping()
      		? String(userState.alias?.roleFilter || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
      		: [];
      	return tokens.some(t => t === name || roles.includes(t) || groups.includes(t));
      }

      renderAliasList = function(){
      	const aliasList = document.getElementById('user-alias-list');
      	if (!aliasList) return;
      	aliasList.innerHTML = '';
      	const items = userState.deviceAliases || [];
      	if (!items.length) {
      		const empty = document.createElement('div');
      		empty.className = 'user-list-empty';
      		empty.textContent = t('userListEmpty');
      		aliasList.appendChild(empty);
      		return;
      	}
      	for (const a of items) {
      		const row = document.createElement('div');
      		row.className = 'device-row';
      		const meta = document.createElement('div');
      		meta.className = 'device-row-meta';
      		const user = userState.users.find(u => u.id === a.userId);
      		const nameLine = document.createElement('strong');
      		nameLine.textContent = user?.name || 'â€”';
     		const detail = document.createElement('span');
     		detail.className = 'muted';
     		const parts = [];
     		if (a.haUserName) parts.push(a.haUserName);
     		else if (a.haUserId) parts.push(a.haUserId);
     		if (a.roleFilter) parts.push(`role:${a.roleFilter}`);
     		detail.textContent = parts.join(' â€¢ ');
      		meta.appendChild(nameLine);
      		if (detail.textContent) meta.appendChild(detail);

     		const actions = document.createElement('div');
     		actions.className = 'device-row-actions';
      		const editBtn = document.createElement('button');
      		editBtn.type = 'button';
      		editBtn.className = 'btn';
      		editBtn.textContent = t('userEdit');
      		editBtn.addEventListener('click', ()=>{
      			const aliasHa = document.getElementById('user-alias-ha');
      			const aliasUser = document.getElementById('user-alias-user');
      			const aliasRole = document.getElementById('user-alias-role');
      			if (typeof setUserMgmtTab === 'function') setUserMgmtTab('mapping');
      			if (aliasHa) aliasHa.value = a.haUserName || a.haUserId || '';
      			if (aliasUser) aliasUser.value = a.userId || '';
      			if (aliasRole) aliasRole.value = a.roleFilter || '';
      			userState.editingAliasKey = {
      				haUserId: String(a.haUserId || '').trim(),
      				haUserName: String(a.haUserName || '').trim()
      			};
      		});
     		const delBtn = document.createElement('button');
     		delBtn.type = 'button';
     		delBtn.className = 'btn';
     		delBtn.textContent = t('userDelete');
     		delBtn.addEventListener('click', async ()=>{
      			userState.deviceAliases = (userState.deviceAliases || []).filter(x => x !== a);
      			if (userState.alias === a) userState.alias = null;
      			await saveUsersJson();
     			renderAliasList();
     			renderUserBar();
     		});
      		actions.appendChild(editBtn);
     		actions.appendChild(delBtn);
     		row.appendChild(meta);
     		row.appendChild(actions);
     		aliasList.appendChild(row);
     	}
      };

      async function saveUsersJson(){
      	const payload = JSON.stringify({ users: userState.users, deviceAliases: userState.deviceAliases }, null, 2);
      	const blob = new Blob([payload], { type:'application/json' });
      	await downloadFileCompat(blob, USER_FILE);
      }

      async function loadUsersJson(){
      	try{
      		const url = new URL(window.BASE_PATH + USER_FILE, getHaOrigin()).toString();
      		const res = await fetch(url, { cache:'no-store' });
      		if (!res.ok) return;
      		const data = await res.json();
      		const list = Array.isArray(data) ? data : Array.isArray(data?.users) ? data.users : [];
      		userState.users = list.map(normalizeUser).filter(Boolean);
      		userState.deviceAliases = (data?.deviceAliases || []).map(normalizeAlias).filter(Boolean);
      	} catch {}
      	userState.alias = shouldUseHaMapping() ? pickAlias() : null;
      	userState.needsAliasSetup = shouldUseHaMapping() && !userState.alias;
      	userState.activeUserId = loadActiveUserId();
      	renderUserBar();
      	renderUserList();
      	if (typeof renderAliasList === 'function') renderAliasList();
      	refreshAssignLists();
      	if (typeof render === 'function') render();
      }

      function initUserMgmt(){
      	userBar        = document.getElementById('user-bar');
      	userMgmtBtn    = document.getElementById('user-mgmt-btn');
      	userDlg        = document.getElementById('user-mgmt-dialog');
      	userForm       = document.getElementById('user-mgmt-form');
      	userSaveBtn    = document.getElementById('user-mgmt-save');
      	userSaveLabel  = document.getElementById('user-mgmt-save-label');
      	userResetBtn   = document.getElementById('user-mgmt-reset');
      	userCloseBtn   = document.getElementById('user-mgmt-close');
      	userList       = document.getElementById('user-list');
      	userListEmpty  = document.getElementById('user-list-empty');
      	userNameInput  = document.getElementById('user-name');
      	userRoleInput  = document.getElementById('user-role');
      	userStarsInput = document.getElementById('user-stars');
      	userMottoInput = document.getElementById('user-motto');
      	userAvatarUrl  = document.getElementById('user-avatar-url');
      	userAvatarPrev = document.getElementById('user-avatar-preview');
      	const aliasHa = document.getElementById('user-alias-ha');
      	const aliasUser = document.getElementById('user-alias-user');
      	const aliasRole = document.getElementById('user-alias-role');
      	const aliasSave = document.getElementById('user-alias-save');
     	const aliasClear = document.getElementById('user-alias-clear');
      	const colorEditorBtn = document.getElementById('color-editor-btn');
      	const tabUsers = document.getElementById('user-tab-users');
      	const tabMapping = document.getElementById('user-tab-mapping');
      	const tabColors = document.getElementById('user-tab-colors');
      	const panelUsers = document.getElementById('user-panel-users');
      	const panelMapping = document.getElementById('user-panel-mapping');
      	const panelColors = document.getElementById('user-panel-colors');

      	const haUser = getCurrentHaUser();
      	if (aliasHa && !aliasHa.value.trim()) aliasHa.value = haUser?.name || (haUser?.id || '');

      	setUserMgmtTab = function(tab){
      		const nextTab = (tab === 'mapping' || tab === 'colors') ? tab : 'users';
      		const isUsers = nextTab === 'users';
      		const isMapping = nextTab === 'mapping';
      		const isColors = nextTab === 'colors';
      		if (tabUsers) {
      			tabUsers.classList.toggle('active', isUsers);
      			tabUsers.setAttribute('aria-selected', String(isUsers));
      		}
      		if (tabMapping) {
      			tabMapping.classList.toggle('active', isMapping);
      			tabMapping.setAttribute('aria-selected', String(isMapping));
      		}
      		if (tabColors) {
      			tabColors.classList.toggle('active', isColors);
      			tabColors.setAttribute('aria-selected', String(isColors));
      		}
      		if (panelUsers) panelUsers.classList.toggle('active', isUsers);
      		if (panelMapping) panelMapping.classList.toggle('active', isMapping);
      		if (panelColors) panelColors.classList.toggle('active', isColors);
      	};

      	refreshAliasSelect = function(){
      		if (!aliasUser) return;
      		aliasUser.innerHTML = '';
      		const optNone = document.createElement('option');
      		optNone.value = '';
      		optNone.textContent = 'â€”';
      		aliasUser.appendChild(optNone);
      		for (const u of userState.users) {
      			const opt = document.createElement('option');
      			opt.value = u.id;
      			opt.textContent = u.name;
      			aliasUser.appendChild(opt);
      		}
      		if (userState.alias?.userId) aliasUser.value = userState.alias.userId;
      	};

      	tabUsers?.addEventListener('click', ()=> setUserMgmtTab('users'));
      	tabMapping?.addEventListener('click', ()=> setUserMgmtTab('mapping'));
      	tabColors?.addEventListener('click', ()=> setUserMgmtTab('colors'));
      	colorEditorBtn?.addEventListener('click', ()=>{
      		if (typeof setUserMgmtTab === 'function') setUserMgmtTab('colors');
      		userDlg?.showModal();
      	});

      	userMgmtBtn?.addEventListener('click', ()=>{
      		userDlg?.showModal();
      	});

      	userCloseBtn?.addEventListener('click', ()=>{
      		userDlg?.close();
      	});

      	userResetBtn?.addEventListener('click', resetUserForm);

      	userDlg?.addEventListener('close', resetUserForm);

      	userAvatarUrl?.addEventListener('input', ()=>{
      		setAvatarPreview(userAvatarUrl.value.trim(), userNameInput?.value || '');
      	});

     	userNameInput?.addEventListener('input', ()=>{
     		if (!getAvatarValue()) setAvatarPreview('', userNameInput.value);
     	});

      userSaveBtn?.addEventListener('click', async ()=>{
      	if (!userForm?.reportValidity()) return;
      	const prevUser = userState.editingId
      		? userState.users.find(u => u.id === userState.editingId)
      		: null;
      	const prevName = String(prevUser?.name || '').trim();
      	const next = normalizeUser({
      		id: userState.editingId || makeUserId(),
      		name: userNameInput?.value,
      		role: userRoleInput?.value,
      		stars: userStarsInput?.value,
      		motto: userMottoInput?.value,
      		avatar: getAvatarValue()
      	});
      	if (!next) return;
      	let nextUsers = userState.users.slice();
      	if (userState.editingId) {
      		const idx = nextUsers.findIndex(u => u.id === userState.editingId);
      		if (idx >= 0) nextUsers[idx] = next;
      		else nextUsers.push(next);
      	} else {
      		nextUsers.push(next);
      	}
      	if (!hasAtLeastOneAdmin(nextUsers)) {
      		alert(t('adminRequired'));
      		return;
      	}
      	userState.users = nextUsers;
      	if (userState.editingId && prevName) {
      		renameUserInTaskAssignees(prevName, next.name);
      	}
      	await saveUsersJson();
      	refreshAliasSelect();
      	renderUserBar();
      	renderUserList();
      	if (typeof renderAliasList === 'function') renderAliasList();
      	refreshAssignLists();
      	resetUserForm();
      });

      aliasSave?.addEventListener('click', async ()=>{
      	if (!shouldUseHaMapping()) return;
      	const haValue = String(aliasHa?.value || '').trim();
      	if (!haValue) {
      		alert(`${t('userAliasHa')} required`);
      		return;
      	}
      	const entry = normalizeAlias({
      		haUserId: '',
      		haUserName: haValue,
      		userId: aliasUser?.value || '',
      		roleFilter: aliasRole?.value || ''
      	});
      	if (!entry) return;
      	const prev = userState.editingAliasKey;
      	userState.deviceAliases = (userState.deviceAliases || []).filter(a => !(
      		(prev && ((prev.haUserName && a.haUserName === prev.haUserName) || (prev.haUserId && a.haUserId === prev.haUserId))) ||
      		((entry.haUserName && a.haUserName === entry.haUserName) || (entry.haUserId && a.haUserId === entry.haUserId))
      	));
      	userState.deviceAliases.push(entry);
      	userState.alias = entry;
      	userState.editingAliasKey = {
      		haUserId: String(entry.haUserId || '').trim(),
      		haUserName: String(entry.haUserName || '').trim()
      	};
      	await saveUsersJson();
      	renderUserBar();
      	if (typeof renderAliasList === 'function') renderAliasList();
      });

      aliasClear?.addEventListener('click', async ()=>{
      	if (!shouldUseHaMapping()) return;
      	const haValue = String(aliasHa?.value || '').trim();
      	const prev = userState.editingAliasKey;
      	userState.deviceAliases = (userState.deviceAliases || []).filter(a => !(
      		(prev && ((prev.haUserName && a.haUserName === prev.haUserName) || (prev.haUserId && a.haUserId === prev.haUserId))) ||
      		(haValue && (a.haUserName === haValue || a.haUserId === haValue)) ||
      		((haUser?.name && a.haUserName === haUser.name) || (haUser?.id && a.haUserId === haUser.id))
      	));
      	userState.alias = null;
      	userState.editingAliasKey = null;
      	if (aliasUser) aliasUser.value = '';
      	if (aliasRole) aliasRole.value = '';
      	if (aliasHa) aliasHa.value = haUser?.name || (haUser?.id || '');
      	await saveUsersJson();
      	renderUserBar();
      	if (typeof renderAliasList === 'function') renderAliasList();
      });

      loadUsersJson().finally(()=>{
      	refreshAliasSelect();
      	if (aliasRole && !aliasRole.value) aliasRole.value = t('userAliasRolePlaceholder');
      	if (userState.alias?.roleFilter && aliasRole) aliasRole.value = userState.alias.roleFilter;
      	if (userState.alias?.userId && aliasUser) aliasUser.value = userState.alias.userId;
      	if (userState.alias) {
      		userState.editingAliasKey = {
      			haUserId: String(userState.alias.haUserId || '').trim(),
      			haUserName: String(userState.alias.haUserName || '').trim()
      		};
      	}
      	if (userState.needsAliasSetup) {
      		if (typeof setUserMgmtTab === 'function') setUserMgmtTab('mapping');
      		userDlg?.showModal();
      	} else {
      		if (typeof setUserMgmtTab === 'function') setUserMgmtTab('users');
      	}
      });

      applyTranslations();
      }

      langSelect.value = lang;
      langSelect.addEventListener('change', ()=>{
        lang = langSelect.value;
        localStorage.setItem(LANG_KEY, lang);
        applyTranslations();
        render();
      });

      // ===== Utils =====
      const addDays    = (d, n)=>{ const x = new Date(d); x.setDate(x.getDate()+Number(n||0)); return x; };
      const today      = ()=>{ const tt=new Date(); return new Date(tt.getFullYear(), tt.getMonth(), tt.getDate()); };
      const diffInDays = (a,b)=> Math.round((a - b) / 86400000);
      const fmtDate    = (str) => { const d = parseDate(str); if(!d) return 'â€”'; return new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US',{ year:'numeric', month:'2-digit', day:'2-digit'}).format(d); };
      const cssId      = (s)=> String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const escapeHtml = (str)=> String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#39;");

      const VIEW_KEY = 'pp-view-mode';
      viewSelect.value = localStorage.getItem(VIEW_KEY) || 'grouped';
      viewSelect.addEventListener('change', () => {
        localStorage.setItem(VIEW_KEY, viewSelect.value);
        render();
      });
      
      

      const UI_KEY = 'pp-ui-state';
      
      function loadUiState(){
      	try { return JSON.parse(localStorage.getItem(UI_KEY) || '{}'); }
      	catch { return {}; }
      }
      
      function saveUiState(patch){
      	const cur = loadUiState();
      	localStorage.setItem(UI_KEY, JSON.stringify({ ...cur, ...patch }));
      }
      
      const ui = loadUiState();
      
      // beim Start wiederherstellen
      if (ui.range)  rangeSelect.value = ui.range;
      if (ui.sort)   sortSelect.value  = ui.sort;
      if (typeof ui.q === 'string') searchInput.value = ui.q;
      
      // Ã„nderungen speichern
      rangeSelect.addEventListener('change', ()=> saveUiState({ range: rangeSelect.value }));
      sortSelect.addEventListener('change',  ()=> saveUiState({ sort: sortSelect.value }));
      searchInput.addEventListener('input',  ()=> saveUiState({ q: searchInput.value }));

      // Theme
      const THEME_KEY = 'pp-theme';
      
      function setTheme(mode) {
        document.documentElement.setAttribute('data-theme', mode);
        if (mode === 'dark')      { themeIcn.setAttribute('icon', 'mdi:weather-night');       themeLabel.textContent = t('themeDark'); }
        else if (mode === 'light'){ themeIcn.setAttribute('icon', 'mdi:white-balance-sunny'); themeLabel.textContent = t('themeLight'); }
        else                      { themeIcn.setAttribute('icon', 'mdi:monitor');             themeLabel.textContent = t('themeSystem'); }
      }
      
      function nextMode(curr) {
      	return curr === 'dark' ? 'light' : curr === 'light' ? 'system' : 'dark';
      }

      let themeMode = localStorage.getItem(THEME_KEY) || 'system';
      setTheme(themeMode);

      function setBurgerOpen(next){
      	if (!burgerBtn || !burgerPanel) return;
      	burgerPanel.classList.toggle('open', next);
      	burgerBtn.setAttribute('aria-expanded', String(next));
      	if (next) {
      		requestAnimationFrame(()=>{
      			const rect = burgerBtn.getBoundingClientRect();
      			const desiredTop = rect.bottom + 6;
      			const panelH = burgerPanel.offsetHeight || 0;
      			const maxTop = Math.max(16, window.innerHeight - panelH - 16);
      			const top = Math.min(desiredTop, maxTop);
      			burgerPanel.style.top = `${top}px`;
      		});
      	}
      }

      burgerBtn?.addEventListener('click', ()=>{
      	const isOpen = burgerPanel?.classList.contains('open');
      	setBurgerOpen(!isOpen);
      });

      document.addEventListener('click', (e)=>{
      	if (!burgerPanel || !burgerBtn) return;
      	if (burgerPanel.contains(e.target) || burgerBtn.contains(e.target)) return;
      	setBurgerOpen(false);
      });

      window.addEventListener('resize', ()=>{
      	if (burgerPanel?.classList.contains('open')) setBurgerOpen(true);
      });
      
      themeBtn.addEventListener('click', () => {
        themeMode = nextMode(themeMode);
        localStorage.setItem(THEME_KEY, themeMode);
        setTheme(themeMode);
      });
      
      const mql = window.matchMedia('(prefers-color-scheme: light)');
      mql.addEventListener?.('change', () => { if (themeMode === 'system') setTheme('system'); });

      async function loadUserPrefs(){
      	const key = getUserThemeKey();
      	const url = new URL(window.BASE_PATH + 'usersettings/'+ `prefs.${key}.json`, getHaOrigin()).toString();
      	try{
      		const res = await fetch(url, { cache:'no-store' });
      		if (!res.ok) return;
      		const prefs = await res.json();
      		if (!prefs || typeof prefs !== 'object') return;
      		if (prefs.lang && I18N[prefs.lang]) {
      			lang = prefs.lang;
      			localStorage.setItem(LANG_KEY, lang);
      			if (langSelect) langSelect.value = lang;
      		}
      		if (prefs.view) {
      			localStorage.setItem(VIEW_KEY, prefs.view);
      			if (viewSelect) viewSelect.value = prefs.view;
      		}
      		if (prefs.range && CONFIG.ranges.some(r => r.key === prefs.range)) {
      			saveUiState({ range: prefs.range });
      			if (rangeSelect) rangeSelect.value = prefs.range;
      		}
      		if (prefs.sort) {
      			saveUiState({ sort: prefs.sort });
      			if (sortSelect) sortSelect.value = prefs.sort;
      		}
      		if (prefs.theme === 'dark' || prefs.theme === 'light') {
      			themeMode = prefs.theme;
      			localStorage.setItem(THEME_KEY, themeMode);
      			setTheme(themeMode);
      		}
      	}catch{}
      }

      prefsSaveBtn?.addEventListener('click', async ()=>{
      	const key = getUserThemeKey();
      	const prefs = {
      		lang,
      		view: viewSelect?.value || 'grouped',
      		range: rangeSelect?.value || 'all',
      		sort: sortSelect?.value || 'due',
      		theme: (themeMode === 'dark' || themeMode === 'light') ? themeMode : 'light'
      	};
      	const blob = new Blob([JSON.stringify(prefs, null, 2)], { type: 'application/json' });
      	await downloadFileCompat(blob, `usersettings/prefs.${key}.json`);
      });

      // Overrides
      const STORAGE_KEY = 'pp-overrides';
      const getOverrides = ()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch{ return {}; } };
      const setOverrides = (obj)=> localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));

      const makeId = (r)=> [r.Area, r.Task].map(v=>String(v||'').toLowerCase().replace(/[^a-z0-9]+/g,'-')).join('__');

      // UID + History
      let __uidSeed = Date.now();
      const uid = () => (__uidSeed++).toString(36);
      
      function daysInMonth(y, m){
      	return new Date(y, m + 1, 0).getDate();
      }
      
      function addMonthsClamped(d, months){
      	const x = new Date(d);
      	const day = x.getDate();
      	const y = x.getFullYear();
      	const m = x.getMonth();
      	const target = new Date(y, m + Number(months || 0), 1);
      	const dim = daysInMonth(target.getFullYear(), target.getMonth());
      	target.setDate(Math.min(day, dim));
      	target.setHours(0,0,0,0);
      	return target;
      }
      
      function normalizeUnit(u){
      	u = String(u || '').toLowerCase();
      	if (u === 'w' || u === 'week' || u === 'weeks') return 'w';
      	if (u === 'm' || u === 'month' || u === 'months') return 'm';
      	return 'd';
      }
      
      function rhythmUnitLabel(unit){
      	unit = normalizeUnit(unit);
      	if (unit === 'w') return t('unitWeeks');
      	if (unit === 'm') return t('unitMonths');
      	return t('unitDays');
      }
      
      function addByRhythm(date, amount, unit){
      	unit = normalizeUnit(unit);
      	const n = Number(amount || 0);
      	if (unit === 'm') return addMonthsClamped(date, n);
      	if (unit === 'w') return addDays(date, n * 7);
      	return addDays(date, n);
      }
      
      // effektive Rhythmusdauer in Tagen (fÃ¼r Ampelfarbe/Ratio, Historie-Skala etc.)
      function getRhythmDaysEffective(amount, unit, refDate /* Date oder null */){
      	unit = normalizeUnit(unit);
      	const n = Number(amount || 0);
      	if (unit === 'm' && refDate instanceof Date){
      		const next = addMonthsClamped(refDate, n);
      		return Math.max(1, diffInDays(next, refDate));
      	}
      	if (unit === 'w') return Math.max(1, n * 7);
      	return Math.max(1, n);
      }
      
      const MONTH_MASK_ALL = (1 << 12) - 1; // 4095
      const WEEK_MASK_ALL = (1 << 7) - 1; // 127
      
      function normalizeMonthMask(v){
      	const n = Number(v);
      	if (!Number.isFinite(n)) return MONTH_MASK_ALL;
      	const m = n | 0;
      	// wenn jemand "alles aus" klickt, behandeln wir es als "alles erlaubt" (sonst unendlich)
      	return (m & MONTH_MASK_ALL) ? (m & MONTH_MASK_ALL) : MONTH_MASK_ALL;
      }

      function normalizeWeekMask(v){
      	const n = Number(v);
      	if (!Number.isFinite(n)) return WEEK_MASK_ALL;
      	const m = n | 0;
      	return (m & WEEK_MASK_ALL) ? (m & WEEK_MASK_ALL) : WEEK_MASK_ALL;
      }
      
      function isMonthAllowed(mask, monthIndex0){
      	mask = normalizeMonthMask(mask);
      	return ((mask >> monthIndex0) & 1) === 1;
      }

      function isWeekdayAllowed(mask, weekdayIndexMon0){
      	mask = normalizeWeekMask(mask);
      	return ((mask >> weekdayIndexMon0) & 1) === 1;
      }
      
      /* Schiebt auf den *nÃ¤chsten zulÃ¤ssigen Tag:
      Wenn Monat gesperrt: springe auf den 1. des nÃ¤chsten Monats (00:00) und prÃ¼fe erneut.
      Das kann mehrere Monate Ã¼berspringen. */
      function shiftToAllowedMonth(d, mask){
      	mask = normalizeMonthMask(mask);
      	let x = new Date(d);
      	x.setHours(0,0,0,0);
      	
      	let guard = 0;
      	while (!isMonthAllowed(mask, x.getMonth())) {
      		x = new Date(x.getFullYear(), x.getMonth() + 1, 1);
      		x.setHours(0,0,0,0);
      		if (++guard > 24) break;
      	}
      	return x;
      }

      function weekdayIndexMon0(d){
      	const day = d.getDay();
      	return day === 0 ? 6 : day - 1;
      }

      function shiftToAllowedWeekday(d, mask){
      	mask = normalizeWeekMask(mask);
      	let x = new Date(d);
      	x.setHours(0,0,0,0);
      	let guard = 0;
      	while (!isWeekdayAllowed(mask, weekdayIndexMon0(x))) {
      		x = addDays(x, 1);
      		if (++guard > 14) break;
      	}
      	return x;
      }

      function shiftToAllowedDate(d, monthMask, weekMask){
      	let x = new Date(d);
      	x.setHours(0,0,0,0);
      	let guard = 0;
      	while (guard++ < 62) {
      		if (!isMonthAllowed(monthMask, x.getMonth())) {
      			x = shiftToAllowedMonth(x, monthMask);
      			continue;
      		}
      		if (!isWeekdayAllowed(weekMask, weekdayIndexMon0(x))) {
      			x = shiftToAllowedWeekday(x, weekMask);
      			continue;
      		}
      		break;
      	}
      	return x;
      }
      
      function monthLabels(){
      	// kurze Monatsnamen in aktueller Sprache
      	const fmt = new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { month:'short' });
      	const out = [];
      	for(let i=0;i<12;i++){
      		out.push(fmt.format(new Date(2020, i, 1)).replace('.', ''));
      	}
      	return out;
      }

      function weekLabels(){
      	const fmt = new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { weekday:'short' });
      	const base = new Date(2020, 0, 6); // Monday
      	const out = [];
      	for (let i=0;i<7;i++){
      		out.push(fmt.format(addDays(base, i)).replace('.', ''));
      	}
      	return out;
      }
      
      function renderMonthGrid(gridEl, hiddenInputEl, initialMask){
  		if (!gridEl || !hiddenInputEl) return;

  		let mask = normalizeMonthMask(initialMask);
  		hiddenInputEl.value = String(mask);
  		const labels = monthLabels();
  		gridEl.innerHTML = '';
  		for(let i=0;i<12;i++){
    		const btn = document.createElement('button');
    		btn.type = 'button';
    		btn.className = 'month-pill' + (isMonthAllowed(mask, i) ? ' on' : '');
    		btn.textContent = labels[i];
    		btn.addEventListener('click', ()=>{
      			const bit = 1 << i;
      			mask = normalizeMonthMask((mask ^ bit));
      			hiddenInputEl.value = String(mask);
      			btn.classList.toggle('on', isMonthAllowed(mask, i));
      			if (mask === MONTH_MASK_ALL) {
        			[...gridEl.querySelectorAll('.month-pill')].forEach((p, idx)=>{
          				p.classList.toggle('on', true);
        			});
      			}
      		});
      		gridEl.appendChild(btn);
      	}
      }

      function renderWeekGrid(gridEl, hiddenInputEl, initialMask){
      	if (!gridEl || !hiddenInputEl) return;

      	let mask = normalizeWeekMask(initialMask);
      	hiddenInputEl.value = String(mask);
      	const labels = weekLabels();
      	gridEl.innerHTML = '';
      	for (let i=0;i<7;i++){
      		const btn = document.createElement('button');
      		btn.type = 'button';
      		btn.className = 'week-pill' + (isWeekdayAllowed(mask, i) ? ' on' : '');
      		btn.textContent = labels[i];
      		btn.addEventListener('click', ()=>{
      			const bit = 1 << i;
      			mask = normalizeWeekMask((mask ^ bit));
      			hiddenInputEl.value = String(mask);
      			btn.classList.toggle('on', isWeekdayAllowed(mask, i));
      			if (mask === WEEK_MASK_ALL) {
      				[...gridEl.querySelectorAll('.week-pill')].forEach((p)=>{
      					p.classList.toggle('on', true);
      				});
      			}
      		});
      		gridEl.appendChild(btn);
      	}
      }
  	
  	
    function ensureUids(){
    	if (!Array.isArray(window.TABLE_DATA)) return;
    	for (const r of window.TABLE_DATA) {
			if (!r.__uid) r.__uid = uid();
			if (typeof r.Notes !== 'string') r.Notes = '';
			if (!r.Assignee) r.Assignee = '';
			if (!Array.isArray(r.__history)) {
				const init = (r['Last done [Date]'] && String(r['Last done [Date]']).trim())
				? [r['Last done [Date]']]
				: [];
				r.__history = init;
			}
			if (!Array.isArray(r.__history_doneby)) {
				const d = String(r['Last done [Date]'] || '').trim();
				const u = String(r['Last done [By]'] || '').trim();
				r.__history_doneby = (d && u) ? [{ date: d, user: u }] : [];
			}
		}
	}
  
  

	function recompute(item){
		const last   = parseDate(item['Last done [Date]']);
		let manual   = item['New Due date [date]'] ? parseDate(item['New Due date [date]']) : null;
		const unit   = normalizeUnit(item.RhythmUnit);
		const amount = Number(item.Rhythmen || 0);
		const mm     = normalizeMonthMask(item.MonthMask);
		const wm     = normalizeWeekMask(item.WeekMask);
		if (manual && manual < today()) manual = null;
		let nextDue = null;
		const manualOk = manual && (!last || manual >= last);
		
		if (manualOk) {
			nextDue = manual;
		} else if (last && Number.isFinite(amount) && amount > 0) {
			nextDue = addByRhythm(last, amount, unit);
		} else if (manual) { nextDue = manual;
		}
		if (last && nextDue && nextDue < last) {
			nextDue = (Number.isFinite(amount) && amount > 0)
			? addByRhythm(last, amount, unit)
			: new Date(last);
		}
		
		if (nextDue) nextDue = shiftToAllowedDate(nextDue, mm, wm);
		if (last && nextDue && nextDue < last) {
			nextDue = shiftToAllowedDate((Number.isFinite(amount) && amount > 0) ? addByRhythm(last, amount, unit) : new Date(last), mm, wm );
		}
		
		item['New Due date [date]'] = nextDue ? toISO(nextDue) : '';
		const now = today();
		const dueIn = nextDue ? diffInDays(nextDue, now) : null;
		item['Due in [days]'] = Number.isFinite(dueIn) ? dueIn : null;
		return item;
	}
	
	function toISO(d){
		if(!d) return '';
		const y = d.getFullYear();
		const m = String(d.getMonth()+1).padStart(2,'0');
		const day = String(d.getDate()).padStart(2,'0');
		return `${y}-${m}-${day}`;
	}
	
	function parseDate(str){
		if(!str) return null;
		const [y,m,d] = String(str).split('-').map(Number);
		if(!y || !m || !d) return null;
		const dt = new Date(y, m-1, d);
		dt.setHours(0,0,0,0);
		return dt;
	}

      function applyOverrides(rows){
      	const ov = getOverrides();
      	rows.forEach(r=>{
      		const key = makeId(r);
      		const patch = ov[key] || null;
      		if(patch) Object.assign(r, patch);
      		if (!Array.isArray(r.__history)) r.__history = [];
      		if (!Array.isArray(r.__history_doneby)) r.__history_doneby = [];
      		if (typeof r.Notes !== 'string') r.Notes = '';
      		if (typeof r.Assignee !== 'string') r.Assignee = '';
      		recompute(r);
		});
		return rows;
	}
	
	// Collapse state
    const COLLAPSE_PREFIX = 'pp-collapse-';
    const getCollapsed = area => localStorage.getItem(COLLAPSE_PREFIX+area) === '1';
    const setCollapsed = (area, v) => localStorage.setItem(COLLAPSE_PREFIX+area, v?'1':'0');
    
    function groupByArea(rows){
    	const map = new Map();
    	rows.forEach(r=>{ const area = r.Area || 'Ohne Bereich'; if(!map.has(area)) map.set(area, []); map.get(area).push(r); });
    	return map;
    }
    
    function importanceClass(importance){
    	const v = String(importance||'').toLowerCase();
    	if(v.includes('red')) return 'imp-red';
    	if(v.includes('yellow')) return 'imp-yellow';
    	if(v.includes('green')) return 'imp-green';
    	return '';
    }
    
    function dueClass(dueDays){
    	if(dueDays == null || isNaN(dueDays)) return '';
    	if(dueDays < 0) return 'overdue';
    	if(dueDays <= 7) return 'due-soon';
    	return 'ok';
    }
    
    function accentClassFromDue(dueDays, rhythm) {
    	if (!Number.isFinite(dueDays) || !Number.isFinite(rhythm) || rhythm <= 0) return '';
    	if (dueDays < 0) return 'imp-red';
    	const ratio = dueDays / rhythm;
    	if (ratio >= 0.6) return 'imp-green';
    	if (ratio > 0.2)  return 'imp-yellow';
    	return 'imp-orange';
    }
    
    function uniqPreserveOrder(arr){
    	const seen = new Set();
    	const out = [];
    	for(const v of arr){ if(!v) continue; if(!seen.has(v)){ seen.add(v); out.push(v); } }
    	return out;
    }
    
    function sortIsoAsc(arr){return [...arr].sort((a,b)=> (a<b?-1:a>b?1:0));}

    function getItemAccentClass(item){
    	const EntityConnector = item.EntityConnector || {};
    	if (!EntityConnector.enabled) return '';
    	const entityInfo = classifyEntity(EntityConnector);
    	if (entityInfo.mode === 'ok') {
    		const derivedStatus = deriveEntityTaskStatus(EntityConnector, entityInfo);
    		return accentClassFromEntityStatus(derivedStatus);
    	}
    	return 'imp-yellow';
    }

    function startOfIsoWeek(d){
    	const wd = d.getDay() || 7;
    	const res = new Date(d);
    	res.setDate(res.getDate() - (wd - 1));
    	res.setHours(0,0,0,0);
    	return res;
    }

    function firstOfMonth(d){
    	const res = new Date(d.getFullYear(), d.getMonth(), 1);
    	res.setHours(0,0,0,0);
    	return res;
    }

    function lastOfMonth(d){
    	const res = new Date(d.getFullYear(), d.getMonth() + 1, 0);
    	res.setHours(0,0,0,0);
    	return res;
    }

    function loadCalendarRef(){
    	const cur = loadUiState();
    	const d = parseDate(cur.calRef);
    	return d || today();
    }

    function saveCalendarRef(d){
    	saveUiState({ calRef: toISO(d) });
    }
    
    
    
    window.doExport = async function doExport(reason){
          if (window.__ppExportInProgress) return;
          window.__ppExportInProgress = true;
          setSyncStatus('syncRunning');
          try{
          const base = Array.isArray(window.TABLE_DATA) ? JSON.parse(JSON.stringify(window.TABLE_DATA)) : [];
          const rows = applyOverrides(base).map(r => recompute(r));
            const jsContent = 'window.TABLE_DATA = ' + JSON.stringify(rows, null, 2) + ';\n';
            const content_b64 = btoa(unescape(encodeURIComponent(jsContent)));
            await callWebhook({ savingpath: window.PP_FILE_SAVE_DIR , filename : 'data.updated.js', content_b64 });
          
            reloadUpdatedScriptAndRender();
            setSyncStatus('syncDone');
          } catch (e) {
            setSyncStatus('syncError');
            throw e;
          } finally {
            window.__ppExportInProgress = false;
            window.__ppHasUnsavedChanges = false;
          }
    };
    
    
      

      

      let __exportTimer = null;
      function scheduleExport(reason='change'){
        clearTimeout(__exportTimer);
        setSyncStatus('syncRunning');
        window.__ppHasUnsavedChanges = true;
        __exportTimer = setTimeout(()=>{ doExport(reason); }, 400);
      }
      exportBtn.addEventListener('click', ()=>{ doExport('button'); });

      btnTest.addEventListener('click', async ()=>{
        try{
          const dummy = 'window.TABLE_DATA = []; // TEST\n';
          const content_b64 = btoa(unescape(encodeURIComponent(dummy)));
          await callWebhook({ savingpath: window.PP_FILE_SAVE_DIR , filename: 'data.updated.js' , content_b64 });
          reloadUpdatedScriptAndRender();
        }catch(e){
          alert('Webhook-Test fehlgeschlagen: ' + e.message);
        }
      });
      
    rangeSelect.innerHTML = CONFIG.ranges.map(r => `<option value="${r.key}">${r.label[lang] || r.label.de}</option>`).join('');
    const ui2 = loadUiState();
    if (ui2.range) rangeSelect.value = ui2.range;
    if (!rangeSelect.value) rangeSelect.value = 'all';
    
    
    function restoreAdded(){
    	try{
    		const ADDED_KEY = 'pp-added';
    		const added = JSON.parse(localStorage.getItem(ADDED_KEY) || '[]');
    		if (Array.isArray(added) && added.length) {
    			if (!Array.isArray(window.TABLE_DATA)) window.TABLE_DATA = [];
    			const existing = new Set(window.TABLE_DATA.map(r => r.__uid).filter(Boolean));
    			for (const r of added){
    				if (!r.__uid) r.__uid = uid();
    				if(!Array.isArray(r.__history)) r.__history = [];
    				if(!existing.has(r.__uid)){
    					window.TABLE_DATA.push(r);
    					existing.add(r.__uid);
    				}
    			}
    		}
    	}catch{}
    }
    
    let __prefsLoaded = false;
    let __prefsLoading = null;
    window.ppRender = function(){
    	if (!__prefsLoaded) {
    		if (!__prefsLoading) {
    			__prefsLoading = loadUserPrefs().finally(()=>{
    				__prefsLoaded = true;
    				__prefsLoading = null;
    				window.ppRender();
    			});
    		}
    		return;
    	}
    	ensureUids();
    	restoreAdded();
    	applyTranslations();
    	render();
    };
    
    // Filter/Suche
    rangeSelect.addEventListener('change', render);
    sortSelect.addEventListener('change', render);
    searchInput.addEventListener('input', render);
    // initial
    applyTranslations();
    
    // ===== History SVG =====
    function buildHistorySVG(dates, rhythmDays){
    	const W = 640, H = 110, L = 24, R = 12, T = 18, B = 30;
    	const midY = Math.round(H / 2);
    	const RY = Math.max(1, Number.isFinite(rhythmDays) ? Number(rhythmDays) : 7);
    	const now = today();
    	const maxX = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    	const MAX_LOOKBACK_DAYS = Math.round(365.25 * 2);
    	const lookbackDays = Math.min(8 * RY, MAX_LOOKBACK_DAYS);
    	const minX = addDays(maxX, -lookbackDays);
    	const toTime = d => d.getTime();
    	const span = Math.max(1, toTime(maxX) - toTime(minX));
    	const xOf = (d)=> {
    		const t = Math.min(Math.max(toTime(d), toTime(minX)), toTime(maxX));
    		return L + ((t - toTime(minX)) / span) * (W - L - R);
    	};
    	const fmtShort = (d)=> new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { day:'2-digit', month:'short' }).format(d).replace('.', '').replace(/\s+/, '. ');
    	const fmtYear = (d)=> d.getFullYear();
    	const pts = (Array.isArray(dates)?dates:[])
    		.map(d => d instanceof Date ? d : null)
    		.filter(Boolean)
    		.filter(d => d >= minX && d <= maxX)
    		.sort((a,b)=> a-b)
    		.map(d => ({ x: Math.round(xOf(d)), y: midY, d }));
    		
    	function startOfISOWeek(d){
    		const wd = d.getDay() || 7;
    		const res = new Date(d);
    		res.setDate(res.getDate() - (wd - 1));
    		res.setHours(0,0,0,0);
    		return res;
    	}
    	
    	function* eachMondayBetween(a,b){
    		let m = startOfISOWeek(a);
    		if (m < a) m = addDays(m, 7);
    		while (m <= b){ yield new Date(m); m = addDays(m, 7); }
    	}
    	
    	function firstOfMonth(d){
    		const res = new Date(d.getFullYear(), d.getMonth(), 1);
    		res.setHours(0,0,0,0);
    		return res;
    	}
    	
    	function* eachFirstOfMonthStepBetween(a,b, stepMonths=1){
    		let m = firstOfMonth(a);
    		if (m < a) m = new Date(m.getFullYear(), m.getMonth()+stepMonths, 1);
    		while (m <= b){
    			yield new Date(m);
    			m = new Date(m.getFullYear(), m.getMonth()+stepMonths, 1);
    		}
    	}
    	
    	function uniqByTime(list){
    		const seen = new Set(); const out = [];
    		for (const d of list){
    			const t = +d;
    			if(!seen.has(t)){
    				seen.add(t); out.push(d);
    			}
    		}
    		return out.sort((a,b)=>a-b);
    	}
    	
    	function januarysBetween(a,b){
    		const res = [];
    		for (let y = a.getFullYear(); y <= b.getFullYear(); y++){
    			const d = new Date(y, 0, 1);
    			if (d >= a && d <= b) res.push(d);
    		}
    		return res;
    	}
    	
    	const useMonthly = RY >= 8;
    	const every2Months = RY > 30;
    	const tickEls = [];
    	if (useMonthly){
    		const step = every2Months ? 2 : 1;
    		let tickDates = [];
    		for (const d of eachFirstOfMonthStepBetween(minX, maxX, step)){
    			tickDates.push(new Date(d));
    		}
    		if (every2Months){
    			tickDates = uniqByTime([...tickDates, ...januarysBetween(minX, maxX)]);
    		}
    		for (const d of tickDates){
    			const x = Math.round(xOf(d));
    			const label = fmtShort(d);
    			const isNewYear = d.getMonth() === 0;
    			const yearLabel = fmtYear(d);
    			tickEls.push(`
    				<line x1="${x}" y1="${T}" x2="${x}" y2="${H-B}" opacity=".35"></line>
    				<text x="${x}" y="${H-12}" font-size="11" text-anchor="middle" fill="currentColor" opacity=".9">${label}</text>
    				${isNewYear ? `<text x="${x}" y="${H-2}" font-size="10" text-anchor="middle" fill="currentColor" opacity=".6">${yearLabel}</text>` : ''}
    			`);
    		}
    	} else {
    		for (const d of eachMondayBetween(minX, maxX)){
    		const x = Math.round(xOf(d));
    		const label = fmtShort(d);
    		const isNewYear = (d.getDate() <= 7 && d.getMonth() === 0);
    		const yearLabel = fmtYear(d);
    		tickEls.push(`
    			<line x1="${x}" y1="${T}" x2="${x}" y2="${H-B}" opacity=".35"></line>
    			<text x="${x}" y="${H-12}" font-size="11" text-anchor="middle" fill="currentColor" opacity=".9">${label}</text>
    			${isNewYear ? `<text x="${x}" y="${H-2}" font-size="10" text-anchor="middle" fill="currentColor" opacity=".6">${yearLabel}</text>` : ''}
    		`);
    	}
    }
    
    const axis = `M ${L},${midY} L ${W-R},${midY}`;
    const crosses = pts.map(p => {
    	const size = 6;
    	const x1 = p.x - size, x2 = p.x + size;
    	const y1 = p.y - size, y2 = p.y + size;
    	const label = fmtShort(p.d);
    	return `
    		<g stroke="currentColor" fill="none" stroke-width="2">
    		<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"></line>
    		<line x1="${x1}" y1="${y2}" x2="${x2}" y2="${y1}"></line>
    		<title>${label}</title>
    		</g>
    	`;}).join('');
    
    if (!dates || !dates.length){
    	return `<div class="hist-empty">${t('noEntries')}</div>`;
    }
    return `<svg class="hist-svg" viewBox="0 0 ${W} ${H}" role="img" aria-label="Historie als Zeitachse">
    		<g stroke="var(--border-color-alt)" fill="none"><rect x="1" y="1" width="${W-2}" height="${H-2}" rx="8" ry="8" opacity=".2"></rect>${tickEls.join('')}</g>
    		<g stroke="currentColor" stroke-width="3" fill="none" opacity=".6"><path d="${axis}"></path></g>${crosses}
    		</svg>`;
    }
    
    function getHass(){
    	try{
    		return (
    			window.hass ||
    			window.parent?.document?.querySelector('home-assistant')?.hass ||
    			window.top?.document?.querySelector('home-assistant')?.hass ||
    			null
    		);
    	} catch(_)
    	{ return null; }
    }
    
    function readEntityState(entityId){
    	const hass = getHass();
    	if (!hass || !entityId) return { ok:false, reason:'no_access' };
    	const st = hass.states?.[entityId];
    	if (!st) return { ok:false, reason:'no_entity' };
    	return { ok:true, state: st.state, attributes: st.attributes || {} };
    }
    
    function isBadStateString(s){
    	s = (s ?? '').toString().toLowerCase().trim();
    	return (!s ||  s === 'unknown' || s === 'unavailable' || s === 'not_available' || s === 'undefined' || s === 'none' || s === 'null' );
    }
    
    function classifyEntity(EntityConnector){
    	if (!EntityConnector?.enabled || !EntityConnector.entity_id) return { mode:'off' };
    	const r = readEntityState(EntityConnector.entity_id);
    	if (!r.ok) return { mode:'no_access', raw: null };
    	const raw = r.state;
    	const attrs = r.attributes || {};
    	if (isBadStateString(raw)) {
    		return { mode:'bad_state', raw, attributes: attrs };
    	}
    	if ((EntityConnector.type || 'number') === 'number'){
    		const num = Number(raw);
    		if (!Number.isFinite(num)) {
    			return { mode:'bad_state', raw, attributes: attrs };
    		}
    		return { mode:'ok', raw, value:num, attributes: attrs };
    	}
    	return { mode:'ok', raw:String(raw), value:String(raw), attributes: attrs };
    }
    
    function evalOp(op, left, right){
    	switch(op){
    		case '<=': return left <= right;
    		case '<':  return left <  right;
    		case '>=': return left >= right;
    		case '>':  return left >  right;
    		case '==': return left == right;
    		case '!=': return left != right;
    		default: return false;
    	}
    }
    
    function conditionMatches(EntityConnector, which, value){
    	const cond = EntityConnector?.[which];
    	if (!cond) return false;
    	if ((EntityConnector.type||'number') === 'number'){
    		const right = Number(cond.value);
    		if (!Number.isFinite(right)) return false;
    		return evalOp(cond.op, Number(value), right);
    	} else {
    		const left = normalizeTextValue(value);
    		const right = normalizeTextValue(cond.value);
    		if (cond.op === '==' || cond.op === 'equals') return left === right;
    		if (cond.op === '!=') return left !== right;
    		return false;
    	}
    }

    function normalizeTextValue(v){
    	const s = String(v ?? '').trim().toLowerCase();
    	if (s === 'on' || s === 'true') return 'true';
    	if (s === 'off' || s === 'false') return 'false';
    	return s;
    }

    function ruleToIntervals(op, v){
    	switch(op){
    		case '<':  return [{ min:-Infinity, max:v, minInc:false, maxInc:false }];
    		case '<=': return [{ min:-Infinity, max:v, minInc:false, maxInc:true }];
    		case '>':  return [{ min:v, max:Infinity, minInc:false, maxInc:false }];
    		case '>=': return [{ min:v, max:Infinity, minInc:true, maxInc:false }];
    		case '==': return [{ min:v, max:v, minInc:true, maxInc:true }];
    		case '!=': return [
    			{ min:-Infinity, max:v, minInc:false, maxInc:false },
    			{ min:v, max:Infinity, minInc:false, maxInc:false }
    		];
    		default: return [];
    	}
    }

    function intervalsOverlap(a, b){
    	for (const i of a){
    		for (const j of b){
    			const min = Math.max(i.min, j.min);
    			const max = Math.min(i.max, j.max);
    			if (min < max) return true;
    			if (min === max){
    				const iInc = (min === i.min) ? i.minInc : i.maxInc;
    				const jInc = (min === j.min) ? j.minInc : j.maxInc;
    				if (iInc && jInc) return true;
    			}
    		}
    	}
    	return false;
    }

    function rulesOverlapNumeric(dueOp, dueVal, doneOp, doneVal){
    	const due = ruleToIntervals(dueOp, dueVal);
    	const done = ruleToIntervals(doneOp, doneVal);
    	if (!due.length || !done.length) return false;
    	return intervalsOverlap(due, done);
    }

    function rulesOverlapText(dueOp, dueVal, doneOp, doneVal){
    	const d = normalizeTextValue(dueVal);
    	const n = normalizeTextValue(doneVal);
    	if (!['==','!='].includes(dueOp)) return false;
    	if (!['==','!='].includes(doneOp)) return false;
    	if (dueOp === '==' && doneOp === '==') return d === n;
    	if (dueOp === '!=' && doneOp === '!=') return true;
    	if (dueOp === '==' && doneOp === '!=') return d !== n;
    	if (dueOp === '!=' && doneOp === '==') return d !== n;
    	return false;
    }

    function validateEntityRules(type, dueOp, dueValRaw, doneOp, doneValRaw){
    	if ((type || 'number') === 'number'){
    		const dueVal = Number(dueValRaw);
    		const doneVal = Number(doneValRaw);
    		if (!Number.isFinite(dueVal) || !Number.isFinite(doneVal)) return { ok:false, key:'entityRuleInvalid' };
    		if (rulesOverlapNumeric(dueOp, dueVal, doneOp, doneVal)) return { ok:false, key:'entityRuleOverlap' };
    		return { ok:true };
    	}
    	const dueVal = String(dueValRaw ?? '').trim();
    	const doneVal = String(doneValRaw ?? '').trim();
    	if (!['==','!='].includes(dueOp) || !['==','!='].includes(doneOp)) return { ok:false, key:'entityRuleInvalid' };
    	if (rulesOverlapText(dueOp, dueVal, doneOp, doneVal)) return { ok:false, key:'entityRuleOverlap' };
    	return { ok:true };
    }
    
    function deriveEntityTaskStatus(EntityConnector, entityInfo){
    	if (!EntityConnector?.enabled) return null;
    	if (entityInfo.mode !== 'ok') return 'bad';
    	const v = entityInfo.value;
    	if (conditionMatches(EntityConnector, 'done_rule', v)) return 'done';
    	if (conditionMatches(EntityConnector, 'due_rule', v))  return 'due';
    	return 'pending';
    }
    
    function formatEntityDisplay(entityInfo){
    	if (!entityInfo || entityInfo.mode !== 'ok') return null;
    	const name = entityInfo.attributes?.friendly_name || '';
    	const unit = entityInfo.attributes?.unit_of_measurement || entityInfo.attributes?.unit || '';
    	const value = entityInfo.value ?? entityInfo.raw;
    	return {
    		name,
    		valueText: unit ? `${value} ${unit}` : String(value)
    	};
    }
    
    function isNumeric(value) {
    	return !isNaN(value) && isFinite(value);
    }
    
    function EntityConnectorKeyForRow(row) {
    	// Generiere einen eindeutigen SchlÃ¼ssel basierend auf dem __uid und entity_id der Zeile
    	return row.__uid + '-' + (row.EntityConnector?.entity_id || 'unknown');
    }
    
    function applyEntityConnectorDerivedDue(row) {
    	const EntityConnector = row.EntityConnector;
    	if (!EntityConnector?.enabled) return;
    	const info = classifyEntity(EntityConnector);
    	const status = deriveEntityTaskStatus(EntityConnector, info); // 'done' | 'due' | 'pending' | 'bad'
    	const nowMs = Date.now();
    	
    	// If the status is 'done', the task is completed, reset the due date
    	if (status === 'done') {
    		row['New Due date [date]'] = null;
    		row['Due in [days]'] = Number(row.__rhythmDaysEff) || null;
    		return;
    	}
    	
    	if (status === 'pending') {
  			row['New Due date [date]'] = null;
  			row['Due in [days]'] = Number(row.__rhythmDaysEff) || null;
  			return;
		}
  		
  		if (status === 'due') {
  			row['New Due date [date]'] = null;
    		row['Due in [days]'] = 0;
    		return;
    	}
    	
    	// If the status is 'bad', no due date
    	if (status == 'bad') {
    		row['New Due date [date]'] = null;
    		row['Due in [days]'] = -100;
    		return;
    	}
    	
    	// If the task is 'due', calculate the new due date
    	const rhythmAmount = Number(row.Rhythmen);
    	const rhythmUnit = normalizeUnit(row.RhythmUnit);
    	const lastDate = parseDate(row['Last done [Date]']);
    	const rhythmDaysEff = lastDate ? getRhythmDaysEffective(rhythmAmount, rhythmUnit, lastDate) : getRhythmDaysEffective(rhythmAmount, rhythmUnit, null);
    	
    	// Calculate the new due date if the task is 'due'
    	const newDueDate = addByRhythm(nowMs, rhythmAmount, rhythmUnit);
    	row['New Due date [date]'] = toISO(newDueDate);
    	
    	// Set the 'Due in [days]' field, showing how many days until the task is due
    	const dueInDays = diffInDays(newDueDate, nowMs);
    	row['Due in [days]'] = dueInDays;
    }
    
    
    function wireEntityConnectorAccordion(form, enabledId, detailsId){
    	const enabled = form.querySelector('#' + enabledId);
    	const details = form.querySelector('#' + detailsId);
    	if (!enabled || !details) return;
    	const sync = ()=>{
    		details.open = !!enabled.checked;
    	};
    	
    	// Klick auf Checkbox soll NICHT den Summary-Click toggeln
    	enabled.addEventListener('click', (e)=> e.stopPropagation());
    	
    	// Falls User versucht, Details per Summary zu toggeln: erzwingen
    	details.addEventListener('toggle', ()=>{
    		if (details.open && !enabled.checked) details.open = false;
    		if (!details.open && enabled.checked) details.open = true;
    	});
    	
    	enabled.addEventListener('change', sync);
    	sync();
    }
    
function accentClassFromEntityStatus(status){
  switch(status){
    case 'due':     return 'imp-red';
    case 'done':    return 'imp-green';
    case 'pending': return 'imp-yellow';
    default:        return 'imp-purple';
  }
}
   function markDoneById(id){
    	const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
    	const idx = rowsAll.findIndex(r=> r.__uid === id);
    	if(idx < 0) return;
    	const r = rowsAll[idx];
    	const now = today();
    	const nowIso = toISO(now);
    	const doneBy = getActiveUserName();
    	const prevLast = r['Last done [Date]'] || null;
    	const hist = Array.isArray(r.__history) ? r.__history.slice() : [];
    	if (prevLast) hist.push(prevLast);
    	hist.push(nowIso);
    	r.__history = uniqPreserveOrder(hist);
    	r['Last done [Date]'] = nowIso;
    	r['Last done [By]'] = doneBy;
    	const doneByHist = Array.isArray(r.__history_doneby) ? r.__history_doneby.slice() : [];
    	const cleanedDoneByHist = doneByHist.filter(h => h && typeof h === 'object' && h.date && h.user && h.date !== nowIso);
    	cleanedDoneByHist.push({ date: nowIso, user: doneBy });
    	r.__history_doneby = cleanedDoneByHist;
    	
    	const calcRaw = addByRhythm(now, r.Rhythmen || 0, r.RhythmUnit);
    	const calcDue = shiftToAllowedDate(calcRaw, r.MonthMask, r.WeekMask);
    	const manualDue = r['New Due date [date]'] ? parseDate(r['New Due date [date]']) : null;
    	
    	// Ãœberschreiben nur wenn calc spÃ¤ter ist (oder manual ungÃ¼ltig/zu frÃ¼h)
    	let next = calcDue;
    	if (manualDue) {
    		const manualBad = manualDue < now;            // optional: â€œmanual liegt in der Vergangenheitâ€
    		const calcLater = calcDue > manualDue;        // dein Wunsch
    		next = (manualBad || calcLater) ? calcDue : manualDue;
    	}
    	r['New Due date [date]'] = toISO(next);
    	r['Due in [days]'] = diffInDays(next, now);
    	
    	const ov = getOverrides();
    	const key = makeId(r);
    	ov[key] = {
    		...(ov[key]||{}),
    		__uid: r.__uid,
    		Notes: typeof r.Notes === 'string' ? r.Notes : '',
    		MonthMask: normalizeMonthMask(r.MonthMask),
    		WeekMask: normalizeWeekMask(r.WeekMask),
    		'Last done [Date]': r['Last done [Date]'],
    		'Last done [By]': r['Last done [By]'],
    		'New Due date [date]': r['New Due date [date]'],
    		'Due in [days]': r['Due in [days]'],
    		EntityConnector: r.EntityConnector,
    		__history: r.__history,
    		__history_doneby: r.__history_doneby
    	};
    	setOverrides(ov);
    	render();
    	scheduleExport('mark-done');
    }
    

   function setDueDateById(id, targetDate){
    	const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
    	const idx = rowsAll.findIndex(r=> r.__uid === id);
    	if (idx < 0) return;
    	const r = rowsAll[idx];
    	const base = targetDate instanceof Date ? targetDate : parseDate(targetDate);
    	if (!base) return;
    	const shifted = shiftToAllowedDate(base, r.MonthMask, r.WeekMask);
    	const iso = toISO(shifted);
    	r['New Due date [date]'] = iso;
    	r['Due in [days]'] = diffInDays(shifted, today());

    	const ov = getOverrides();
    	const key = makeId(r);
    	ov[key] = {
    		...(ov[key]||{}),
    		__uid: r.__uid,
    		Notes: typeof r.Notes === 'string' ? r.Notes : '',
    		Assignee : r.Assignee,
    		MonthMask: normalizeMonthMask(r.MonthMask),
    		WeekMask: normalizeWeekMask(r.WeekMask),
    		'New Due date [date]': r['New Due date [date]'],
    		'Due in [days]': r['Due in [days]'],
    		EntityConnector: r.EntityConnector,
    		__history: r.__history
    	};
    	setOverrides(ov);
    	render();
    	scheduleExport('drag-drop');
    }

    // ===== Card =====
    function createCard(item){
    	const card = document.createElement('article');
    	card.className = 'card';
    	const EntityConnector = item.EntityConnector || {};
    	let entityInfo = null;
    	let entityDisplay = null;
    	let isEntityMode = false;
    	let derivedStatus = null;
    	
    	// ÃœberprÃ¼fe, ob EntityConnector.enabled wahr ist
    	if (EntityConnector.enabled) {
    		entityInfo = classifyEntity(EntityConnector);
    		entityDisplay = formatEntityDisplay(entityInfo);
    		if (entityInfo.mode === 'no_access') card.classList.add('EntityConnector-no-access');
    		if (entityInfo.mode === 'bad_state') card.classList.add('EntityConnector-bad-state');
    		isEntityMode = true;
    		derivedStatus = deriveEntityTaskStatus(EntityConnector, entityInfo);
    	}
    	let dueDays = Number(item['Due in [days]']);
    	const rhythmAmount = Number(item.Rhythmen);
    	const rhythmUnit = normalizeUnit(item.RhythmUnit);
    	const lastDate = parseDate(item['Last done [Date]']);
    	const rhythmDaysEff = lastDate
    		? getRhythmDaysEffective(rhythmAmount, rhythmUnit, lastDate)
    		: getRhythmDaysEffective(rhythmAmount, rhythmUnit, null);
    	
    	let imp = '';
		if (EntityConnector.enabled) {
		  // Entity steuert IMMER die Seitenleiste
		    if (entityInfo.mode === 'ok') {
		        imp = accentClassFromEntityStatus(derivedStatus);
		    } else {
		        // no_access / bad_state
		        imp = 'imp-yellow';
		    }
		} else {
		  // normales Verhalten ohne Entity
		    imp = CONFIG.colorByDue
		    ? accentClassFromDue(dueDays, rhythmDaysEff)
		    : importanceClass(item['Importance (colorScale)']);
		}
    		
    	if (EntityConnector.enabled) {
    		// Fallback: wenn EntityConnector aktiv ist und Entity kaputt/nicht nutzbar â†’ "heute fÃ¤llig"
    		const hasEntityConnector = !!EntityConnector.enabled;
    		const entityProblem = (entityInfo.mode === 'no_access' || entityInfo.mode === 'bad_state');
    		if (hasEntityConnector && entityProblem) {dueDays = 0;}
    	}
    	const dueCls = dueClass(dueDays);
    	const icon = (item.Icon && String(item.Icon).trim()) ? String(item.Icon).trim() : 'mdi:check';
    	const id = item.__uid;
    	let dueText = 'â€”';
    	const lastDoneBy = String(item['Last done [By]'] || '').trim() || 'â€”';
    	const activeUser = getActiveUser();
    	const showAssignees = isAdminRoleString(activeUser?.role);
    	const assigneeTokens = String(item?.Assignee || '')
    		.split(',')
    		.map(s => s.trim())
    		.filter(Boolean);
    	const assigneeDisplay = assigneeTokens.length ? assigneeTokens : [t('assigneeAll')];
    	const assigneePillsHtml = assigneeDisplay
    		.map(v => `<span class="pill">${escapeHtml(v)}</span>`)
    		.join('');
    	if (Number.isFinite(dueDays)) {
    		if (dueDays === 0) dueText = t('today');
    		else if (dueDays > 0) dueText = `${dueDays} ${t('days')}`;
    		else dueText = `${Math.abs(dueDays)} ${t('days')} ${t('overdueSuffix')}`;
    	}
    	
    	card.innerHTML = `
    		<span class="accent ${imp}" aria-hidden="true"></span>
    		<button class="edit-btn" type="button" title="${escapeHtml(t('editTitle'))}" data-id="${id}">
    			<iconify-icon icon="mdi:pencil"></iconify-icon>
    		</button>
    		
    		<div class="top">
    			<div class="icn" data-id="${id}" title="${escapeHtml(t('lastDone'))} â†’ ${escapeHtml(t('today'))}">
    				<iconify-icon icon="${icon}"></iconify-icon>
    			</div>
    			<div>
    				<div class="task">${escapeHtml(item.Task || 'â€”')}</div>
    				<div class="meta">
    					<span class="pill">${escapeHtml(t('area'))}: ${escapeHtml(item.Area || 'â€”')}</span>
    					<span class="pill">${escapeHtml(t('rhythm'))}: ${Number.isFinite(rhythmAmount) ? rhythmAmount : 'â€”'} ${escapeHtml(rhythmUnitLabel(rhythmUnit))}</span>
    				</div>
    				
    				${entityDisplay ? `
    					<div class="row">
    						<span>${escapeHtml(entityDisplay.name || EntityConnector.entity_id || 'â€”')}</span>
    						<b>${escapeHtml(entityDisplay.valueText)}</b>
    					</div>
    					` : ''}
    			</div>
    		</div>
    		
    		<div class="row">
    			<span>${escapeHtml(t('lastDone'))}</span>
    			<b>${fmtDate(item['Last done [Date]'])}</b>
    		</div>
    		<div class="row">
    			<span>${escapeHtml(t('lastDoneBy'))}</span>
    			<b>${escapeHtml(lastDoneBy)}</b>
    		</div>
    		${showAssignees ? `
    		<div class="row">
    			<span>${escapeHtml(t('assignees'))}</span>
    			<b class="assignee-pills">${assigneePillsHtml}</b>
    		</div>
    		` : ''}
    		
    		
    		${isEntityMode ? `
    			<div class="row">
    				<span>${escapeHtml(t('entity'))}</span>
    				<b>${escapeHtml(EntityConnector.entity_id || 'â€”')}</b>
    			</div>
    			<div class="row">
    				<span>${escapeHtml(t('entityState'))}</span>
    				<b>${escapeHtml(
    					entityInfo.mode==='ok'
    					? String(entityInfo.raw)
    					: t(entityInfo.mode==='no_access' ? 'entityNoAccess' : 'entityBadState'))}
    				</b>
    			</div>
    			
    			<div class="row">
    				<span>${escapeHtml(t('status'))}</span>
    				<b>${escapeHtml(
    					derivedStatus==='done'
    					? t('statusDone')
    					: derivedStatus==='due'
    					? t('statusDue')
    					: derivedStatus==='bad'
    					? t('statusUnknown')
    					: t('statusPending'))}
    				</b>
    			</div>
    		` : `
    			<div class="row">
    				<span>${escapeHtml(t('nextDue'))}</span>
    				<b>${fmtDate(item['New Due date [date]'])}</b>
    			</div>
    			<div class="row due ${dueCls}">
    				<span>${escapeHtml(t('dueIn'))}</span>
    				<b>${escapeHtml(dueText)}</b>
    			</div>
    		`}
    	`;
    	
    	// Done click
    	const icn = card.querySelector('.icn');
    	icn.addEventListener('click', ()=>{
    		icn.classList.add('pulse');
    		setTimeout(()=>icn.classList.remove('pulse'), 800);
    		markDoneById(id);
    	});
    	return card;
    }
    
    // ===== Render =====
    function render(){
    	const sortMode = sortSelect.value;
    	const q = searchInput.value.trim().toLowerCase();
    	const rangeKey = rangeSelect.value;
    	const rangeDef = CONFIG.ranges.find(r => r.key === rangeKey) || CONFIG.ranges[0];
    	const viewMode = viewSelect.value;
    	let rows = Array.isArray(window.TABLE_DATA) ? [...window.TABLE_DATA] : [];
    	rows = applyOverrides(rows);
    	rows = rows.filter(matchesAssignee);
    	if (viewMode !== 'calendar-week' && viewMode !== 'calendar-month' && viewMode !== 'calendar-list') {
    		rows = rows.filter(r => rangeDef.test(Number(r['Due in [days]'])));
    	}
    	if(q){
    		rows = rows.filter(r => String(r.Task||'').toLowerCase().includes(q) || String(r.Area||'').toLowerCase().includes(q) );
    	}
    	const sorters = {
    		due:   (a,b)=> (Number(a['Due in [days]']) ?? 0) - (Number(b['Due in [days]']) ?? 0),
    		alpha: (a,b)=> String(a.Task||'').localeCompare(String(b.Task||''),
    		lang==='de'?'de':'en')
    	};
    	const frag = document.createDocumentFragment();
    	
    	if (viewMode === 'calendar-week' || viewMode === 'calendar-month' || viewMode === 'calendar-list') {
    		const ref = loadCalendarRef();
    		const isWeek = viewMode === 'calendar-week';
    		const isList = viewMode === 'calendar-list';
    		const weekStart = startOfIsoWeek(ref);
    		const monthStart = startOfIsoWeek(firstOfMonth(ref));
    		const monthEnd = addDays(startOfIsoWeek(lastOfMonth(ref)), 6);
    		const gridStart = isWeek ? weekStart : monthStart;
    		const gridEnd = isWeek ? addDays(weekStart, 6) : monthEnd;
    		const dayCount = diffInDays(gridEnd, gridStart);

    		const map = new Map();
    		rows.forEach(item=>{
    			const due = parseDate(item['New Due date [date]']);
    			if (!due) return;
    			const key = toISO(due);
    			if (!map.has(key)) map.set(key, []);
    			map.get(key).push(item);
    		});

    		const fmtDayName = new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { weekday:'short' });
    		const fmtTitle = new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { month:'long', year:'numeric' });
    		const fmtRange = new Intl.DateTimeFormat(lang==='de'?'de-DE':'en-US', { day:'2-digit', month:'short' });

    		const overdueItems = rows.filter(r => Number(r['Due in [days]']) < 0).sort(sorters[sortMode]);
    		const section = document.createElement('section');
    		section.className = 'area calendar' + (isWeek ? ' calendar-week' : '');

    		const header = document.createElement('div');
    		header.className = 'calendar-header';
    		const title = isWeek
    			? `${fmtRange.format(gridStart)} â€“ ${fmtRange.format(gridEnd)}`
    			: fmtTitle.format(ref);
    		header.innerHTML = `
    			<div class="calendar-title">${escapeHtml(title)}</div>
    			<div class="calendar-nav">
    				<button class="btn" type="button" data-cal="prev" title="${escapeHtml(t('calPrev'))}">
    					<iconify-icon icon="mdi:chevron-left"></iconify-icon>
    				</button>
    				<button class="btn" type="button" data-cal="today" title="${escapeHtml(t('calToday'))}">
    					<iconify-icon icon="mdi:calendar-today"></iconify-icon>
    				</button>
    				<button class="btn" type="button" data-cal="next" title="${escapeHtml(t('calNext'))}">
    					<iconify-icon icon="mdi:chevron-right"></iconify-icon>
    				</button>
    			</div>
    		`;
    		section.appendChild(header);

    		const body = document.createElement('div');
    		body.className = isList ? 'calendar-list' : 'calendar-body';

    		const overdue = document.createElement('aside');
    		overdue.className = 'calendar-overdue';
    		overdue.innerHTML = `
    			<div class="calendar-overdue-title">${escapeHtml(t('calOverdue'))}</div>
    			<div class="calendar-overdue-list"></div>
    		`;
    		const overdueList = overdue.querySelector('.calendar-overdue-list');
    		if (!overdueItems.length) {
    			const empty = document.createElement('div');
    			empty.className = 'calendar-empty';
    			empty.textContent = 'â€”';
    			overdueList.appendChild(empty);
    		} else {
    			overdueItems.forEach(item=>{
    				const dueDays = Number(item['Due in [days]']);
    				const dueText = `${Math.abs(dueDays)} ${t('days')} ${t('overdueSuffix')}`;
    				const imp = getItemAccentClass(item);
    				const el = document.createElement('div');
    				el.className = 'calendar-item' + (imp ? ' ' + imp : '');
    				el.setAttribute('draggable', 'true');
    				el.dataset.id = item.__uid;
    				el.innerHTML = isList ? `
    					<button class="icn calendar-done" type="button" data-id="${item.__uid}" title="${escapeHtml(t('lastDone'))}">
    						<iconify-icon icon="${escapeHtml(item.Icon || 'mdi:check-circle-outline')}"></iconify-icon>
    					</button>
    					<div class="calendar-item-main">
    						<div class="calendar-item-title">${escapeHtml(item.Task || 'â€”')}</div>
    						<div class="calendar-item-meta">${escapeHtml(item.Area || 'â€”')}</div>
    						<div class="calendar-item-meta due overdue">${escapeHtml(dueText)}</div>
    					</div>
    					<div class="calendar-item-actions">
    						<button class="mini-btn edit-btn" type="button" data-id="${item.__uid}" title="${escapeHtml(t('editTitle'))}">
    							<iconify-icon icon="mdi:pencil"></iconify-icon>
    						</button>
    					</div>
    				` : `
    					<div class="calendar-item-title">${escapeHtml(item.Task || 'â€”')}</div>
    					<div class="calendar-item-meta">${escapeHtml(item.Area || 'â€”')}</div>
    					<div class="calendar-item-meta due overdue">${escapeHtml(dueText)}</div>
    					<div class="calendar-item-actions">
    						<button class="mini-btn calendar-done" type="button" data-id="${item.__uid}" title="${escapeHtml(t('lastDone'))}">
    							<iconify-icon icon="mdi:check"></iconify-icon>
    						</button>
    						<button class="mini-btn edit-btn" type="button" data-id="${item.__uid}" title="${escapeHtml(t('editTitle'))}">
    							<iconify-icon icon="mdi:pencil"></iconify-icon>
    						</button>
    					</div>
    				`;
    				overdueList.appendChild(el);
    			});
    		}

    		body.appendChild(overdue);

    		if (isList) {
    			for (let i = 0; i <= dayCount; i++){
    				const d = addDays(gridStart, i);
    				if (d.getMonth() !== ref.getMonth()) continue;
    				const key = toISO(d);
    				const items = (map.get(key) || []).sort(sorters[sortMode]);
    				if (!items.length) continue;
    				const dayEl = document.createElement('div');
    				const isToday = diffInDays(d, today()) === 0;
    				dayEl.className = 'calendar-list-day' + (isToday ? ' is-today' : '');
    				dayEl.dataset.date = key;
    				dayEl.innerHTML = `
    					<div class="calendar-list-head">
    						<span>${escapeHtml(fmtRange.format(d))}</span>
    						<span>${escapeHtml(fmtDayName.format(d))}</span>
    					</div>
    					<div class="calendar-list-items"></div>
    				`;
    				const listItems = dayEl.querySelector('.calendar-list-items');
    				items.forEach(item=>{
    					const imp = getItemAccentClass(item);
    					const el = document.createElement('div');
    					el.className = 'calendar-item' + (imp ? ' ' + imp : '');
    					el.setAttribute('draggable', 'true');
    					el.dataset.id = item.__uid;
    					el.innerHTML = `
    						<button class="icn calendar-done" type="button" data-id="${item.__uid}" title="${escapeHtml(t('lastDone'))}">
    							<iconify-icon icon="${escapeHtml(item.Icon || 'mdi:check-circle-outline')}"></iconify-icon>
    						</button>
    						<div class="calendar-item-main">
    							<div class="calendar-item-title">${escapeHtml(item.Task || 'â€”')}</div>
    							<div class="calendar-item-meta">${escapeHtml(item.Area || 'â€”')}</div>
    						</div>
    						<div class="calendar-item-actions">
    							<button class="mini-btn edit-btn" type="button" data-id="${item.__uid}" title="${escapeHtml(t('editTitle'))}">
    								<iconify-icon icon="mdi:pencil"></iconify-icon>
    							</button>
    						</div>
    					`;
    					listItems.appendChild(el);
    				});
    				body.appendChild(dayEl);
    			}
    		} else {
    			const grid = document.createElement('div');
    			grid.className = 'calendar-grid';

    			for (let i = 0; i <= dayCount; i++){
    				const d = addDays(gridStart, i);
    				const key = toISO(d);
    				const items = (map.get(key) || []).sort(sorters[sortMode]);
    				const dayEl = document.createElement('div');
    				const isOutside = !isWeek && d.getMonth() !== ref.getMonth();
    				const isToday = diffInDays(d, today()) === 0;
    				dayEl.className = 'calendar-day' + (isOutside ? ' is-outside' : '') + (isToday ? ' is-today' : '');
    				dayEl.dataset.date = key;
    				dayEl.innerHTML = `
    					<div class="calendar-day-head">
    						<span class="calendar-day-name">${escapeHtml(fmtDayName.format(d))}</span>
    						<span>${String(d.getDate()).padStart(2,'0')}</span>
    					</div>
    				`;

    				items.forEach(item=>{
    					const imp = getItemAccentClass(item);
    					const el = document.createElement('div');
    					el.className = 'calendar-item' + (imp ? ' ' + imp : '');
    					el.setAttribute('draggable', 'true');
    					el.dataset.id = item.__uid;
    					el.innerHTML = `
    						<div class="calendar-item-title">${escapeHtml(item.Task || 'â€”')}</div>
    						<div class="calendar-item-meta">${escapeHtml(item.Area || 'â€”')}</div>
    						<div class="calendar-item-actions">
    							<button class="mini-btn calendar-done" type="button" data-id="${item.__uid}" title="${escapeHtml(t('lastDone'))}">
    								<iconify-icon icon="mdi:check"></iconify-icon>
    							</button>
    							<button class="mini-btn edit-btn" type="button" data-id="${item.__uid}" title="${escapeHtml(t('editTitle'))}">
    								<iconify-icon icon="mdi:pencil"></iconify-icon>
    							</button>
    						</div>
    					`;
    					dayEl.appendChild(el);
    				});
    				grid.appendChild(dayEl);
    			}
    			body.appendChild(grid);
    		}
    		section.appendChild(body);
    		frag.appendChild(section);
    		app.replaceChildren(frag);

    		section.querySelectorAll('[data-cal]').forEach(btn=>{
    			btn.addEventListener('click', ()=>{
    				const action = btn.getAttribute('data-cal');
    				let next = new Date(ref);
    				if (action === 'today') next = today();
    				else if (action === 'prev') {
    					next = isWeek ? addDays(ref, -7) : addMonthsClamped(ref, -1);
    				} else if (action === 'next') {
    					next = isWeek ? addDays(ref, 7) : addMonthsClamped(ref, 1);
    				}
    				saveCalendarRef(next);
    				render();
    			});
    		});
    		return;
    	}

    	if (viewMode === 'flat') {
    		const items = rows.sort(sorters[sortMode]);
    		const section = document.createElement('section');
    		section.className = 'area';
    		const header = document.createElement('div');
    		header.className = 'area-header';
    		header.innerHTML = `
    			<div class="area-title">
    				<iconify-icon icon="mdi:format-list-bulleted"></iconify-icon>
    				${escapeHtml(t('allTasks'))}
    			</div>
    			<span class="badge" title="${escapeHtml(t('entries'))}">${items.length} ${escapeHtml(t('entries'))}</span>
    		`;
    		section.appendChild(header);
    		
    		const grid = document.createElement('div');
    		grid.className = 'grid';
    		items.forEach(item => grid.appendChild(createCard(item)));
    		section.appendChild(grid);
    		frag.appendChild(section);
    		app.replaceChildren(frag);
    		return;
    	}
    	
    	const byArea = groupByArea(rows);
    	const areas = [...byArea.keys()].sort((a,b)=>a.localeCompare(b, lang==='de'?'de':'en'));
    	areas.forEach(area=>{
    		const section = document.createElement('section');
    		section.className = 'area';
    		const isCollapsed = getCollapsed(area);
    		const header = document.createElement('div');
    		header.className = 'area-header' + (isCollapsed ? ' collapsed' : '');
    		header.innerHTML = `
    			<div class="area-toggle" role="button" aria-expanded="${!isCollapsed}" aria-controls="grid-${cssId(area)}">
    				<iconify-icon class="chev" icon="mdi:chevron-down"></iconify-icon>
    				<div class="area-title">${escapeHtml(area)}</div>
    				<span class="badge" title="${escapeHtml(t('entries'))}">${byArea.get(area).length} ${escapeHtml(t('entries'))}</span>
    			</div>
    		`;
    		section.appendChild(header);
    		const grid = document.createElement('div');
    		grid.className = 'grid' + (isCollapsed ? ' is-collapsed' : '');
    		grid.id = `grid-${cssId(area)}`;
    		const items = [...byArea.get(area)].sort(sorters[sortMode]);
    		items.forEach(item => grid.appendChild(createCard(item)));
    		section.appendChild(grid);
    		frag.appendChild(section);
    		
    		header.querySelector('.area-toggle').addEventListener('click',()=>{
    			const collapsed = grid.classList.toggle('is-collapsed');
    			header.classList.toggle('collapsed', collapsed);
    			header.querySelector('.area-toggle').setAttribute('aria-expanded', String(!collapsed));
    			setCollapsed(area, collapsed);
    		});
    	});
    	app.replaceChildren(frag);
    }
    
    // Edit delegation
    app.addEventListener('click', (e) => {
    	const btn = e.target.closest('button.edit-btn');
    	if (!btn) return;
    	const id = btn.dataset.id;
    	openEditDialog?.(id);
    });

    app.addEventListener('click', (e) => {
    	const btn = e.target.closest('button.calendar-done');
    	if (!btn) return;
    	const id = btn.dataset.id;
    	if (btn.classList.contains('icn')) {
    		btn.classList.add('pulse');
    		setTimeout(()=>btn.classList.remove('pulse'), 800);
    	}
    	if (id) markDoneById(id);
    });

    app.addEventListener('dragstart', (e) => {
    	const item = e.target.closest('.calendar-item');
    	if (!item) return;
    	const id = item.dataset.id;
    	if (!id) return;
    	e.dataTransfer?.setData('text/plain', id);
    	if (e.dataTransfer) e.dataTransfer.effectAllowed = 'move';
    });

    app.addEventListener('dragover', (e) => {
    	const day = e.target.closest('.calendar-day, .calendar-list-day');
    	if (!day) return;
    	e.preventDefault();
    	if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
    	day.classList.add('drag-over');
    });

    app.addEventListener('dragleave', (e) => {
    	const day = e.target.closest('.calendar-day, .calendar-list-day');
    	if (!day) return;
    	if (e.relatedTarget && day.contains(e.relatedTarget)) return;
    	day.classList.remove('drag-over');
    });

    app.addEventListener('drop', (e) => {
    	const day = e.target.closest('.calendar-day, .calendar-list-day');
    	if (!day) return;
    	e.preventDefault();
    	day.classList.remove('drag-over');
    	const id = e.dataTransfer?.getData('text/plain');
    	const date = day.dataset.date;
    	if (id && date) setDueDateById(id, date);
    });

    app.addEventListener('dragend', () => {
    	document.querySelectorAll('.calendar-day.drag-over, .calendar-list-day.drag-over').forEach(el=> el.classList.remove('drag-over'));
    });
    
    function safeInit(fn){
    	if (document.readyState === 'loading') window.addEventListener('DOMContentLoaded', fn, { once:true });
    	else fn();
    }
    
    function initAddDialog(){
    	const addBtn    = document.getElementById('add-task-btn');
    	const dlg       = document.getElementById('add-task-dialog');
    	const form      = document.getElementById('add-task-form');
    	const cancelBtn = document.getElementById('add-task-cancel');
    	if (!addBtn || !dlg || !form || !cancelBtn) return;
    	refreshAssignHints();
    	
    	function openAddDialog(){
    		form.reset();
    		wireEntityConnectorAccordion(form, 'add-EntityConnector-enabled', 'add-EntityConnector-acc');
    		// MonthMask default = alle Monate erlaubt
    		const mm = form.querySelector('#add-monthmask');
    		const grid = form.querySelector('#add-month-grid');
    		if (mm && grid) renderMonthGrid(grid, mm, MONTH_MASK_ALL);
    		const wm = form.querySelector('#add-weekmask');
    		const wgrid = form.querySelector('#add-week-grid');
    		if (wm && wgrid) renderWeekGrid(wgrid, wm, WEEK_MASK_ALL);
    		const tt = today();
    		const iso = `${tt.getFullYear()}-${String(tt.getMonth()+1).padStart(2,'0')}-${String(tt.getDate()).padStart(2,'0')}`;
    		form.elements['Last'].value = iso;
    		dlg.showModal();
    		attachIconPicker(form.elements['Icon']);
    	}
    	
    	function closeAddDialog(){
    		dlg.close();
    	}
    	
    	addBtn.addEventListener('click', openAddDialog);
    	cancelBtn.addEventListener('click', closeAddDialog);
    	dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); closeAddDialog(); });
    	
    	form.addEventListener('submit', (e)=>{
    		e.preventDefault();
    		const data = new FormData(form);
    		const lastIso = (data.get('Last')||'').trim();
    		
    		let EntityConnector = null; // StandardmÃ¤ÃŸig auf null setzen
    		
    		// ÃœberprÃ¼fen, ob das 'EntityConnectorEnabled' HÃ¤kchen gesetzt ist
    		if (data.get('EntityConnectorEnabled')) {
    			const type = (data.get('EntityConnectorType') || 'number').toString();
    			const dueOp = (data.get('EntityConnectorDueOp') || '<=').toString();
    			const dueVal = data.get('EntityConnectorDueVal');
    			const doneOp = (data.get('EntityConnectorDoneOp') || '>').toString();
    			const doneVal = data.get('EntityConnectorDoneVal');
    			// Setze die EntityConnector-Daten nur, wenn 'EntityConnectorEnabled' aktiviert ist
    			EntityConnector = {
    				enabled: true,
    				entity_id: (data.get('EntityConnectorEntity') || '').toString().trim(),
    				type,
    				due_rule: {
    					op: dueOp,
    					value: dueVal || ''
    				},
    				done_rule: {
    					op: doneOp,
    					value: doneVal || ''
    				}
    			}
    		} else {
    			EntityConnector = {
    				enabled: false }
    		}
    		
    		const row = {
    			__uid: uid(),
    			Area:      (data.get('Area')||'').trim(),
    			Task:      (data.get('Task')||'').trim(),
    			Assignee:  (data.get('Assignee')||'').trim(),
    			Notes:      ((data.get('Notes')||'') + '').trim(),
    			Rhythmen:  Number(data.get('Rhythmen')||0),
    			RhythmUnit: normalizeUnit(data.get('RhythmUnit') || 'd'),
    			MonthMask: normalizeMonthMask(data.get('MonthMask')),
    			WeekMask: normalizeWeekMask(data.get('WeekMask')),
    			EntityConnector: EntityConnector,
    			Icon:      (data.get('Icon')||'').trim(),
    		'Last done [Date]': lastIso || '',
    		'Last done [By]': lastIso ? getActiveUserName() : '',
    		'New Due date [date]': data.get('Due') || '',
    		'Due in [days]': null,
    			__history: lastIso ? [lastIso] : [],
    			__history_doneby: lastIso ? [{ date: lastIso, user: getActiveUserName() }] : []
     		};
    		
    		if (!Array.isArray(window.TABLE_DATA)) window.TABLE_DATA = [];
    		window.TABLE_DATA.push(row);
    		recompute(row);
    		render();
    		
    		try{
    			const ADDED_KEY = 'pp-added';
    			const added = JSON.parse(localStorage.getItem(ADDED_KEY)||'[]');
    			added.push(row);
    			localStorage.setItem(ADDED_KEY, JSON.stringify(added));
    		}catch{}
    		
    		scheduleExport('add');
    		closeAddDialog();
    	});
    }
    
    function initEditDialog(){
    	const dlg   = document.getElementById('edit-task-dialog');
    	const form  = document.getElementById('edit-task-form');
    	const cancelBtn = document.getElementById('edit-task-cancel');
    	const delBtn    = document.getElementById('edit-task-delete');
    	const clearHistBtn = document.getElementById('edit-history-clear');
    	const histAddBtn = document.getElementById('edit-history-add');
    	const histAddDate= document.getElementById('edit-history-date');
    	const histView   = document.getElementById('edit-history-view');
    	
    	if (!dlg || !form || !cancelBtn) return;
    	refreshAssignHints();
    	
    	function getRowById(id){
    		const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
    		const idx = rowsAll.findIndex(r => r.__uid === id);
    		return { rowsAll, idx, row: idx>=0 ? rowsAll[idx] : null };
    	}
    	
    	function refreshHistView(arr, rhythmDays){
    		const dates = (Array.isArray(arr)?arr:[])
    		.map(d => parseDate(d))
    		.filter(Boolean)
    		.sort((a,b)=>a-b);
    		histView.innerHTML = buildHistorySVG(dates, rhythmDays);
    	}
    	
    	function fill(row, id){
    		form.elements['__id'].value = id;
    		form.elements['Area'].value = row.Area || '';
    		form.elements['Task'].value = row.Task || '';
    		const notesEl = form.elements['Notes'] || document.getElementById('edit-inp-notes');
    		if (notesEl) notesEl.value = row.Notes || '';
    		form.elements['Rhythmen'].value = Number.isFinite(Number(row.Rhythmen)) ? Number(row.Rhythmen) : 0;
    		form.elements['RhythmUnit'].value = normalizeUnit(row.RhythmUnit || 'd');
    		
    		const mm = document.getElementById('edit-monthmask');
    		const grid = document.getElementById('edit-month-grid');
    		if (mm && grid) renderMonthGrid(grid, mm, normalizeMonthMask(row.MonthMask));
    		
    		const wm = document.getElementById('edit-weekmask');
    		const wgrid = document.getElementById('edit-week-grid');
    		if (wm && wgrid) renderWeekGrid(wgrid, wm, normalizeWeekMask(row.WeekMask));
    		
    		const a = row.EntityConnector || {};
    		
    		 // EntityConnector befÃ¼llen, falls aktiv
    		 const entityConnector = row.EntityConnector || {};
    		 form.elements['EntityConnectorEnabled'].checked = entityConnector.enabled 			|| false;
    		 form.elements['EntityConnectorEntity'].value 	= entityConnector.entity_id 		|| '';
    		 form.elements['EntityConnectorType'].value 	= entityConnector.type 				|| 'number';
    		 form.elements['EntityConnectorDueOp'].value 	= entityConnector.due_rule?.op 		|| '<=';
    		 form.elements['EntityConnectorDueVal'].value 	= entityConnector.due_rule?.value 	|| 0;
    		 form.elements['EntityConnectorDoneOp'].value 	= entityConnector.done_rule?.op 	|| '>';
    		 form.elements['EntityConnectorDoneVal'].value 	= entityConnector.done_rule?.value 	|| 0;

    		
    		form.elements['Icon'].value = row.Icon || '';
    		form.elements['Assignee'].value = String(row.Assignee || '').trim();
    		form.elements['Last'].value = row['Last done [Date]'] || '';
    		form.elements['Due'].value  = row['New Due date [date]'] || '';
    		const last = parseDate(row['Last done [Date]']);
    		const rde = last
    			? getRhythmDaysEffective(Number(row.Rhythmen||0), row.RhythmUnit, last)
    			: getRhythmDaysEffective(Number(row.Rhythmen||0), row.RhythmUnit, null);
    		
    		refreshHistView(row.__history||[], rde);
    		wireEntityConnectorAccordion(form, 'edit-EntityConnector-enabled', 'edit-EntityConnector-acc');
    		applyTranslations();
    	}
    	
    	window.openEditDialog = function(id){
    		const {row} = getRowById(id);
    		if (!row) return;
    		fill(row, id);
    		attachIconPicker(form.elements['Icon']);
    		dlg.showModal();
    	};
    	
    	function close(){
    		dlg.close();
    	}
    	
    	cancelBtn.addEventListener('click', close);
    	dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); close(); });
    	
    	// Save
		form.addEventListener('submit', (e)=>{
			e.preventDefault();
			const data = new FormData(form);
			const uidVal = form.elements['__id'].value;
			const {rowsAll, idx, row} = getRowById(uidVal);
			if (!row) return;
    		const assigneeVal = data.get('Assignee').toString().trim();
    		const notesVal = (data.get('Notes') || '').toString().trim();
    		
    		const updated = {
    			...row,
    			Area: (data.get('Area') || '').trim(),
    			Task: (data.get('Task') || '').trim(),
    			Assignee: assigneeVal,
    			Notes: notesVal,
    			Rhythmen: Number(data.get('Rhythmen') || 0),
    			RhythmUnit: normalizeUnit(data.get('RhythmUnit')),
    			MonthMask: normalizeMonthMask(data.get('MonthMask')),
    			WeekMask: normalizeWeekMask(data.get('WeekMask')),
    			Icon: (data.get('Icon') || '').trim(),
    			'Last done [Date]': data.get('Last') || '',
    			'Last done [By]': row['Last done [By]'] || '',
    			'New Due date [date]': data.get('Due') || '',
    			__history: Array.isArray(row.__history) ? row.__history : [],
    			__history_doneby: Array.isArray(row.__history_doneby) ? row.__history_doneby : []
    			
    		};
			if (data.get('EntityConnectorEnabled') ) {
				const type = (data.get('EntityConnectorType') || 'number').toString();
				const dueOp = (data.get('EntityConnectorDueOp') || '<=').toString();
				const dueVal = data.get('EntityConnectorDueVal');
				const doneOp = (data.get('EntityConnectorDoneOp') || '>').toString();
				const doneVal = data.get('EntityConnectorDoneVal');
				updated.EntityConnector = {
					enabled: true,
					entity_id: (data.get('EntityConnectorEntity') || '').toString().trim(),
					type,
					due_rule: {
						op: dueOp,
						value: dueVal || 0
					},
					done_rule: {
						op: doneOp,
						value: doneVal || 0
					}
				};
			} else {
				// Falls das KontrollkÃ¤stchen deaktiviert ist, kannst du entweder `EntityConnector` auf `null` setzen
				updated.EntityConnector = {
					enabled: false,
				}
			}
			
			const last = parseDate(updated['Last done [Date]']);
			const manual = updated['New Due date [date]'] ? parseDate(updated['New Due date [date]']) : null;
			
			let finalDue = null;
			
			if (manual) {
				finalDue = shiftToAllowedDate(manual, updated.MonthMask, updated.WeekMask);
			} else if (last) {
				const calcRaw = addByRhythm(last, updated.Rhythmen || 0, updated.RhythmUnit);
    			const calcDue = shiftToAllowedDate(calcRaw, updated.MonthMask, updated.WeekMask);
				finalDue = calcDue;
			} else {
				finalDue = manual; // wenn kein last da ist, bleibt manual
			}
			
			updated['New Due date [date]'] = finalDue ? toISO(finalDue) : '';
			
			const oldKey = makeId(rowsAll[idx]);
			const newKey = makeId(updated);
			const ov = getOverrides();
			if (oldKey !== newKey && ov[oldKey]) { ov[newKey] = { ...ov[oldKey] }; delete ov[oldKey]; }
			ov[newKey] = {
				...(ov[newKey]||{}),
				__uid: updated.__uid,
				Area: updated.Area,
				Task: updated.Task,
				Assignee: updated.Assignee,
				Notes: updated.Notes,
				Rhythmen: updated.Rhythmen,
				RhythmUnit: updated.RhythmUnit,
				MonthMask: updated.MonthMask,
				WeekMask: updated.WeekMask,
				Icon: updated.Icon,
				'Last done [Date]': updated['Last done [Date]'],
				'Last done [By]': updated['Last done [By]'],
				'New Due date [date]': updated['New Due date [date]'],
				EntityConnector: updated.EntityConnector,
				__history: updated.__history,
				__history_doneby: updated.__history_doneby
			};
			setOverrides(ov);
			rowsAll[idx] = updated;
			recompute(rowsAll[idx]);
			render();
			close();
			scheduleExport('edit');
		});
		
		// History add
		histAddBtn?.addEventListener('click', ()=>{
			const id = form.elements['__id'].value;
			const d = (histAddDate?.value||'').trim();
			if(!d){ alert(t('pickDate')); return; }
			const {row} = getRowById(id);
			if(!row) return;
			
			row.__history = uniqPreserveOrder(sortIsoAsc([...(row.__history||[]), d]));
			
			const ov = getOverrides();
			const key = makeId(row);
			ov[key] = {
				...(ov[key]||{}),
				__uid: row.__uid,
				Notes: typeof row.Notes === 'string' ? row.Notes : '',
				__history: row.__history
			};
			
			setOverrides(ov);
			refreshHistView(row.__history, row.Rhythmen);
			render();
			scheduleExport('hist-add');
		});
		
		// History clear
		clearHistBtn?.addEventListener('click', ()=>{
			const id = form.elements['__id'].value;
			const {row} = getRowById(id);
			if(!row) return;
			if(!confirm(t('confirmClearHist'))) return;
			
			row.__history = [];
			row.__history_doneby = [];
			const ov = getOverrides();
			const key = makeId(row);
			ov[key] = { ...(ov[key]||{}), __uid: row.__uid, __history: row.__history, __history_doneby: row.__history_doneby };
			
			setOverrides(ov);
			
			refreshHistView(row.__history, row.Rhythmen);
			render();
			scheduleExport('hist-clear');
		});
		
		// Delete (stabil Ã¼ber __uid)
		delBtn?.addEventListener('click', async ()=>{
			const id = form.elements['__id'].value;
			if (!confirm(t('confirmDelete'))) return;
			const {rowsAll, idx, row} = getRowById(id);
			if (!row || idx < 0) return;
			const uidToDelete = row.__uid;
			const keyNow = makeId(row);
			const ov = getOverrides();
			if (ov[keyNow]) delete ov[keyNow];
			for (const k of Object.keys(ov)) {
				if (ov[k] && ov[k].__uid === uidToDelete) delete ov[k];
			}
			setOverrides(ov);
			rowsAll.splice(idx, 1);
			
			try{
				const ADDED_KEY = 'pp-added';
				const added = JSON.parse(localStorage.getItem(ADDED_KEY) || '[]');
				const cleaned = Array.isArray(added) ? added.filter(r => r.__uid !== uidToDelete) : [];
				localStorage.setItem(ADDED_KEY, JSON.stringify(cleaned));
			} catch{}
			
			render();
			close();
			scheduleExport('delete');
		});
	}
	
	safeInit(initAddDialog);
	safeInit(initEditDialog);
	safeInit(initUserMgmt);
	window.ppRender();
	
	loadUserThemeCss();
	window.addEventListener('focus', loadUserThemeCss);

})();
</script>





<!-- Dialoge -->
<dialog id="add-task-dialog">
	<form id="add-task-form" method="dialog">
		<h3 class="dlg-title" id="add-dlg-title">Neue Aufgabe</h3>
		<div class="dlg-grid">
			
			<label>
				<span id="add-lbl-area">Bereich</span>
				<input name="Area" type="text" required placeholder="z. B. KÃ¼che" id="add-inp-area" />
			</label>
			<label>
				<span id="add-lbl-task">Task</span>
				<input name="Task" type="text" required placeholder="z. B. ArbeitsflÃ¤che wischen" id="add-inp-task" />
			</label>
			<label>
				<span id="add-lbl-assign">ZustÃ¤ndig</span>
				<input id="add-assign-input" name="Assignee" list="assign-hints" type="text" placeholder="z. B. Alex, parent, Familie" />
			</label>
			<label>
				<span id="add-lbl-notes">Notizen</span>
				<textarea name="Notes" id="add-inp-notes" placeholder="z. B. ðŸ§½ Mittel: Essigreiniger&#10;ðŸ“¦ Ersatzbeutel: Schrank links oben"></textarea>
			</label>
			<label>
				<span id="add-lbl-rhythm">Rhythmus</span>
				<div class="rhythm-row">
					<input name="Rhythmen" type="number" min="0" step="1" value="7" required />
					<select name="RhythmUnit">
						<option value="d" id="add-unit-d">Tage</option>
						<option value="w" id="add-unit-w">Wochen</option>
						<option value="m" id="add-unit-m">Monate</option>
					</select>
				</div>
			</label>
			<label>
				<span id="add-lbl-months">ZulÃ¤ssige Monate</span>
				<input type="hidden" name="MonthMask" id="add-monthmask" value="4095" />
				<div class="month-grid" id="add-month-grid"></div>
				<div class="month-hint" id="add-month-hint"> Markiert = erlaubt. Unmarkiert = wenn Due-Date in diesen Monat fÃ¤llt â†’ auf nÃ¤chsten erlaubten Tag verschieben. </div>
			</label>
			<label>
				<span id="add-lbl-weekdays">Feste Wochentage</span>
				<input type="hidden" name="WeekMask" id="add-weekmask" value="127" />
				<div class="week-grid" id="add-week-grid"></div>
				<div class="week-hint" id="add-week-hint"></div>
			</label>
			<label>
				<span id="add-lbl-icon">Icon (mdi:â€¦)</span>
				<input name="Icon" type="text" placeholder="z. B. mdi:spray-bottle" id="add-inp-icon" />
			</label>
			
			<label>
				<span id="add-lbl-last">Letztes Mal</span>
				<input name="Last" type="date" />
			</label>
			<label>
				<span id="add-lbl-due">NÃ¤chstes FÃ¤lligkeitsdatum (optional)</span>
				<input name="Due" type="date" />
			</label>
			
			<details class="EntityConnector-accordion" id="add-EntityConnector-acc">
				<summary>
					<span id="add-EntityConnector-title">EntityConnector</span>
					<label style="display:flex; gap:8px; align-items:center; font-weight:600;">
						<input type="checkbox" name="EntityConnectorEnabled" id="add-EntityConnector-enabled" />
						<span id="add-EntityConnector-enabled-lbl">aktiv</span>
					</label>
				</summary>
				<div class="EntityConnector-body">
					<label>
						<span id="add-EntityConnector-entity-lbl">Entity ID</span>
						<input name="EntityConnectorEntity" type="text" placeholder="z. B. sensor.plant_moisture" />
					</label>
					<label>
						<span id="add-EntityConnector-type-lbl">Typ</span>
						<select name="EntityConnectorType">
							<option value="number">number</option>
							<option value="text">text</option>
						</select>
					</label>

                <!-- Due Condition -->
					<div class="rhythm-row">
						<label>
							<span id="add-EntityConnector-due-lbl">Due</span>
							<select name="EntityConnectorDueOp">
								<option value="<=">&lt;=</option>
								<option value="<">&lt;</option>
								<option value=">=">&gt;=</option>
								<option value=">">&gt;</option>
								<option value="==">==</option>
								<option value="!=">!=</option>
							</select>
						</label>
						<label>
							<span id="add-EntityConnector-dueval-lbl">Wert</span>
							<input name="EntityConnectorDueVal" type="text" placeholder="25 oder dry" />
						</label>
					</div>
				<!-- Done Condition -->
					<div class="rhythm-row">
						<label>
							<span id="add-EntityConnector-done-lbl">Done</span>
							<select name="EntityConnectorDoneOp">
								<option value=">">&gt;</option>
								<option value=">=">&gt;=</option>
								<option value="<=">&lt;=</option>
								<option value="<">&lt;</option>
								<option value="==">==</option>
								<option value="!=">!=</option>
							</select>
						</label>
						<label>
							<span id="add-EntityConnector-doneval-lbl">Wert</span>
							<input name="EntityConnectorDoneVal" type="text" placeholder="35 oder wet" />
						</label>
					</div>
				</div>
			</details>
		</div>
		<div class="dlg-actions-right">
			<button type="button" id="add-task-cancel" class="btn">Abbrechen</button>
			<button type="submit" class="btn">
				<iconify-icon icon="mdi:content-save"></iconify-icon>
				<span id="add-btn-save">Speichern</span>
			</button>
		</div>
	</form>
</dialog>




<dialog id="edit-task-dialog">
	<form id="edit-task-form" method="dialog">
		<h3 class="dlg-title" id="edit-dlg-title">Aufgabe bearbeiten</h3>
		<input type="hidden" name="__id" />
		
		<div class="dlg-grid">
			<label>
				<span id="edit-lbl-area">Bereich</span>
				<input name="Area" type="text" required />
			</label>
			<label>
				<span id="edit-lbl-task">Task</span>
				<input name="Task" type="text" required />
			</label>
			<label>
				<span id="edit-lbl-assign">ZustÃ¤ndig</span>
				<input id="edit-assign-input" name="Assignee" list="assign-hints" type="text" placeholder="z. B. Alex, parent, Familie" />
			</label>
			<label>
				<span id="edit-lbl-notes">Notizen</span>
				<textarea name="Notes" id="edit-inp-notes"></textarea>
			</label>
			<label>
				<span id="edit-lbl-rhythm">Rhythmus</span>
				<div class="rhythm-row">
					<input name="Rhythmen" type="number" min="0" step="1" value="7" required />
					<select name="RhythmUnit">
						<option value="d" id="edit-unit-d">Tage</option>
						<option value="w" id="edit-unit-w">Wochen</option>
						<option value="m" id="edit-unit-m">Monate</option>
					</select>
				</div>
			</label>
			<label>
				<span id="edit-lbl-months">ZulÃ¤ssige Monate</span>
				<input type="hidden" name="MonthMask" id="edit-monthmask" value="4095" />
				<div class="month-grid" id="edit-month-grid"></div>
				<div class="month-hint" id="edit-month-hint"></div>
			</label>
			<label>
				<span id="edit-lbl-weekdays">Feste Wochentage</span>
				<input type="hidden" name="WeekMask" id="edit-weekmask" value="127" />
				<div class="week-grid" id="edit-week-grid"></div>
				<div class="week-hint" id="edit-week-hint"></div>
			</label>
			<label>
				<span id="edit-lbl-icon">Icon (mdi:â€¦)</span>
				<input name="Icon" type="text" />
			</label>
			<label>
				<span id="edit-lbl-last">Letztes Mal</span>
				<input name="Last" type="date" />
			</label>
			<label>
				<span id="edit-lbl-due">NÃ¤chstes FÃ¤lligkeitsdatum (optional)</span>
				<input name="Due" type="date" />
			</label>
		</div>
		
		<div id="edit-history-wrap" class="hist-wrap">
			<div class="hist-head">
                <strong id="edit-lbl-history">Historie</strong>
                <div class="dlg-actions-inline">
                    <input id="edit-history-date" type="date" />
                    <button type="button" id="edit-history-add" class="btn">
                        <iconify-icon icon="mdi:plus"></iconify-icon>
                        <span id="edit-btn-hist-add">HinzufÃ¼gen</span>
                    </button>
                    <button type="button" id="edit-history-clear" class="btn">
                        <iconify-icon icon="mdi:delete"></iconify-icon>
                        <span id="edit-btn-hist-clear">Leeren</span>
                    </button>
                </div>
            </div>
            <ol id="edit-history-view" class="hist-list"></ol>
        </div>

        <details class="EntityConnector-accordion" id="edit-EntityConnector-acc">
            <summary>
                <span id="edit-EntityConnector-title">EntityConnector</span>
                <label style="display:flex; gap:8px; align-items:center; font-weight:600;">
                    <input type="checkbox" name="EntityConnectorEnabled" id="edit-EntityConnector-enabled" />
                    <span id="edit-EntityConnector-enabled-lbl">aktiv</span>
                </label>
            </summary>
            <div class="EntityConnector-body">
                <label>
                    <span id="edit-EntityConnector-entity-lbl">Entity ID</span>
                    <input name="EntityConnectorEntity" type="text" placeholder="z. B. sensor.plant_moisture" />
                </label>
                <label>
                    <span id="edit-EntityConnector-type-lbl">Typ</span>
                    <select name="EntityConnectorType">
                        <option value="number">number</option>
                        <option value="text">text</option>
                    </select>
                </label>

                <!-- Due Condition -->
                <div class="rhythm-row">
                    <label>
                        <span id="edit-EntityConnector-due-lbl">Due</span>
                        <select name="EntityConnectorDueOp">
                            <option value="<=">&lt;=</option>
                            <option value="<">&lt;</option>
                            <option value=">=">&gt;=</option>
                            <option value=">">&gt;</option>
                            <option value="==">==</option>
                            <option value="!=">!=</option>
                        </select>
                    </label>
                    <label>
                        <span id="edit-EntityConnector-dueval-lbl">Wert</span>
                        <input name="EntityConnectorDueVal" type="text" placeholder="25 oder dry" />
                    </label>
                </div>

                <!-- Done Condition -->
                <div class="rhythm-row">
                    <label>
                        <span id="edit-EntityConnector-done-lbl">Done</span>
                        <select name="EntityConnectorDoneOp">
                            <option value=">">&gt;</option>
                            <option value=">=">&gt;=</option>
                            <option value="<=">&lt;=</option>
                            <option value="<">&lt;</option>
                            <option value="==">==</option>
                            <option value="!=">!=</option>
                        </select>
                    </label>
                    <label>
                        <span id="edit-EntityConnector-doneval-lbl">Wert</span>
                        <input name="EntityConnectorDoneVal" type="text" placeholder="35 oder wet" />
                    </label>
                </div>
            </div>
        </details>

        <div class="dlg-actions-between">
            <button type="button" id="edit-task-delete" class="btn">
                <iconify-icon icon="mdi:trash-can-outline"></iconify-icon>
                <span id="edit-btn-delete">LÃ¶schen</span>
            </button>
            <div class="dlg-actions-inline">
                <button type="button" id="edit-task-cancel" class="btn">
                    <span id="edit-btn-cancel">Abbrechen</span>
                </button>
                <button type="submit" class="btn">
                    <iconify-icon icon="mdi:content-save"></iconify-icon>
                    <span id="edit-btn-save">Speichern</span>
                </button>
            </div>
        </div>
    </form>
</dialog>


<datalist id="assign-hints"></datalist>

<dialog id="user-mgmt-dialog">
	<form id="user-mgmt-form">
		<h3 class="dlg-title" id="user-mgmt-title">Nutzermanagement</h3>
		<div class="user-tabs" role="tablist" aria-label="Nutzer und HA Zuordnung">
			<button type="button" id="user-tab-users" class="user-tab-btn active" role="tab" aria-selected="true">Nutzer</button>
			<button type="button" id="user-tab-mapping" class="user-tab-btn" role="tab" aria-selected="false">HA Zuordnung</button>
			<button type="button" id="user-tab-colors" class="user-tab-btn" role="tab" aria-selected="false">Farben</button>
		</div>

		<div class="user-panels">
			<div id="user-panel-users" class="user-tab-panel active" role="tabpanel">
				<div class="user-section">
					<h4 class="user-section-title" id="user-section-user-data">Nutzerdaten</h4>
					<div class="user-mgmt-grid">
						<label>
							<span id="user-name-label">Anzeigename</span>
							<input id="user-name" type="text" required />
						</label>
						<label>
							<span id="user-role-label">Rolle</span>
							<input id="user-role" type="text" />
						</label>
						<label>
							<span id="user-stars-label">Sterne</span>
							<input id="user-stars" type="number" min="0" step="1" value="0" />
						</label>
						<label>
							<span id="user-motto-label">Motivationsspruch</span>
							<input id="user-motto" type="text" />
						</label>
						<label>
							<span id="user-avatar-url-label">Avatar URL</span>
							<input id="user-avatar-url" type="text" placeholder="https://..." />
						</label>
					</div>
					<div class="user-avatar-preview" id="user-avatar-preview">
						<div class="user-avatar" aria-hidden="true">?</div>
						<span id="user-avatar-preview-label">Vorschau</span>
					</div>
				</div>

				<div class="user-section">
					<h4 class="user-section-title" id="user-section-existing-users">Bestehende Nutzer</h4>
					<div id="user-list" class="user-list"></div>
					<div id="user-list-empty" class="user-list-empty">â€” keine Nutzer â€”</div>
				</div>
			</div>

			<div id="user-panel-mapping" class="user-tab-panel" role="tabpanel">
				<div class="user-section">
					<h4 class="user-section-title" id="user-section-mapping-edit">HA Zuordnung bearbeiten</h4>
					<div class="user-mgmt-grid">
						<label>
							<span id="user-alias-ha-label">HA Nutzer</span>
							<input id="user-alias-ha" type="text" />
						</label>
						<label>
							<span id="user-alias-user-label">Zugeordneter Nutzer</span>
							<select id="user-alias-user"></select>
						</label>
						<label>
							<span id="user-alias-role-label">Rollenfilter (Gruppe)</span>
							<input id="user-alias-role" type="text" placeholder="Familie" />
						</label>
					</div>
					<div class="dlg-actions-inline" style="margin-top:8px">
						<button type="button" id="user-alias-save" class="btn">Zuordnung speichern</button>
						<button type="button" id="user-alias-clear" class="btn">Zuordnung lÃ¶schen</button>
					</div>
				</div>

				<div class="user-section">
					<h4 class="user-section-title" id="user-section-existing-mappings">Bestehende Zuordnungen</h4>
					<div id="user-alias-list" class="device-list"></div>
				</div>
			</div>

			<div id="user-panel-colors" class="user-tab-panel" role="tabpanel">
				<div class="user-section">
					<h4 class="user-section-title" id="user-section-colors">Color Management</h4>
					<div class="color-editor-toolbar">
						<button type="button" class="btn ce-active-user" id="ce-active-user-btn">
							<span id="ce-active-user-avatar" class="user-avatar" aria-hidden="true">?</span>
							<span id="ce-active-user-btn-label">Aktiver Nutzer: â€”</span>
						</button>
						<button type="button" class="btn" id="ce-export">
							<iconify-icon icon="mdi:download"></iconify-icon>
							Save Theme
						</button>
						<span class="muted" id="ce-status"></span>
					</div>
					<div class="color-editor-grid" id="ce-grid">
						<!-- rows injected by JS -->
					</div>
				</div>
			</div>
		</div>

		<div class="dlg-actions-between">
			<button type="button" id="user-mgmt-reset" class="btn">Leeren</button>
			<div class="dlg-actions-inline">
				<button type="button" id="user-mgmt-close" class="btn">SchlieÃŸen</button>
				<button type="button" id="user-mgmt-save" class="btn">
					<iconify-icon icon="mdi:content-save"></iconify-icon>
					<span id="user-mgmt-save-label">Speichern</span>
				</button>
			</div>
		</div>
	</form>
</dialog>


<script>
    /** --------------- Icon-Liste laden --------------- **/
    let ICON_POOL = null;

    async function loadIconPool(){
      if(ICON_POOL) return ICON_POOL;

      try{
        const url = new URL(window.BASE_PATH + "mdi-icons.json", getHaOrigin()).toString();
        const res = await fetch(url, { cache:'no-store' });
        if(res.ok){
          const arr = await res.json();
          if(Array.isArray(arr) && arr.length){
            ICON_POOL = arr.filter(s=>typeof s==='string');
            return ICON_POOL;
          }
        }
      }catch(_){ }

      const used = new Set(
        (Array.isArray(window.TABLE_DATA)?window.TABLE_DATA:[])
          .map(r => (r.Icon||'').trim())
          .filter(Boolean)
      );

      const seed = [
        'mdi:check','mdi:calendar-check','mdi:clock-outline','mdi:alert-circle-outline','mdi:information-outline',
        'mdi:spray-bottle','mdi:broom','mdi:vacuum','mdi:washing-machine','mdi:bucket','mdi:mop','mdi:toilet-brush',
        'mdi:duster','mdi:soap','mdi:hand-wash','mdi:towel','mdi:squeegee',
        'mdi:toilet','mdi:shower','mdi:bathtub-outline','mdi:mirror-variant','mdi:toothbrush-paste','mdi:sink','mdi:faucet',
        'mdi:fridge','mdi:stove','mdi:microwave','mdi:kettle-outline','mdi:knife','mdi:silverware-clean','mdi:dishwasher',
        'mdi:tshirt-crew','mdi:hanger','mdi:iron','mdi:laundry-basket','mdi:clothes-dryer',
        'mdi:sofa','mdi:armchair','mdi:television','mdi:floor-lamp','mdi:bookshelf','mdi:window-closed','mdi:curtains',
        'mdi:home','mdi:bed','mdi:door-closed','mdi:garage','mdi:stairs','mdi:balcony','mdi:ceiling-light','mdi:lightbulb',
        'mdi:trash-can','mdi:trash-can-outline','mdi:toolbox-outline','mdi:hammer-wrench','mdi:clipboard-check-outline',
        'mdi:grass','mdi:tree','mdi:watering-can-outline','mdi:leaf','mdi:lawn-mower','mdi:shovel','mdi:wheelbarrow',
        'mdi:paw','mdi:dog','mdi:cat',
        'mdi:clipboard-edit-outline','mdi:calendar-range','mdi:calendar-today','mdi:check-circle-outline','mdi:playlist-check'
      ];

      ICON_POOL = [...new Set([...used, ...seed])];
      return ICON_POOL;
    }

    
    function attachIconPicker(input){
      if (input.__pickerAttached) return;
      input.__pickerAttached = true;

      const wrap = document.createElement('div');
      wrap.className = 'icon-picker-wrap';
      input.parentNode.insertBefore(wrap, input);
      wrap.appendChild(input);

      const preview = document.createElement('div');
      preview.className = 'icon-preview';
      preview.innerHTML = `<iconify-icon icon="${(input.value||'mdi:check')}"></iconify-icon>`;
      wrap.appendChild(preview);

      const dd = document.createElement('div');
      dd.className = 'icon-dd';
      const tt = typeof window.ppT === 'function' ? window.ppT : (k)=>k;
      const iconSearchPh = tt('iconSearchPh');
      const iconListAria = tt('iconListAria');
      dd.innerHTML = `
        <input class="search" type="text" placeholder="${iconSearchPh}" />
        <div class="icon-list" role="listbox" aria-label="${iconListAria}"></div>
      `;
      wrap.appendChild(dd);

      preview.addEventListener('click', ()=> dd.classList.toggle('open') );
      document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) dd.classList.remove('open'); });

      function updatePreview(){
        const v = (input.value||'').trim() || 'mdi:check';
        preview.innerHTML = `<iconify-icon icon="${v}"></iconify-icon>`;
      }
      input.addEventListener('input', updatePreview);
      updatePreview();

      let pool = [];
      const search = dd.querySelector('.search');
      const list  = dd.querySelector('.icon-list');

      function renderList(items){
        list.innerHTML = '';
        items.slice(0, 300).forEach(name=>{
          const el = document.createElement('div');
          el.className = 'icon-item';
          el.innerHTML = `
            <iconify-icon icon="${name}"></iconify-icon>
            <span class="icon-name">${name}</span>
          `;
          el.addEventListener('click', ()=>{
            input.value = name;
            updatePreview();
            dd.classList.remove('open');
            input.dispatchEvent(new Event('change', {bubbles:true}));
          });
          list.appendChild(el);
        });
      }

      function filter(q){
        q = (q||'').trim().toLowerCase();
        if(!q){ renderList(pool); return; }
        const starts = [], contains = [];
        for(const n of pool){
          const s = n.toLowerCase();
          if(s.startsWith(q)) starts.push(n);
          else if(s.includes(q)) contains.push(n);
        }
        renderList([...starts, ...contains]);
      }

      loadIconPool().then(arr=>{ pool = arr; renderList(pool); });

      search.addEventListener('input', ()=> filter(search.value) );

      input.addEventListener('focus', ()=>{
        dd.classList.add('open');
        if(search.value !== input.value){ search.value = input.value; filter(search.value); }
        search.focus({preventScroll:true});
      });
      input.addEventListener('input', ()=>{
        if(!dd.classList.contains('open')) dd.classList.add('open');
        search.value = input.value;
        filter(search.value);
      });
    }
</script>


<script>
(function() {
  function getHass() {
    try {
      return (
        window.hass ||
        window.parent?.document?.querySelector('home-assistant')?.hass ||
        window.top?.document?.querySelector('home-assistant')?.hass ||
        null
      );
    } catch(_) {
      return null;
    }
  }

  function getCurrentHaUser() {
    const hass = getHass();
    const u = hass?.user || hass?.connection?.user || null;
    if (!u) return null;

    const name = u.name || u.display_name || null;
    return { id: u.id || null, name };
  }

  function slugifyFileKey(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '')
      .slice(0, 48) || 'default';
  }

  function getUserThemeKey() {
    const active = window.PP_ACTIVE_USER;
    if (active?.name) return slugifyFileKey(active.name);
    const u = getCurrentHaUser();
    return u?.name ? slugifyFileKey(u.name) : (u?.id ? slugifyFileKey(u.id) : 'default');
  }

  function loadThemeCss() {
    const key = getUserThemeKey();
    const link = document.getElementById('pp-theme-css') || document.createElement('link');
    link.id = 'pp-theme-css';
    link.rel = 'stylesheet';
    link.href = new URL(window.BASE_PATH + `usersettings/theme.${key}.css`, getHaOrigin()).toString() + '?v=' + Date.now();
    document.head.appendChild(link);
  }

  // Funktionen fÃ¼r den Color Editor
  const grid     = document.getElementById('ce-grid');
  const activeUserAvatar = document.getElementById('ce-active-user-avatar');
  const activeUserBtnLabel = document.getElementById('ce-active-user-btn-label');
  const btnExport= document.getElementById('ce-export');
  const statusEl = document.getElementById('ce-status');

  if (!grid) return;

  const EDIT_VARS = [
    { name: '--bg-site', label: 'Website Background' },
    { name: '--icon-bg', label: 'Task Icon Background' },
    { name: '--accentcolor', label: 'Accent / Hover' },
    { name: '--todaycolor', label: 'Calendar: Today highlight' },
    { name: '--overdue-notecolor', label: 'Calendar: Overdue note' },
    { name: '--border-color', label: 'Bordercolor Cards' },
    { name: '--border-color-alt', label: 'Bordercolor Pill (Area/Rhythm)' },
    { name: '--taskstatus-overdue', label: 'Taskcard Sidecolor: Overdue' },
    { name: '--taskstatus-due', label: 'Taskcard Sidecolor: Due-soon / Warning' },
    { name: '--taskstatus-done', label: 'Taskcard Sidecolor: done/OK' },
    { name: '--taskstatus-unknown', label: 'Taskcard Background: Entity Not Found' },
    { name: '--taskstatus-notavaiable', label: 'Taskcard Background: Bad State' },
    { name: '--taskcard-bg', label: 'Taskcard Background: Color 1 (Gradually Grading Top-Color)' },
    { name: '--taskcard-bg-2', label: 'Taskcard Background: Color 2 (Gradually Grading Bottom-Color)' },
    { name: '--taskcard-textcolor', label: 'Taskcard Textcolor for Title/Icon' },
    { name: '--taskcard-textdecent', label: 'Taskcard Textcolor for Muted Text' },
  ];

  const STORE_KEY = 'pp-theme-vars-v1';

  function getVar(scopeEl, name) {
    return getComputedStyle(scopeEl).getPropertyValue(name).trim() || '';
  }

  function setVarOn(el, name, value) {
    el.style.setProperty(name, value);
  }

  const lightStyleTagId = 'pp-light-overrides';
  function ensureLightStyleTag() {
    let tag = document.getElementById(lightStyleTagId);
    if (!tag) {
      tag = document.createElement('style');
      tag.id = lightStyleTagId;
      document.head.appendChild(tag);
    }
    return tag;
  }

  function buildLightCss(vars) {
    const lines = Object.entries(vars)
      .filter(([k, v]) => !!v)
      .map(([k, v]) => `  ${k}: ${v};`);
    return `html[data-theme="light"]{\n${lines.join('\n')}\n}\n` +
           `@media (prefers-color-scheme: light){\n  html[data-theme="system"]{\n${lines.map(l => '  ' + l.trim()).join('\n')}\n  }\n}\n`;
  }

  function buildRootCss(vars) {
    const lines = Object.entries(vars)
      .filter(([k, v]) => !!v)
      .map(([k, v]) => `  ${k}: ${v};`);
    return `:root{\n${lines.join('\n')}\n}\n`;
  }

  function buildLightCssFull(vars) {
    const lines = EDIT_VARS.map(v => `  ${v.name}: ${vars[v.name] || '#000000'};`);
    return `html[data-theme="light"]{\n${lines.join('\n')}\n}\n` +
           `@media (prefers-color-scheme: light){\n  html[data-theme="system"]{\n${lines.map(l => '  ' + l.trim()).join('\n')}\n  }\n}\n`;
  }

  function buildRootCssFull(vars) {
    const lines = EDIT_VARS.map(v => `  ${v.name}: ${vars[v.name] || '#000000'};`);
    return `:root{\n${lines.join('\n')}\n}\n`;
  }

  function setStatus(msg) {
    if (!statusEl) return;
    statusEl.textContent = msg || '';
    if (msg) {
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(() => statusEl.textContent = '', 2500);
    }
  }

  function getInitial(name){
    const s = String(name || '').trim();
    return s ? s[0].toUpperCase() : '?';
  }

  function updateActiveUserButton(){
    if (!activeUserBtnLabel) return;
    const active = window.PP_ACTIVE_USER;
    const fallback = getCurrentHaUser();
    const name = active?.name || fallback?.name || fallback?.id || 'â€”';
    const tt = typeof window.ppT === 'function' ? window.ppT : (k)=>k;
    activeUserBtnLabel.textContent = `${tt('activeUserPrefix')}: ${name}`;
    if (activeUserAvatar) {
      activeUserAvatar.innerHTML = '';
      if (active?.avatar) {
        const img = document.createElement('img');
        img.src = active.avatar;
        img.alt = '';
        activeUserAvatar.appendChild(img);
      } else {
        activeUserAvatar.textContent = getInitial(name);
      }
    }
  }

  function clampHex(v) {
    v = (v || '').trim();
    if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)) return v;
    return '';
  }

  function loadState() {
    try {
      const raw = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
      return {
        root: raw.root || {},
        light: raw.light || {}
      };
    } catch {
      return { root: {}, light: {} };
    }
  }

  function saveState(state) {
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }

  function applyState(state) {
    for (const [k, v] of Object.entries(state.root || {})) {
      if (v) setVarOn(document.documentElement, k, v);
    }
    const tag = ensureLightStyleTag();
    tag.textContent = buildLightCss(state.light || {});
  }

  function getModeValues(mode) {
    const root = document.documentElement;
    const hadAttr = root.hasAttribute('data-theme');
    const prevMode = root.getAttribute('data-theme');
    root.setAttribute('data-theme', mode);
    const values = {};
    for (const v of EDIT_VARS) {
      values[v.name] = clampHex(getVar(root, v.name)) || '';
    }
    if (hadAttr) root.setAttribute('data-theme', prevMode);
    else root.removeAttribute('data-theme');
    return values;
  }

  function getCompleteThemeValues(state) {
    const darkActive = getModeValues('dark');
    const lightActive = getModeValues('light');
    const root = {};
    const light = {};
    for (const v of EDIT_VARS) {
      root[v.name] = clampHex(state.root?.[v.name]) || darkActive[v.name] || '#000000';
      light[v.name] = clampHex(state.light?.[v.name]) || lightActive[v.name] || root[v.name] || '#000000';
    }
    return { root, light };
  }

  function buildGrid(state) {
    const complete = getCompleteThemeValues(state);
    grid.innerHTML = `
      <div class="hdr">Name</div>
      <div class="hdr">Light mode</div>
      <div class="hdr">Dark mode</div>
      <div class="hdr">Preview</div>
    `;
    EDIT_VARS.forEach(v => {
      const row = document.createElement('div');
      row.className = 'ce-row';
      row.style.display = 'contents';

      const nameEl = document.createElement('div');
      nameEl.className = 'ce-name';
      nameEl.textContent = v.label;

      const lightWrap = document.createElement('div');
      lightWrap.className = 'ce-color';

      const lightColor = document.createElement('input');
      lightColor.type = 'color';

      const lightText = document.createElement('input');
      lightText.type = 'text';
      lightText.placeholder = '#RRGGBB';

      const darkWrap = document.createElement('div');
      darkWrap.className = 'ce-color';

      const darkColor = document.createElement('input');
      darkColor.type = 'color';

      const darkText = document.createElement('input');
      darkText.type = 'text';
      darkText.placeholder = '#RRGGBB';

      const sw = document.createElement('div');
      sw.className = 'ce-swatch';

      const initDark = clampHex(state.root?.[v.name]) || complete.root[v.name] || '';
      const initLight = clampHex(state.light?.[v.name]) || complete.light[v.name] || '';

      function setPickerPair(picker, text, val) {
        const c = clampHex(val) || '#000000';
        picker.value = c;
        text.value = c;
      }

      setPickerPair(darkColor, darkText, initDark);
      setPickerPair(lightColor, lightText, initLight);

      sw.style.background = clampHex(getVar(document.documentElement, v.name)) || initDark || 'transparent';

      function sync(which, val) {
        val = clampHex(val);
        if (which === 'dark') {
          state.root[v.name] = val || '';
          if (val) setVarOn(document.documentElement, v.name, val);
          else document.documentElement.style.removeProperty(v.name);
        } else {
          state.light[v.name] = val || '';
          ensureLightStyleTag().textContent = buildLightCss(state.light);
        }
        saveState(state);
        sw.style.background = clampHex(getVar(document.documentElement, v.name)) || val || 'transparent';
      }

      lightColor.addEventListener('input', () => { lightText.value = lightColor.value; sync('light', lightColor.value); });
      lightText.addEventListener('input', () => { const v2 = clampHex(lightText.value); if (v2) { lightColor.value = v2; sync('light', v2); } });

      darkColor.addEventListener('input', () => { darkText.value = darkColor.value; sync('dark', darkColor.value); });
      darkText.addEventListener('input', () => { const v2 = clampHex(darkText.value); if (v2) { darkColor.value = v2; sync('dark', v2); } });

      lightWrap.appendChild(lightColor);
      lightWrap.appendChild(lightText);

      darkWrap.appendChild(darkColor);
      darkWrap.appendChild(darkText);

      grid.appendChild(nameEl);
      grid.appendChild(lightWrap);
      grid.appendChild(darkWrap);
      grid.appendChild(sw);
    });
  }

  // Event Listeners fÃ¼r den Color Editor

  btnExport.addEventListener('click', async () => {
    const state = loadState();
    const full = getCompleteThemeValues(state);
    const css = [
      '/* Putztplan theme overrides (generated) */',
      buildRootCssFull(full.root || {}),
      buildLightCssFull(full.light || {})
    ].join('\n');

    const blob = new Blob([css], { type: 'text/css' });
    const key = getUserThemeKey();
    await downloadFileCompat(blob, `usersettings/theme.${key}.css`);
  });

  // Apply saved state on startup
  const stateAtStart = loadState();
  applyState(stateAtStart);
  buildGrid(stateAtStart);
  updateActiveUserButton();
  window.PP_UPDATE_COLOR_EDITOR_CONTEXT = function(){
    updateActiveUserButton();
    loadThemeCss();
  };
  loadThemeCss();
})();
</script>


</body>
</html>
