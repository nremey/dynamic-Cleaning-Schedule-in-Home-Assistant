<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Putzplan</title>
  <!-- Iconify -->
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js" defer></script>
  <style>
    :root{
      --bg: #0b0d10;
      --panel: #12161c;
      --panel-2: #171c23;
      --text: #e6ebf1;
      --muted: #aab2bf;
      --red: #ef4444; --yellow: #f59e0b; --green: #22c55e; --blue: #3b82f6;
      --card-radius: 16px; --shadow: 0 6px 30px rgba(0,0,0,.25);
      --border: #1f2631; --border-alt:#2a3341; --chip-bg:#12161c;
    }
    html[data-theme="light"]{
      --bg: #f5f7fb; --panel:#ffffff; --panel-2:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --border-alt:#cbd5e1; --shadow:0 8px 28px rgba(15,23,42,.08); --chip-bg:#f8fafc;
    }
    @media (prefers-color-scheme: light){
      html[data-theme="system"]{ --bg: #f5f7fb; --panel:#ffffff; --panel-2:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --border-alt:#cbd5e1; --shadow:0 8px 28px rgba(15,23,42,.08); --chip-bg:#f8fafc; }
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background: var(--bg); color: var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .title{display:flex;gap:12px;align-items:center}
    .title iconify-icon{font-size:28px}
    h1{font-size:clamp(22px,2.2vw,28px);margin:0;font-weight:700}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center}
    .chip select, .chip input[type="text"]{background:transparent;border:none;outline:none;color:var(--text)}
    .chip input::placeholder{color:var(--muted)}
    .btn{background:var(--panel-2);border:1px solid var(--border);border-radius:999px;padding:8px 14px;display:flex;gap:8px;align-items:center;cursor:pointer;font-weight:600;color:var(--text);transition:background .2s, color .2s, border-color .2s}
    .btn:hover{background:var(--blue);border-color:var(--blue);color:#fff}
    .area{margin-top:24px;border-top:1px solid var(--border)}
    .area-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 4px;position:sticky;top:0;background:var(--bg);z-index:5}
    .area-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .area-title{font-size:18px;font-weight:700;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--border-alt);border-radius:999px;padding:2px 8px}
    .chev{transition:transform .2s ease}
    .collapsed .chev{transform:rotate(-90deg)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .grid.is-collapsed{display:none}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--border);
      border-radius:var(--card-radius);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:8px;
      position:relative;
      overflow:hidden
    }
    .card .top{display:flex;gap:10px;align-items:center}
    .icn{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:var(--bg);border:1px solid var(--border);cursor:pointer;position:relative}
    .icn:hover{box-shadow:0 0 0 2px var(--blue) inset}
    .icn.pulse{animation:pulse .8s ease}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    .icn iconify-icon{font-size:22px}
    .task{font-weight:700}
    .meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .pill{font-size:12px;color:var(--muted);border:1px dashed var(--border-alt);border-radius:999px;padding:2px 8px}
    .row{display:flex;justify-content:space-between;gap:8px;font-size:13px;color:var(--muted)}
    .row b{color:var(--text)}
    .due{font-variant-numeric:tabular-nums}
    .overdue{color:var(--red);font-weight:700}
    .due-soon{color:var(--yellow);font-weight:600}
    .ok{color:var(--green);font-weight:600}
    .accent{position:absolute;left:0;top:0;bottom:0;width:4px}
    .imp-red{background:var(--red)}
    .imp-yellow{background:var(--yellow)}
    .imp-green{background:var(--green)}
    .imp-orange{background:orange}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    dialog::backdrop{ background: rgba(0,0,0,.45); }
    dialog{ border:1px solid var(--border); border-radius:16px; padding:16px; background:var(--panel); color:var(--text); box-shadow: var(--shadow); }
    dialog input, dialog select{ width:100%; box-sizing:border-box; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); }
    dialog label{ display:grid; gap:6px; font-size:13px; color:var(--muted); }
    .card .edit-btn{
      position:absolute; right:10px; top:10px;
      border:1px solid var(--border); background:var(--panel-2);
      border-radius:10px; padding:6px; display:grid; place-items:center;
      cursor:pointer; opacity:.85; transition:opacity .15s, background .2s, border-color .2s;
    }
    .card .edit-btn:hover{ opacity:1; background:var(--blue); border-color:var(--blue); color:#fff; }

    /* Icon-Picker */
.icon-picker-wrap{ position:relative; display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center; }
.icon-preview{ width:36px; height:36px; display:grid; place-items:center; border:1px solid var(--border); border-radius:10px; background:var(--panel-2); }
.icon-dd{ position:absolute; z-index:50; top:100%; left:0; right:0; margin-top:6px;
  border:1px solid var(--border); border-radius:12px; background:var(--panel); box-shadow:var(--shadow); padding:8px; display:none; }
.icon-dd.open{ display:block; }
.icon-dd .search{ width:100%; padding:8px; border:1px solid var(--border); border-radius:8px; background:var(--panel-2); color:var(--text); }
.icon-list{ margin-top:8px; max-height:260px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:6px; }
.icon-item{ display:flex; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); border-radius:10px; background:var(--panel-2); cursor:pointer; }
.icon-item:hover{ border-color:var(--blue); }
.icon-name{ font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <iconify-icon icon="mdi:broom"></iconify-icon>
        <h1>Cleaning Schedule</h1>
      </div>
      <div class="controls">
        <label class="chip">time range:
          <select id="range-select"></select>
        </label>
        <label class="chip">sort:
          <select id="sort-select">
            <option value="due">Due date (soon → late)</option>
            <option value="alpha">Alphabetical (Task)</option>
          </select>
        </label>
        <label class="chip" style="min-width:220px">
          <iconify-icon icon="mdi:magnify"></iconify-icon>
          <input id="search-input" type="text" placeholder="Search tasks/areas…" />
        </label>
        <button id="theme-btn" class="btn" title="Toggle light/dark">
          <iconify-icon id="theme-icn" icon="mdi:weather-night"></iconify-icon><span id="theme-label">Dark</span>
        </button>
        <button id="export-btn" class="btn sr-only" title="Export updated table as .js">
          <iconify-icon icon="mdi:download"></iconify-icon><span>Export (.js)</span>
        </button>
        <button id="add-task-btn" class="btn" title="create new task">
          <iconify-icon icon="mdi:plus-circle"></iconify-icon><span>new Task</span>
        </button>
        <button id="ha-test" class="btn sr-only" title="Webhook-Test">Webhook Test</button>
      </div>
    </header>

    <div id="app"></div>
  </div>

  <script>
    // BEGIN DATEN – nutzt vorhandenes window.TABLE_DATA, falls schon gesetzt
    if(!window.TABLE_DATA){ window.TABLE_DATA = []; }
    // END DATEN
  </script>

  <!-- Daten-Script mit fixer ID für Cache-Bust -->
  <script id="data-js" src="/local/myownstuff/Putzplan/data.updated.js"></script>

  <script>
    // feste HA-URL (nur falls Seite nicht über /local geladen wird)
    window.HA_ORIGIN = 'http://192.168.178.38:8123';
    function getHaOrigin(){
      return (window.top && window.top.location && /^https?:/.test(window.top.location.origin))
        ? window.top.location.origin
        : (typeof window.HA_ORIGIN === 'string' ? window.HA_ORIGIN : window.location.origin);
    }
    // Cache-Buster neu laden (konsolidiert)
    function reloadUpdatedScript(){
      const s = document.getElementById('data-js');
      if (!s) return;
      const abs = `${getHaOrigin()}/local/myownstuff/Putzplan/data.updated.js`;
      s.src = abs + '?v=' + Date.now();
    }
    // Einzige callWebhook-Implementierung (konsolidiert)
    async function callWebhook(payload) {
      const webhookUrl = `${getHaOrigin()}/api/webhook/putzplan_export`;
      const res = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      console.log('Webhook response:', res.status, text);
      if (!res.ok) throw new Error(`Webhook ${res.status} – ${text}`);
      return text || 'OK';
    }
  </script>

  <script>
    // ===== Konfiguration =====
    const CONFIG = {
      colorByDue: true,
      ranges: [
        { key:'overdue', label:'overdue',          test: d => Number.isFinite(d) && d < 1 },
        { key:'next3',   label:'next 3 days',      test: d => Number.isFinite(d) && d <= 3 },
        { key:'next5',   label:'next 5 days',      test: d => Number.isFinite(d) && d <= 5 },
        { key:'next7',   label:'next week',       test: d => Number.isFinite(d) && d <= 7 },
        { key:'next14',  label:'next 2 weeks',    test: d => Number.isFinite(d) && d <= 14 },
        { key:'all',     label:'all',                test: _ => true }
      ]
    };

    (function(){
      // ===== DOM-Refs =====
      const app         = document.getElementById('app');
      const rangeSelect = document.getElementById('range-select');
      const sortSelect  = document.getElementById('sort-select');
      const searchInput = document.getElementById('search-input');
      const themeBtn    = document.getElementById('theme-btn');
      const themeIcn    = document.getElementById('theme-icn');
      const themeLabel  = document.getElementById('theme-label');
      const exportBtn   = document.getElementById('export-btn');
      const btnTest     = document.getElementById('ha-test');

      // ===== Utils =====
      const parseDate = (str) => str ? new Date(str + 'T00:00:00') : null;
      const toISO     = (d)=> d ? d.toISOString().slice(0,10) : '';
      const addDays   = (d, n)=>{ const x = new Date(d); x.setDate(x.getDate()+Number(n||0)); return x; };
      const today     = ()=>{ const t=new Date(); return new Date(t.getFullYear(), t.getMonth(), t.getDate()); };
      const diffInDays= (a,b)=> Math.round((a - b) / 86400000);
      const fmtDate   = (str) => { const d = parseDate(str); if(!d) return '—'; return new Intl.DateTimeFormat(['en-GB', 'en-US','de-DE'],{ year:'numeric', month:'2-digit', day:'2-digit'}).format(d); };
      const cssId     = (s)=> String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const prefersLight = () => window.matchMedia('(prefers-color-scheme: light)').matches;

      // ===== Theming =====
      const THEME_KEY = 'pp-theme';
      function setTheme(mode) {
        document.documentElement.setAttribute('data-theme', mode);
        if (mode === 'dark')      { themeIcn.setAttribute('icon', 'mdi:weather-night');     themeLabel.textContent = 'Dark'; }
        else if (mode === 'light'){ themeIcn.setAttribute('icon', 'mdi:white-balance-sunny'); themeLabel.textContent = 'Light'; }
        else                      { themeIcn.setAttribute('icon', 'mdi:monitor');            themeLabel.textContent = 'System'; }
      }
      function nextMode(curr) { return curr === 'dark' ? 'light' : curr === 'light' ? 'system' : 'dark'; }
      let themeMode = localStorage.getItem(THEME_KEY) || 'system';
      setTheme(themeMode);
      themeBtn.addEventListener('click', () => {
        themeMode = nextMode(themeMode);
        localStorage.setItem(THEME_KEY, themeMode);
        setTheme(themeMode);
      });
      const mql = window.matchMedia('(prefers-color-scheme: light)');
      mql.addEventListener?.('change', () => { if (themeMode === 'system') setTheme('system'); });

      // ===== Storage / Overrides =====
      const STORAGE_KEY = 'pp-overrides';
      const getOverrides = ()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch{ return {}; } };
      const setOverrides = (obj)=> localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));

      // ⚠️ makeId nur für Overrides verwenden (nicht mehr für Identität)
      const makeId = (r)=> [r.Area, r.Task].map(v=>String(v||'').toLowerCase().replace(/[^a-z0-9]+/g,'-')).join('__');

      // ===== Stabile UIDs je Zeile =====
      let __uidSeed = Date.now();
      const uid = () => (__uidSeed++).toString(36);
      (function ensureUids(){
        if (!Array.isArray(window.TABLE_DATA)) return;
        for (const r of window.TABLE_DATA) {
          if (!r.__uid) r.__uid = uid();
        }
      })();

      // ===== Datenberechnung =====
      function recompute(item){
        const last   = parseDate(item['Last done [Date]']);
        const manual = item['New Due date [date]'] ? parseDate(item['New Due date [date]']) : null;
        let nextDue = null;
        if (manual) nextDue = manual;
        else if (last && Number.isFinite(item.Rhythmen)) {
          nextDue = addDays(last, Number(item.Rhythmen || 0));
          item['New Due date [date]'] = toISO(nextDue);
        }
        const now = today();
        const dueIn = nextDue ? diffInDays(nextDue, now) : null;
        item['Due in [days]'] = Number.isFinite(dueIn) ? dueIn : null;
        return item;
      }

      function applyOverrides(rows){
        const ov = getOverrides();
        rows.forEach(r=>{
          const key = makeId(r);
          if(ov[key]) Object.assign(r, ov[key]);
          recompute(r);
        });
        return rows;
      }

      // ===== UI Hilfen =====
      const COLLAPSE_PREFIX = 'pp-collapse-';
      const getCollapsed = area => localStorage.getItem(COLLAPSE_PREFIX+area) === '1';
      const setCollapsed = (area, v) => localStorage.setItem(COLLAPSE_PREFIX+area, v?'1':'0');

      function groupByArea(rows){
        const map = new Map();
        rows.forEach(r=>{ const area = r.Area || 'No area'; if(!map.has(area)) map.set(area, []); map.get(area).push(r); });
        return map;
      }
      function importanceClass(importance){
        const v = String(importance||'').toLowerCase();
        if(v.includes('red')) return 'imp-red'; if(v.includes('yellow')) return 'imp-yellow'; if(v.includes('green')) return 'imp-green'; return '';
      }
      function dueClass(dueDays){
        if(dueDays == null || isNaN(dueDays)) return ''; if(dueDays < 0) return 'overdue'; if(dueDays <= 7) return 'due-soon'; return 'ok';
      }
      function accentClassFromDue(dueDays, rhythm) {
        if (!Number.isFinite(dueDays) || !Number.isFinite(rhythm) || rhythm <= 0) return '';
        if (dueDays < 0) return 'imp-red';
        const ratio = dueDays / rhythm;
        if (ratio >= 0.6) return 'imp-green';
        if (ratio > 0.2)  return 'imp-yellow';
        return 'imp-orange';
      }
      function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }

      // ===== Export-Helfer: Klick simulieren (debounced) =====
      let __exportTimer = null;
      function scheduleExport(reason='change'){
        clearTimeout(__exportTimer);
        __exportTimer = setTimeout(()=>{
          console.log('[Auto-Export]', reason);
          // exakt den Klick auf den Button simulieren:
          exportBtn.click();
        }, 400);
      }

      // ===== Selects initialisieren =====
      (function initRangeOptions(){
        const ranges = CONFIG.ranges.map(r => `<option value="${r.key}">${r.label}</option>`).join('');
        rangeSelect.innerHTML = ranges;
        rangeSelect.value = 'all';
      })();

      // ===== Export Button =====
      exportBtn.addEventListener('click', async () => {
        console.log("Export Button clicked");
        try {
          const base = Array.isArray(window.TABLE_DATA) ? JSON.parse(JSON.stringify(window.TABLE_DATA)) : [];
          const rows = applyOverrides(base).map(r => recompute(r));
          const jsContent = 'window.TABLE_DATA = ' + JSON.stringify(rows, null, 2) + ';\n';
          const content_b64 = btoa(unescape(encodeURIComponent(jsContent)));

          console.log('content_b64 length:', content_b64.length);

          await callWebhook({ filename: 'data.updated.js', content_b64 });
          reloadUpdatedScript();
        } catch (e) {
          alert('error while writing : ' + e.message);
        }
      });

      // zusätzlicher Exporter (bleibt verfügbar, wird hier aber nicht direkt genutzt)
      async function exportDataToHomeAssistant() {
        try {
          const base = Array.isArray(window.TABLE_DATA) ? JSON.parse(JSON.stringify(window.TABLE_DATA)) : [];
          const rows = applyOverrides(base).map(r => recompute(r));
          const jsContent = 'window.TABLE_DATA = ' + JSON.stringify(rows, null, 2) + ';\n';
          const content_b64 = btoa(unescape(encodeURIComponent(jsContent)));
          await callWebhook({ filename: 'data.updated.js', content_b64 });
          reloadUpdatedScript();
          alert('Export nach Home Assistant erfolgreich!');
        } catch (e) {
          alert('Export nach Home Assistant fehlgeschlagen: ' + e.message);
        }
      }

      // Webhook-Test-Button
      btnTest.addEventListener('click', async () => {
        try{
          const dummy = 'window.TABLE_DATA = []; // TEST\n';
          const content_b64 = btoa(unescape(encodeURIComponent(dummy)));
          await callWebhook({ filename: 'data.updated.js', content_b64 });
          reloadUpdatedScript();
        }catch(e){
          alert('Webhook-Test fehlgeschlagen: 1234 ' + e.message);
        }
      });

      // ===== Render =====
      function render(){
        const sortMode = sortSelect.value;
        const q = searchInput.value.trim().toLowerCase();
        const rangeKey = rangeSelect.value;
        const rangeDef = CONFIG.ranges.find(r => r.key === rangeKey) || CONFIG.ranges[0];

        let rows = Array.isArray(window.TABLE_DATA) ? [...window.TABLE_DATA] : [];
        rows = applyOverrides(rows);

        rows = rows.filter(r => {
          const d = Number(r['Due in [days]']);
          return rangeDef.test(d);
        });

        if(q){
          rows = rows.filter(r => String(r.Task||'').toLowerCase().includes(q) || String(r.Area||'').toLowerCase().includes(q));
        }

        const sorters = {
          due:   (a,b)=> (Number(a['Due in [days]']) ?? 0) - (Number(b['Due in [days]']) ?? 0),
          alpha: (a,b)=> String(a.Task||'').localeCompare(String(b.Task||''), 'de')
        };

        const byArea = groupByArea(rows);
        const areas = [...byArea.keys()].sort((a,b)=>a.localeCompare(b,'de'));

        const frag = document.createDocumentFragment();

        areas.forEach(area=>{
          const section = document.createElement('section');
          section.className = 'area';

          const isCollapsed = getCollapsed(area);

          const header = document.createElement('div');
          header.className = 'area-header' + (isCollapsed ? ' collapsed' : '');
          const countShown = byArea.get(area).length;
          header.innerHTML = `
            <div class="area-toggle" role="button" aria-expanded="${!isCollapsed}" aria-controls="grid-${cssId(area)}">
              <iconify-icon class="chev" icon="mdi:chevron-down"></iconify-icon>
              <div class="area-title"><iconify-icon icon="mdi:home-floor-l"></iconify-icon>${escapeHtml(area)}</div>
              <span class="badge" title="Number of items">${countShown} items</span>
            </div>`;
          section.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'grid' + (isCollapsed ? ' is-collapsed' : '');
          grid.id = `grid-${cssId(area)}`;

          const items = [...byArea.get(area)].sort(sorters[sortMode]);

          items.forEach(item=>{
            const card = document.createElement('article');
            card.className = 'card';

            const dueDays = Number(item['Due in [days]']);
            const rhythm  = Number(item.Rhythmen);
            const imp = CONFIG.colorByDue ? accentClassFromDue(dueDays, rhythm) : importanceClass(item['Importance (colorScale)']);
            const dueCls = dueClass(dueDays);
            const icon = (item.Icon && String(item.Icon).trim()) ? String(item.Icon).trim() : 'mdi:check';
            const id = item.__uid; // stabile UID

            card.innerHTML = `
              <span class="accent ${imp}" aria-hidden="true"></span>

              <button class="edit-btn" type="button" title="edit task" data-id="${id}">
                <iconify-icon icon="mdi:pencil"></iconify-icon>
              </button>

              <div class="top">
                <div class="icn" data-id="${id}" title="Mark as done (sets 'Last time' to today)">
                  <iconify-icon icon="${icon}"></iconify-icon>
                </div>
                <div>
                  <div class="task">${escapeHtml(item.Task || '—')}</div>
                  <div class="meta">
                    <span class="pill">Frequency: ${Number.isFinite(rhythm) ? rhythm : '—'} Tage</span>
                  </div>
                </div>
              </div>

              <div class="row"><span>Last time</span><b>${fmtDate(item['Last done [Date]'])}</b></div>
              <div class="row"><span>next due date</span><b>${fmtDate(item['New Due date [date]'])}</b></div>
              <div class="row due ${dueCls}">
                <span>due in</span>
                <b>${Number.isFinite(dueDays) ? (dueDays===0? 'today' : (dueDays>0? `${dueDays} days` : `${Math.abs(dueDays)} days overdue`)) : '—'}</b>
              </div>
            `;

            // Klick: erledigt → heute setzen  + Auto-Export
            const icn = card.querySelector('.icn');
            icn.addEventListener('click', ()=>{
              icn.classList.add('pulse'); setTimeout(()=>icn.classList.remove('pulse'), 800);
              const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
              const idx = rowsAll.findIndex(r=> r.__uid === id);
              if(idx >= 0){
                const r = rowsAll[idx];
                const now = today();
                r['Last done [Date]'] = toISO(now);
                const due = addDays(now, r.Rhythmen||0);
                r['New Due date [date]'] = toISO(due);
                r['Due in [days]'] = diffInDays(due, now);

                // Override updaten
                const ov = getOverrides();
                const key = makeId(r);
                ov[key] = {
                  ...(ov[key]||{}),
                  'Last done [Date]': r['Last done [Date]'],
                  'New Due date [date]': r['New Due date [date]'],
                  'Due in [days]': r['Due in [days]']
                };
                setOverrides(ov);

                render();
                // >>> Auto-Export (simulate click)
                scheduleExport('mark-done');
              }
            });

            grid.appendChild(card);
          });

          section.appendChild(grid);
          frag.appendChild(section);

          // Toggle Handling (auf Header) – kein Export nötig
          header.querySelector('.area-toggle').addEventListener('click',()=>{
            const collapsed = grid.classList.toggle('is-collapsed');
            header.classList.toggle('collapsed', collapsed);
            header.querySelector('.area-toggle').setAttribute('aria-expanded', String(!collapsed));
            setCollapsed(area, collapsed);
          });
        });

        app.replaceChildren(frag);
      }

      // ===== Event-Delegation für Edit-Buttons (einmal global) =====
      app.addEventListener('click', (e) => {
        const btn = e.target.closest('button.edit-btn');
        if (!btn) return;
        const id = btn.dataset.id;
        openEditDialog?.(id);
      });

      // ===== Filter/Sort Suche =====
      rangeSelect.addEventListener('change', render);
      sortSelect.addEventListener('change', render);
      searchInput.addEventListener('input', render);

      // ===== Bereits hinzugefügte (temp) laden =====
      (function restoreAdded(){
        try{
          const ADDED_KEY = 'pp-added';
          const added = JSON.parse(localStorage.getItem(ADDED_KEY) || '[]');
          if (Array.isArray(added) && added.length) {
            if (!Array.isArray(window.TABLE_DATA)) window.TABLE_DATA = [];
            for (const r of added){ if (!r.__uid) r.__uid = uid(); }
            window.TABLE_DATA.push(...added);
          }
        }catch{}
      })();

      // ===== Dialoge =====
      function initAddDialog(){
        const addBtn    = document.getElementById('add-task-btn');
        const dlg       = document.getElementById('add-task-dialog');
        const form      = document.getElementById('add-task-form');
        const cancelBtn = document.getElementById('add-task-cancel');
        if (!addBtn || !dlg || !form || !cancelBtn) return;

        function openAddDialog(){
          form.reset();
          const t = today();
          const iso = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
          form.elements['Last'].value = iso;
          dlg.showModal();
          attachIconPicker(form.elements['Icon']);
        }
        function closeAddDialog(){ dlg.close(); }

        addBtn.addEventListener('click', openAddDialog);
        cancelBtn.addEventListener('click', closeAddDialog);
        dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); closeAddDialog(); });

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const data = new FormData(form);
          const row = {
            __uid: uid(),
            Area:      (data.get('Area')||'').trim(),
            Task:      (data.get('Task')||'').trim(),
            Rhythmen:  Number(data.get('Rhythmen')||0),
            Icon:      (data.get('Icon')||'').trim(),
            'Last done [Date]': data.get('Last') || '',
            'New Due date [date]': data.get('Due') || '',
            'Importance (colorScale)': (data.get('Importance')||'').trim(),
            'Due in [days]': null
          };

          if (!Array.isArray(window.TABLE_DATA)) window.TABLE_DATA = [];
          window.TABLE_DATA.push(row);
          recompute(row);
          render();

          try{
            const ADDED_KEY = 'pp-added';
            const added = JSON.parse(localStorage.getItem(ADDED_KEY)||'[]');
            added.push(row);
            localStorage.setItem(ADDED_KEY, JSON.stringify(added));
          }catch{}

          // >>> Auto-Export (simulate click)
          scheduleExport('add');
          closeAddDialog();
        });
      }

      function initEditDialog(){
        const dlg   = document.getElementById('edit-task-dialog');
        const form  = document.getElementById('edit-task-form');
        const cancelBtn = document.getElementById('edit-task-cancel');
        const delBtn    = document.getElementById('edit-task-delete');
        if (!dlg || !form || !cancelBtn) return;

        function fill(form, row, id){
          form.elements['__id'].value = id;
          form.elements['Area'].value = row.Area || '';
          form.elements['Task'].value = row.Task || '';
          form.elements['Rhythmen'].value = Number.isFinite(Number(row.Rhythmen)) ? Number(row.Rhythmen) : 0;
          form.elements['Icon'].value = row.Icon || '';
          form.elements['Last'].value = row['Last done [Date]'] || '';
          form.elements['Due'].value  = row['New Due date [date]'] || '';
          form.elements['Importance'].value = row['Importance (colorScale)'] || '';
        }

        // global zugänglich innerhalb IIFE-Scope
        window.openEditDialog = function(id){
          const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
          const idx = rowsAll.findIndex(r => r.__uid === id);
          if (idx < 0) return;
          const row = rowsAll[idx];
          fill(form, row, id);
          if(!form.elements['Icon'].__pickerAttached){
                 attachIconPicker(form.elements['Icon']);
                    form.elements['Icon'].__pickerAttached = true;
            }
          dlg.showModal();

        };

        function close(){ dlg.close(); }
        cancelBtn.addEventListener('click', close);
        dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); close(); });

        // Speichern + Auto-Export
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const data = new FormData(form);
          const uidVal = form.elements['__id'].value;

          const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
          const idx = rowsAll.findIndex(r => r.__uid === uidVal);
          if (idx < 0) return;

          const updated = {
            ...rowsAll[idx],
            Area: (data.get('Area')||'').trim(),
            Task: (data.get('Task')||'').trim(),
            Rhythmen: Number(data.get('Rhythmen')||0),
            Icon: (data.get('Icon')||'').trim(),
            'Last done [Date]': data.get('Last') || '',
            'New Due date [date]': data.get('Due') || '',
            'Importance (colorScale)': (data.get('Importance')||'').trim()
          };

          // Overrides-Key (aus Feldern)
          const oldKey = makeId(rowsAll[idx]);
          const newKey = makeId(updated);
          const ov = getOverrides();
          if (oldKey !== newKey && ov[oldKey]) { ov[newKey] = { ...ov[oldKey] }; delete ov[oldKey]; }
          ov[newKey] = {
            ...(ov[newKey]||{}),
            Area: updated.Area,
            Task: updated.Task,
            Rhythmen: updated.Rhythmen,
            Icon: updated.Icon,
            'Last done [Date]': updated['Last done [Date]'],
            'New Due date [date]': updated['New Due date [date]']
          };
          setOverrides(ov);

          rowsAll[idx] = updated;
          recompute(rowsAll[idx]);
          render();
          close();

          // >>> Auto-Export (simulate click)
          scheduleExport('edit');
        });

        // Löschen – strikt nach UID genau eine Zeile + Auto-Export
        delBtn?.addEventListener('click', ()=>{
          const id = form.elements['__id'].value;
          if (!confirm('Diese Aufgabe wirklich löschen?')) return;

          const rowsAll = Array.isArray(window.TABLE_DATA) ? window.TABLE_DATA : [];
          const idx = rowsAll.findIndex(r => r.__uid === id);
          if (idx >= 0) {
            const ov = getOverrides();
            const key = makeId(rowsAll[idx]);
            if (ov[key]) { delete ov[key]; setOverrides(ov); }
            rowsAll.splice(idx, 1);
          }
          render();
          close();

          // >>> Auto-Export (simulate click)
          scheduleExport('delete');
        });
      }

      // ===== Init =====
      function safeInit(fn){
        if (document.readyState === 'loading') {
          window.addEventListener('DOMContentLoaded', fn, { once:true });
        } else {
          fn();
        }
      }

      // Render einmal initial
      render();

      // Dialoge sicher initialisieren
      safeInit(initAddDialog);
      safeInit(initEditDialog);

    })();




/** --------------- Icon-Liste laden --------------- **/
let ICON_POOL = null;

// optional: eigene Liste unter /local/.../mdi-icons.json (Array aus Strings)
async function loadIconPool(){
  if(ICON_POOL) return ICON_POOL;

  // 1) Versuche: lokale JSON-Liste
  try{
    const url = `${getHaOrigin()}/local/myownstuff/Putzplan/mdi-icons.json`;
    const res = await fetch(url, { cache:'no-store' });
    if(res.ok){
      const arr = await res.json();
      if(Array.isArray(arr) && arr.length){
        ICON_POOL = arr.filter(s=>typeof s==='string');
        return ICON_POOL;
      }
    }
  }catch(_){}

  // 2) Fallback: Icons aus vorhandenen Daten + ein paar Basics
  const used = new Set(
    (Array.isArray(window.TABLE_DATA)?window.TABLE_DATA:[])
      .map(r => (r.Icon||'').trim())
      .filter(Boolean)
  );
  const seed = [
    'mdi:check','mdi:spray-bottle','mdi:broom','mdi:vacuum','mdi:washing-machine',
    'mdi:toilet','mdi:shower','mdi:window-closed','mdi:fridge','mdi:stove'
  ];
  ICON_POOL = [...new Set([...used, ...seed])];
  return ICON_POOL;
}


/** --------------- Icon-Picker an ein Input hängen --------------- **/
function attachIconPicker(input){
  // Wrapper + Preview + Dropdown bauen
  const wrap = document.createElement('div');
  wrap.className = 'icon-picker-wrap';
  input.parentNode.insertBefore(wrap, input);
  wrap.appendChild(input);

  const preview = document.createElement('div');
  preview.className = 'icon-preview';
  preview.innerHTML = `<iconify-icon icon="${(input.value||'mdi:check')}"></iconify-icon>`;
  wrap.appendChild(preview);

  const dd = document.createElement('div');
  dd.className = 'icon-dd';
  dd.innerHTML = `
    <input class="search" type="text" placeholder="Icon suchen (z. B. 'mdi:toilet' oder 'toil')" />
    <div class="icon-list" role="listbox" aria-label="Iconliste"></div>
  `;
  wrap.appendChild(dd);

  // Öffnen/Schließen durch Klick auf Preview
  preview.addEventListener('click', ()=> dd.classList.toggle('open') );
  document.addEventListener('click', (e)=>{
    if(!wrap.contains(e.target)) dd.classList.remove('open');
  });

  // Vorschau live updaten
  function updatePreview(){
    const v = (input.value||'').trim() || 'mdi:check';
    preview.innerHTML = `<iconify-icon icon="${v}"></iconify-icon>`;
  }
  input.addEventListener('input', updatePreview);
  updatePreview();

  // Liste rendern + Filtern
  let pool = [];
  let lastQuery = '';
  const search = dd.querySelector('.search');
  const list  = dd.querySelector('.icon-list');

  function renderList(items){
    list.innerHTML = '';
    items.slice(0, 300).forEach(name=>{
      const el = document.createElement('div');
      el.className = 'icon-item';
      el.innerHTML = `
        <iconify-icon icon="${name}"></iconify-icon>
        <span class="icon-name">${name}</span>
      `;
      el.addEventListener('click', ()=>{
        input.value = name;
        updatePreview();
        dd.classList.remove('open');
        input.dispatchEvent(new Event('change', {bubbles:true}));
      });
      list.appendChild(el);
    });
  }

  function filter(q){
    q = (q||'').trim().toLowerCase();
    if(!q){ renderList(pool); return; }
    // „HA-like“: Teilstring & Wortanfang bevorzugen
    const starts = [], contains = [];
    for(const n of pool){
      const s = n.toLowerCase();
      if(s.startsWith(q)) starts.push(n);
      else if(s.includes(q)) contains.push(n);
    }
    renderList([...starts, ...contains]);
  }

  // initial laden
  loadIconPool().then(arr=>{ pool = arr; renderList(pool); });

  // Suche
  search.addEventListener('input', ()=> filter(search.value) );

  // Tippkomfort: Tippt der User direkt im Feld, zeig Dropdown + filtere auf seinen Wert
  input.addEventListener('focus', ()=>{
    dd.classList.add('open');
    if(search.value !== input.value){ search.value = input.value; filter(search.value); }
    search.focus({preventScroll:true});
  });
  input.addEventListener('input', ()=>{
    if(!dd.classList.contains('open')) dd.classList.add('open');
    search.value = input.value;
    filter(search.value);
  });
}
</script>

  <!-- Dialoge -->
  <dialog id="add-task-dialog">
    <form id="add-task-form" method="dialog" style="min-width: 320px">
      <h3 style="margin:0 0 12px;font-size:18px">new task</h3>
      <div style="display:grid;gap:10px">
        <label>Area<input name="Area" type="text" required placeholder="e.g. kitchen" /></label>
        <label>Task<input name="Task" type="text" required placeholder="e.g. vaccum" /></label>
        <label>Frequency (days)<input name="Rhythmen" type="number" min="0" step="1" value="7" required /></label>
        <label>Icon (mdi:…)<input name="Icon" type="text" placeholder="z. B. mdi:spray-bottle" /></label>
        <label>Last time<input name="Last" type="date" /></label>
        <label>Next due date (optional)<input name="Due" type="date" /></label>
        <label>Importance (colorScale)
          <select name="Importance">
            <option value="">—</option><option>red</option><option>yellow</option><option>green</option>
          </select>
        </label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
        <button type="button" id="add-task-cancel" class="btn">Cancel</button>
        <button type="submit" class="btn"><iconify-icon icon="mdi:content-save"></iconify-icon> add task</button>
      </div>
    </form>
  </dialog>

  <dialog id="edit-task-dialog">
    <form id="edit-task-form" method="dialog" style="min-width: 340px">
      <h3 style="margin:0 0 12px;font-size:18px">edit task</h3>
      <input type="hidden" name="__id" />
      <div style="display:grid;gap:10px">
        <label>Area<input name="Area" type="text" required /></label>
        <label>Task <input name="Task" type="text" required /></label>
        <label>Frequency (days)<input name="Rhythmen" type="number" min="0" step="1" required /></label>
        <label>Icon (mdi:…) <input name="Icon" type="text" /></label>
        <label>Last time<input name="Last" type="date" /></label>
        <label>Next due date (optional)<input name="Due" type="date" /></label>
        <label>Importance (colorScale)
          <select name="Importance">
            <option value="">—</option><option>red</option><option>yellow</option><option>green</option>
          </select>
        </label>
      </div>
      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:14px">
        <button type="button" id="edit-task-delete" class="btn"><iconify-icon icon="mdi:trash-can-outline"></iconify-icon>erase task</button>
        <div style="display:flex;gap:8px">
          <button type="button" id="edit-task-cancel" class="btn">Cancel</button>
          <button type="submit" class="btn"><iconify-icon icon="mdi:content-save"></iconify-icon>save changes</button>
        </div>
      </div>
    </form>
  </dialog>
</body>
</html>
